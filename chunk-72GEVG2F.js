import{a as he,b as ue,c as v}from"./chunk-T7SAAP6X.js";import{a as oe,b,i as le}from"./chunk-YOK3D5MP.js";import{$b as re,G as ie,Ha as A,I as q,Qa as T,a as w,b as Z,bc as ne,cc as ae,f as $,hb as d,kb as C,o as O,pc as S,q as ee,s as te,x as se}from"./chunk-6YFIEOLQ.js";import{u as M}from"./chunk-X3B7ZQOC.js";import{B as _,C as V,F as I,H as Y,Z as y,g as j,o as x,x as E,z as X}from"./chunk-O23OEJHM.js";var F=class extends T{constructor(e){e=e||{};let t=Object.assign({},e),s=e.cacheSize;delete e.cacheSize,delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=s,this.setPreload(e.preload!==void 0?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0)}getCacheSize(){return this.cacheSize_}getPreload(){return this.get(b.PRELOAD)}setPreload(e){this.set(b.PRELOAD,e)}getUseInterimTilesOnError(){return this.get(b.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(e){this.set(b.USE_INTERIM_TILES_ON_ERROR,e)}getData(e){return super.getData(e)}},ce=F;var N=class extends ce{constructor(e){super(e)}createRenderer(){return new oe(this,{cacheSize:this.getCacheSize()})}},de=N;var z=class extends T{constructor(e){e=e||{},super(e)}},me=z;var P=class extends me{constructor(e){super(e)}createRenderer(){return new ue(this)}getData(e){return super.getData(e)}},ge=P;var W=class extends C{constructor(e,t,s,i,r,n,o){let h=e.getExtent();h&&e.canWrapX()&&(h=h.slice(),h[0]=-1/0,h[2]=1/0);let u=t.getExtent();u&&t.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);let g=u?V(s,u):s,m=E(g),l=re(e,t,m,i),f=.5,c=new ae(e,t,g,h,l*f,i),p=c.calculateSourceExtent(),L=Y(p)?null:n(p,l,r),Ie=L?d.IDLE:d.EMPTY,J=L?L.getPixelRatio():1;super(s,i,J,Ie),this.targetProj_=t,this.maxSourceExtent_=h,this.triangulation_=c,this.targetResolution_=i,this.targetExtent_=s,this.sourceImage_=L,this.sourcePixelRatio_=J,this.interpolate_=o,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==d.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){let e=this.sourceImage_.getState();if(e==d.LOADED){let t=I(this.targetExtent_)/this.targetResolution_,s=_(this.targetExtent_)/this.targetResolution_;this.canvas_=ne(t,s,this.sourcePixelRatio_,v(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==d.IDLE){this.state=d.LOADING,this.changed();let e=this.sourceImage_.getState();e==d.LOADED||e==d.ERROR?this.reproject_():(this.sourceListenerKey_=ee(this.sourceImage_,w.CHANGE,t=>{let s=this.sourceImage_.getState();(s==d.LOADED||s==d.ERROR)&&(this.unlistenSource_(),this.reproject_())}),this.sourceImage_.load())}}unlistenSource_(){te(this.sourceListenerKey_),this.sourceListenerKey_=null}},fe=W;var H={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"},G=class extends O{constructor(e,t){super(e),this.image=t}},B=class extends S{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){let t=this.getResolutions();if(t){let s=$(t,e,0);e=t[s]}return e}getImage(e,t,s,i){let r=this.getProjection();if(!r||!i||M(r,i))return r&&(i=r),this.getImageInternal(e,t,s,i);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&M(this.reprojectedImage_.getProjection(),i)&&this.reprojectedImage_.getResolution()==t&&x(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new fe(r,i,e,t,s,(n,o,h)=>this.getImageInternal(n,o,h,r),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,s,i){if(this.loader){let r=Re(e,t,s,1),n=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===i&&(this.wantedExtent_&&j(this.wantedExtent_,r)||j(this.image.getExtent(),r))&&(this.wantedResolution_&&v(this.wantedResolution_)===n||v(this.image.getResolution())===n)))return this.image;this.wantedProjection_=i,this.wantedExtent_=r,this.wantedResolution_=n,this.image=new C(r,n,s,this.loader),this.image.addEventListener(w.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){let t=e.target,s;switch(t.getState()){case d.LOADING:this.loading=!0,s=H.IMAGELOADSTART;break;case d.LOADED:this.loading=!1,s=H.IMAGELOADEND;break;case d.ERROR:this.loading=!1,s=H.IMAGELOADERROR;break;default:return}this.hasListener(s)&&this.dispatchEvent(new G(s,t))}};function rt(a,e){a.getImage().src=e}function Re(a,e,t,s){let i=e/t,r=E(a),n=y(I(a)/i,4),o=y(_(a)/i,4),h=y((s-1)*n/2,4),u=n+2*h,g=y((s-1)*o/2,4),m=o+2*g;return X(r,i,0,[u,m])}var Q=B;function _e(a){return function(e){let t=e.buffers,s=e.meta,i=e.imageOps,r=e.width,n=e.height,o=t.length,h=t[0].byteLength;if(i){let l=new Array(o);for(let c=0;c<o;++c)l[c]=new ImageData(new Uint8ClampedArray(t[c]),r,n);return a(l,s).data.buffer}let u=new Uint8ClampedArray(h),g=new Array(o),m=new Array(o);for(let l=0;l<o;++l)g[l]=new Uint8ClampedArray(t[l]),m[l]=[0,0,0,0];for(let l=0;l<h;l+=4){for(let c=0;c<o;++c){let p=g[c];m[c][0]=p[l],m[c][1]=p[l+1],m[c][2]=p[l+2],m[c][3]=p[l+3]}let f=a(m,s);u[l]=f[0],u[l+1]=f[1],u[l+2]=f[2],u[l+3]=f[3]}return u.buffer}}function Ee(a,e){let s=Object.keys(a.lib||{}).map(function(r){return"const "+r+" = "+a.lib[r].toString()+";"}).concat(["const __minion__ = ("+_e.toString()+")(",a.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(s.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(s,{type:"text/javascript"})));return i.addEventListener("message",e),i}function we(a,e){let t=_e(a.operation),s=!1;return{postMessage:function(i){setTimeout(function(){s||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){s=!0}}}var K=class extends Z{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;let s=new Array(t);if(t)for(let i=0;i<t;++i)s[i]=Ee(e,this.onWorkerMessage_.bind(this,i));else s[0]=we(e,this.onWorkerMessage_.bind(this,0));this.workers_=s,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,s){this.enqueue_({inputs:e,meta:t,callback:s}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;let e=this.queue_.shift();this.job_=e;let t=e.inputs[0].width,s=e.inputs[0].height,i=e.inputs.map(function(h){return h.data.buffer}),r=this.workers_.length;if(this.running_=r,r===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:s},i);return}let n=e.inputs[0].data.length,o=4*Math.ceil(n/4/r);for(let h=0;h<r;++h){let u=h*o,g=[];for(let m=0,l=i.length;m<l;++m)g.push(i[m].slice(u,u+o));this.workers_[h].postMessage({buffers:g,meta:e.meta,imageOps:this.imageOps_,width:t,height:s},g)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){let e=this.job_,t=this.workers_.length,s,i;if(t===1)s=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{let r=e.inputs[0].data.length;s=new Uint8ClampedArray(r),i=new Array(t);let n=4*Math.ceil(r/4/t);for(let o=0;o<t;++o){let h=this.dataLookup_[o].buffer,u=o*n;s.set(new Uint8ClampedArray(h),u),i[o]=this.dataLookup_[o].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(s,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}},pe={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"},D=class extends O{constructor(e,t,s){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=s}},k=class extends Q{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=be(e.sources);let t=this.changed.bind(this);for(let s=0,i=this.layers_.length;s<i;++s)this.layers_[s].addEventListener(w.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new ie(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:q(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:ye(this.layers_),pixelRatio:1,pixelToCoordinateTransform:q(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:se(this),renderTargets:{}},this.setAttributions(function(s){let i=[];for(let r=0,n=e.sources.length;r<n;++r){let o=e.sources[r],h=o instanceof S?o:o.getSource();if(!h)continue;let u=h.getAttributions()?.(s);typeof u=="string"?i.push(u):u!==void 0&&i.push(...u)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new K({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,s){let i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);let r=E(e);i.size[0]=Math.ceil(I(e)/t),i.size[1]=Math.ceil(_(e)/t),i.extent=[r[0]-i.size[0]*t/2,r[1]-i.size[1]*t/2,r[0]+i.size[0]*t/2,r[1]+i.size[1]*t/2],i.time=Date.now();let n=i.viewState;return n.center=r,n.projection=s,n.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let s=0,i=this.layers_.length;s<i;++s)if(t=this.layers_[s].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,s,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);let r=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=r,this.renderedImageCanvas_){let n=this.renderedImageCanvas_.getResolution(),o=this.renderedImageCanvas_.getExtent();(t!==n||!x(r.extent,o))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),r.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){let e=this.requestedFrameState_,t=this.layers_.length,s=new Array(t);for(let r=0;r<t;++r){e.layerIndex=r,e.renderTargets={};let n=xe(this.layers_[r],e);if(n)s[r]=n;else return}let i={};this.dispatchEvent(new D(pe.BEFOREOPERATIONS,e,i)),this.processor_.process(s,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,s,i){if(t||!s)return;let r=e.extent,n=e.viewState.resolution;if(n!==this.requestedFrameState_.viewState.resolution||!x(r,this.requestedFrameState_.extent))return;let o;if(this.renderedImageCanvas_)o=this.renderedImageCanvas_.getImage().getContext("2d");else{let h=Math.round(I(r)/n),u=Math.round(_(r)/n);o=A(h,u),this.renderedImageCanvas_=new he(r,n,1,o.canvas)}o.putImageData(s,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new D(pe.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let s=0,i=this.layers_.length;s<i&&(t=this.layers_[s].getSource().getResolutions(e),!t);++s);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}};k.prototype.dispose;var R=null;function xe(a,e){let t=a.getRenderer();if(!t)throw new Error("Unsupported layer type: "+a);if(!t.prepareFrame(e))return null;let s=e.size[0],i=e.size[1];if(s===0||i===0)return null;let r=t.renderFrame(e,null),n;if(r instanceof HTMLCanvasElement)n=r;else{if(r&&(n=r.firstElementChild),!(n instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+n);if(n.width===s&&n.height===i)return n.getContext("2d").getImageData(0,0,s,i)}if(!R)R=A(s,i,void 0,{willReadFrequently:!0});else{let o=R.canvas;o.width!==s||o.height!==i?R=A(s,i,void 0,{willReadFrequently:!0}):R.clearRect(0,0,s,i)}return R.drawImage(n,0,0,s,i),R.getImageData(0,0,s,i)}function ye(a){return a.map(function(e){return e.getLayerState()})}function be(a){let e=a.length,t=new Array(e);for(let s=0;s<e;++s)t[s]=ve(a[s]);return t}function ve(a){let e;return a instanceof S?a instanceof le?e=new de({source:a}):a instanceof Q&&(e=new ge({source:a})):e=a,e}var Et=k;export{ce as a,de as b,ge as c,rt as d,Re as e,Q as f,Et as g};
