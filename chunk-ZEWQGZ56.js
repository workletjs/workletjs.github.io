import{a as S,b as $,c as tt,d as et}from"./chunk-L2KDRRDU.js";import{b as Q}from"./chunk-NN27DWXC.js";import{c as Z}from"./chunk-6NH2SAGR.js";import{a as u,b as L,c as y,d as Y,e as z,f as J}from"./chunk-CZY6VY76.js";import{$a as H,C as b,D as c,La as F,Na as j,Oa as q,a as I,aa as x,db as C,fb as W,ib as B,k as A,kb as D,kc as K,l as U,nb as X,q as V,wa as p}from"./chunk-BTDYMGX4.js";import{C as f,z as m}from"./chunk-XVBTN5DM.js";import{D as O,E as N,b as P,ka as w,la as v,v as T,w as G}from"./chunk-WEL5MCWD.js";var k={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"},g=class extends V{constructor(t,e){super(t),this.feature=e}},M=class extends X{constructor(t){let e=t;e.stopDown||(e.stopDown=U),super(e),this.on,this.once,this.un,this.options_=t,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=t.source?t.source:null,this.features_=t.features?t.features:null,this.snapTolerance_=t.snapTolerance?t.snapTolerance:12,this.type_=t.type,this.mode_=ot(this.type_),this.stopClick_=!!t.stopClick,this.ignoreNextUpEvent_=!1,this.minPoints_=t.minPoints?t.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:t.maxPoints?t.maxPoints:1/0,this.finishCondition_=t.finishCondition?t.finishCondition:A,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY";let i=t.geometryFunction;if(!i){let o=this.mode_;if(o==="Circle")i=(n,s,r)=>{let h=s||new L([NaN,NaN]),d=f(n[0],r),_=w(d,f(n[n.length-1],r));h.setCenterAndRadius(d,Math.sqrt(_),this.geometryLayout_);let l=m();return l&&h.transform(r,l),h};else{let n;o==="Point"?n=p:o==="LineString"?n=y:o==="Polygon"&&(n=F),i=(s,r,h)=>(r?o==="Polygon"?s[0].length?r.setCoordinates([s[0].concat([s[0][0]])],this.geometryLayout_):r.setCoordinates([],this.geometryLayout_):r.setCoordinates(s,this.geometryLayout_):r=new n(s,this.geometryLayout_),r)}}this.geometryFunction_=i,this.dragVertexDelay_=t.dragVertexDelay!==void 0?t.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=t.clickTolerance?t.clickTolerance*t.clickTolerance:36,this.overlay_=new Q({source:new Z({useSpatialIndex:!1,wrapX:t.wrapX?t.wrapX:!1}),style:t.style?t.style:st(),updateWhileInteracting:!0}),this.geometryName_=t.geometryName,this.condition_=t.condition?t.condition:B,this.freehandCondition_,t.freehand?this.freehandCondition_=C:this.freehandCondition_=t.freehandCondition?t.freehandCondition:D,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSource_=t.traceSource||t.source||null,this.addChangeListener(H.ACTIVE,this.updateState_)}setTrace(t){let e;t?t===!0?e=C:e=t:e=W,this.traceCondition_=e}setMap(t){super.setMap(t),this.updateState_()}setFreehand(t){this.freehand_=t,this.freehand_?this.freehandCondition_=C:this.freehandCondition_=this.options_&&this.options_.freehandCondition?this.options_.freehandCondition:D}getOverlay(){return this.overlay_}getFreehand(){return this.freehand_}handleEvent(t){t.originalEvent.type===I.CONTEXTMENU&&t.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(t);let e=t.type===c.POINTERMOVE,i=!0;return!this.freehand_&&this.lastDragTime_&&t.type===c.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=t.pixel,this.shouldHandle_=!this.freehand_,e=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&t.type===c.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(t.coordinate),i=!1):this.freehand_&&t.type===c.POINTERDOWN?i=!1:e&&this.getPointerCount()<2?(i=t.type===c.POINTERMOVE,i&&this.freehand_?(this.handlePointerMove_(t),this.shouldHandle_&&t.originalEvent.preventDefault()):(t.originalEvent.pointerType==="mouse"||t.type===c.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(t)):t.type===c.DBLCLICK&&(i=!1),super.handleEvent(t)&&i}handleDownEvent(t){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=t.pixel,this.finishCoordinate_||this.startDrawing_(t.coordinate),!0):this.condition_(t)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new b(c.POINTERMOVE,t.map,t.originalEvent,!1,t.frameState))},this.dragVertexDelay_),this.downPx_=t.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_();return}let e=this.getMap(),i=e.getCoordinateFromPixel([t.pixel[0]-this.snapTolerance_,t.pixel[1]+this.snapTolerance_]),o=e.getCoordinateFromPixel([t.pixel[0]+this.snapTolerance_,t.pixel[1]-this.snapTolerance_]),n=P([i,o]),s=this.traceSource_.getFeaturesInExtent(n);if(s.length===0)return;let r=et(t.coordinate,s);r.length&&(this.traceState_={active:!0,startCoord:t.coordinate.slice(),targets:r,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,e){let i=t.startIndex<=t.endIndex,o=t.startIndex<=e;i===o?i&&e>t.endIndex||!i&&e<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,e):(i&&e<t.endIndex||!i&&e>t.endIndex)&&this.removeTracedCoordinates_(e,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,e))}removeTracedCoordinates_(t,e){if(t===e)return;let i=0;if(t<e){let o=Math.ceil(t),n=Math.floor(e);n===e&&(n-=1),i=n-o+1}else{let o=Math.floor(t),n=Math.ceil(e);n===e&&(n+=1),i=o-n+1}i>0&&this.removeLastPoints_(i)}addTracedCoordinates_(t,e,i){if(e===i)return;let o=[];if(e<i){let n=Math.ceil(e),s=Math.floor(i);s===i&&(s-=1);for(let r=n;r<=s;++r)o.push(S(t.coordinates,r))}else{let n=Math.floor(e),s=Math.ceil(i);s===i&&(s+=1);for(let r=n;r>=s;--r)o.push(S(t.coordinates,r))}o.length&&this.appendCoordinates(o)}updateTrace_(t){let e=this.traceState_;if(!e.active)return;if(e.targetIndex===-1){let r=t.map.getPixelFromCoordinate(e.startCoord);if(v(r,t.pixel)<this.snapTolerance_)return}let i=tt(t.coordinate,e,this.getMap(),this.snapTolerance_);if(e.targetIndex!==i.index){if(e.targetIndex!==-1){let h=e.targets[e.targetIndex];this.removeTracedCoordinates_(h.startIndex,h.endIndex)}let r=e.targets[i.index];this.addTracedCoordinates_(r,r.startIndex,i.endIndex)}else{let r=e.targets[e.targetIndex];this.addOrRemoveTracedCoordinates_(r,i.endIndex)}e.targetIndex=i.index;let o=e.targets[e.targetIndex];o.endIndex=i.endIndex;let n=$(o.coordinates,o.endIndex),s=this.getMap().getPixelFromCoordinate(n);t.coordinate=n,t.pixel=[Math.round(s[0]),Math.round(s[1])]}handleDragEvent(t){this.ignoreNextUpEvent_=!0,super.handleDragEvent(t)}handleUpEvent(t){let e=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(t);let i=this.traceState_.active;if(this.ignoreNextUpEvent_||this.toggleTraceState_(t),this.shouldHandle_){let o=!this.finishCoordinate_;o&&this.startDrawing_(t.coordinate),!o&&this.freehand_?this.finishDrawing():!this.freehand_&&(!o||this.mode_==="Point")&&(this.atFinish_(t.pixel,i)?this.finishCondition_(t)&&this.finishDrawing():this.addToDrawing_(t.coordinate)),e=!1}else this.freehand_&&this.abortDrawing()}return this.ignoreNextUpEvent_=!1,!e&&this.stopClick_&&t.preventDefault(),e}handlePointerMove_(t){if(this.pointerType_=t.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){let e=this.downPx_,i=t.pixel,o=e[0]-i[0],n=e[1]-i[1],s=o*o+n*n;if(this.shouldHandle_=this.freehand_?s>this.squaredClickTolerance_:s<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(t.coordinate.slice());return}this.updateTrace_(t),this.modifyDrawing_(t.coordinate)}atFinish_(t,e){let i=!1;if(this.sketchFeature_){let o=!1,n=[this.finishCoordinate_],s=this.mode_;if(s==="Point")i=!0;else if(s==="Circle")i=this.sketchCoords_.length===2;else if(s==="LineString")o=!e&&this.sketchCoords_.length>this.minPoints_;else if(s==="Polygon"){let r=this.sketchCoords_;o=r[0].length>this.minPoints_,n=[r[0][0],r[0][r[0].length-2]],e?n=[r[0][0]]:n=[r[0][0],r[0][r[0].length-2]]}if(o){let r=this.getMap();for(let h=0,d=n.length;h<d;h++){let _=n[h],l=r.getPixelFromCoordinate(_),E=t[0]-l[0],R=t[1]-l[1],it=this.freehand_?1:this.snapTolerance_;if(i=Math.sqrt(E*E+R*R)<=it,i){this.finishCoordinate_=_;break}}}}return i}createOrUpdateSketchPoint_(t){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(t):(this.sketchPoint_=new u(new p(t)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(t){this.sketchLine_||(this.sketchLine_=new u);let e=t.getLinearRing(0),i=this.sketchLine_.getGeometry();i?(i.setFlatCoordinates(e.getLayout(),e.getFlatCoordinates()),i.changed()):(i=new y(e.getFlatCoordinates(),e.getLayout()),this.sketchLine_.setGeometry(i))}startDrawing_(t){let e=this.getMap().getView().getProjection(),i=x(this.geometryLayout_);for(;t.length<i;)t.push(0);this.finishCoordinate_=t,this.mode_==="Point"?this.sketchCoords_=t.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[t.slice(),t.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[t.slice(),t.slice()],this.sketchLineCoords_&&(this.sketchLine_=new u(new y(this.sketchLineCoords_)));let o=this.geometryFunction_(this.sketchCoords_,void 0,e);this.sketchFeature_=new u,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(o),this.updateSketchFeatures_(),this.dispatchEvent(new g(k.DRAWSTART,this.sketchFeature_))}modifyDrawing_(t){let e=this.getMap(),i=this.sketchFeature_.getGeometry(),o=e.getView().getProjection(),n=x(this.geometryLayout_),s,r;for(;t.length<n;)t.push(0);this.mode_==="Point"?r=this.sketchCoords_:this.mode_==="Polygon"?(s=this.sketchCoords_[0],r=s[s.length-1],this.atFinish_(e.getPixelFromCoordinate(t))&&(t=this.finishCoordinate_.slice())):(s=this.sketchCoords_,r=s[s.length-1]),r[0]=t[0],r[1]=t[1],this.geometryFunction_(this.sketchCoords_,i,o),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(t),i.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(i):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(t){let e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection(),o,n,s=this.mode_;return s==="LineString"||s==="Circle"?(this.finishCoordinate_=t.slice(),n=this.sketchCoords_,n.length>=this.maxPoints_&&(this.freehand_?n.pop():o=!0),n.push(t.slice()),this.geometryFunction_(n,e,i)):s==="Polygon"&&(n=this.sketchCoords_[0],n.length>=this.maxPoints_&&(this.freehand_?n.pop():o=!0),n.push(t.slice()),o&&(this.finishCoordinate_=n[0]),this.geometryFunction_(this.sketchCoords_,e,i)),this.createOrUpdateSketchPoint_(t.slice()),this.updateSketchFeatures_(),o?this.finishDrawing():this.sketchFeature_}removeLastPoints_(t){if(!this.sketchFeature_)return;let e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection(),o=this.mode_;for(let n=0;n<t;++n){let s;if(o==="LineString"||o==="Circle"){if(s=this.sketchCoords_,s.splice(-2,1),s.length>=2){this.finishCoordinate_=s[s.length-2].slice();let r=this.finishCoordinate_.slice();s[s.length-1]=r,this.createOrUpdateSketchPoint_(r)}this.geometryFunction_(s,e,i),e.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(e)}else if(o==="Polygon"){s=this.sketchCoords_[0],s.splice(-2,1);let r=this.sketchLine_.getGeometry();if(s.length>=2){let h=s[s.length-2].slice();s[s.length-1]=h,this.createOrUpdateSketchPoint_(h)}r.setCoordinates(s),this.geometryFunction_(this.sketchCoords_,e,i)}if(s.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){let t=this.abortDrawing_();if(!t)return null;let e=this.sketchCoords_,i=t.getGeometry(),o=this.getMap().getView().getProjection();return this.mode_==="LineString"?(e.pop(),this.geometryFunction_(e,i,o)):this.mode_==="Polygon"&&(e[0].pop(),this.geometryFunction_(e,i,o),e=i.getCoordinates()),this.type_==="MultiPoint"?t.setGeometry(new z([e])):this.type_==="MultiLineString"?t.setGeometry(new Y([e])):this.type_==="MultiPolygon"&&t.setGeometry(new J([e])),this.dispatchEvent(new g(k.DRAWEND,t)),this.features_&&this.features_.push(t),this.source_&&this.source_.addFeature(t),t}abortDrawing_(){this.finishCoordinate_=null;let t=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),t}abortDrawing(){let t=this.abortDrawing_();t&&this.dispatchEvent(new g(k.DRAWABORT,t))}appendCoordinates(t){let e=this.mode_,i=!this.sketchFeature_;i&&this.startDrawing_(t[0]);let o;if(e==="LineString"||e==="Circle")o=this.sketchCoords_;else if(e==="Polygon")o=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;i&&o.shift(),o.pop();for(let s=0;s<t.length;s++)this.addToDrawing_(t[s]);let n=t[t.length-1];this.sketchFeature_=this.addToDrawing_(n),this.modifyDrawing_(n)}extend(t){let i=t.getGeometry();this.sketchFeature_=t,this.sketchCoords_=i.getCoordinates();let o=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=o.slice(),this.sketchCoords_.push(o.slice()),this.sketchPoint_=new u(new p(o)),this.updateSketchFeatures_(),this.dispatchEvent(new g(k.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){let t=[];this.sketchFeature_&&t.push(this.sketchFeature_),this.sketchLine_&&t.push(this.sketchLine_),this.sketchPoint_&&t.push(this.sketchPoint_);let e=this.overlay_.getSource();e.clear(!0),e.addFeatures(t)}updateState_(){let t=this.getMap(),e=this.getActive();(!t||!e)&&this.abortDrawing(),this.overlay_.setMap(e?t:null)}};function st(){let a=K();return function(t,e){return a[t.getGeometry().getType()]}}function Mt(a,t){return function(e,i,o){let n=f(e[0],o),s=f(e[e.length-1],o),r=Math.sqrt(w(n,s));i=i||j(new L(n),a);let h=t;if(!t&&t!==0){let _=s[0]-n[0],l=s[1]-n[1];h=Math.atan2(l,_)}q(i,n,r,h);let d=m();return d&&i.transform(o,d),i}}function Et(){return function(a,t,e){let i=P([a[0],a[a.length-1]].map(function(s){return f(s,e)})),o=[[T(i),G(i),N(i),O(i),T(i)]];t?t.setCoordinates(o):t=new F(o);let n=m();return n&&t.transform(e,n),t}}function ot(a){switch(a){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+a)}}var Rt=M;export{Mt as a,Et as b,Rt as c};
