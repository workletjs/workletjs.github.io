import{a as Vt,b as Ce,c as I,d as R,e as Fe,h as Ne,i as Gt}from"./chunk-4FIWTF5F.js";import{a as Re}from"./chunk-OF3QUROX.js";import{c as Me}from"./chunk-KNT5A3QN.js";import{O as Oe,Q as zt,S as Pe,X as ke}from"./chunk-SFR7ATWH.js";import{B as Ee,D as De,b as Bt,c as vt,e as Ut,m as Lt,q as Se}from"./chunk-OAKYQQNU.js";import{C as Te,L as Ae,O as _e,x as Ie}from"./chunk-GF377ULF.js";import{a as q,b as j,d as st,f as v,h as nt,j as x}from"./chunk-TWZW5B45.js";var ir=v((Xs,Zt)=>{"use strict";function nr(o,t,e){let r=e&&e.debug||!1;r&&console.log("[xml-utils] getting "+t+" in "+o);let s=typeof o=="object"?o.outer:o,n=s.slice(0,s.indexOf(">")+1),i=['"',"'"];for(let a=0;a<i.length;a++){let c=i[a],l=t+"\\="+c+"([^"+c+"]*)"+c;r&&console.log("[xml-utils] pattern:",l);let f=new RegExp(l).exec(n);if(r&&console.log("[xml-utils] match:",f),f)return f[1]}}Zt.exports=nr;Zt.exports.default=nr});var cr=v((Zs,Jt)=>{"use strict";function ar(o,t,e){let s=new RegExp(t).exec(o.slice(e));return s?e+s.index:-1}Jt.exports=ar;Jt.exports.default=ar});var fr=v((Js,Qt)=>{"use strict";function lr(o,t,e){let s=new RegExp(t).exec(o.slice(e));return s?e+s.index+s[0].length-1:-1}Qt.exports=lr;Qt.exports.default=lr});var ur=v((Qs,Wt)=>{"use strict";function hr(o,t){let e=new RegExp(t,"g"),r=o.match(e);return r?r.length:0}Wt.exports=hr;Wt.exports.default=hr});var gr=v((Ws,ee)=>{"use strict";var mo=cr(),te=fr(),dr=ur();function pr(o,t,e){let r=e&&e.debug||!1,s=!(e&&typeof e.nested===!1),n=e&&e.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",t," and ",e);let i=mo(o,`<${t}[ 
>/]`,n);if(r&&console.log("[xml-utils] start:",i),i===-1)return;let a=o.slice(i+t.length),c=te(a,"^[^<]*[ /]>",0),l=c!==-1&&a[c-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",l),l===!1)if(s){let d=0,p=1,m=0;for(;(c=te(a,"[ /]"+t+">",d))!==-1;){let u=a.substring(d,c+1);if(p+=dr(u,"<"+t+`[ 
	>]`),m+=dr(u,"</"+t+">"),m>=p)break;d=c}}else c=te(a,"[ /]"+t+">",0);let h=i+t.length+c+1;if(r&&console.log("[xml-utils] end:",h),h===-1)return;let f=o.slice(i,h),g;return l?g=null:g=f.slice(f.indexOf(">")+1,f.lastIndexOf("<")),{inner:g,outer:f,start:i,end:h}}ee.exports=pr;ee.exports.default=pr});var mr=v((tn,re)=>{"use strict";var wo=gr();function yr(o,t,e){let r=[],s=e&&e.debug||!1,n=e&&typeof e.nested=="boolean"?e.nested:!0,i=e&&e.startIndex||0,a;for(;a=wo(o,t,{debug:s,startIndex:i});)n?i=a.start+1+t.length:i=a.end,r.push(a);return s&&console.log("findTagsByName found",r.length,"tags"),r}re.exports=yr;re.exports.default=yr});var Nr=v(()=>{"use strict"});var Br=v(()=>{"use strict"});var vr=v(()=>{"use strict"});var Be="Cannot convert undefined or null to object";function S(o){return(t,...e)=>to(o,t,e)}function Y(o,t){return S(ht(o,t).get)}var{apply:to,construct:$o,defineProperty:Xo,get:Zo,getOwnPropertyDescriptor:ht,getPrototypeOf:ut,has:Jo,ownKeys:Ue,set:Qo,setPrototypeOf:Wo}=Reflect;var{EPSILON:Le,MAX_SAFE_INTEGER:ts,isFinite:eo,isNaN:ro}=Number,{iterator:K,species:es,toStringTag:oo,for:rs}=Symbol,dt=Object,{create:pt,defineProperty:ze,freeze:os,is:ss}=dt,qt=dt.prototype,ns=qt.__lookupGetter__?S(qt.__lookupGetter__):(o,t)=>{if(o==null)throw ao(Be);let e=dt(o);do{let r=ht(e,t);if(r!==void 0)return so(r,"get")?r.get:void 0}while((e=ut(e))!==null)},so=dt.hasOwn||S(qt.hasOwnProperty),Ve=Array,is=Ve.isArray,gt=Ve.prototype,as=S(gt.join),cs=S(gt.push),ls=S(gt.toLocaleString),jt=gt[K],Ge=S(jt),{abs:no,trunc:fs}=Math,yt=ArrayBuffer,hs=yt.isView,qe=yt.prototype,us=S(qe.slice),ds=Y(qe,"byteLength"),ve=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null,ps=ve&&Y(ve.prototype,"byteLength"),je=ut(Uint8Array),gs=je.from,k=je.prototype,ys=k[K],ms=S(k.keys),ws=S(k.values),xs=S(k.entries),bs=S(k.set),Is=S(k.reverse),Ts=S(k.fill),As=S(k.copyWithin),_s=S(k.sort),Ss=S(k.slice),Es=S(k.subarray),Ds=Y(k,"buffer"),Os=Y(k,"byteOffset"),Ps=Y(k,"length"),ks=Y(k,oo),He=Uint8Array,Ht=Uint16Array;var mt=Uint32Array,Ye=Float32Array,$=ut([][K]()),Yt=S($.next),Ke=S((function*(){})().next),$e=ut($),Xe=DataView.prototype,Ze=S(Xe.getUint16),io=S(Xe.setUint16),ao=TypeError;var co=WeakSet,Je=co.prototype,Ms=S(Je.add),Rs=S(Je.has),wt=WeakMap,Kt=wt.prototype,$t=S(Kt.get),Cs=S(Kt.has),Qe=S(Kt.set);var We=new wt,lo=pt(null,{next:{value:function(){let t=$t(We,this);return Yt(t)}},[K]:{value:function(){return this}}});function tr(o){if(o[K]===jt&&$.next===Yt)return o;let t=pt(lo);return Qe(We,t,Ge(o)),t}var fo=new wt,ho=pt($e,{next:{value:function(){let t=$t(fo,this);return Ke(t)},writable:!0,configurable:!0}});for(let o of Ue($))o!=="next"&&ze(ho,o,ht($,o));var uo=1/Le;var po=6103515625e-14;var er=.0009765625,Us=er*po,Ls=er*uo;var rr=new yt(4),go=new Ye(rr),yo=new mt(rr),N=new Ht(512),B=new He(512);for(let o=0;o<256;++o){let t=o-127;t<-24?(N[o]=0,N[o|256]=32768,B[o]=24,B[o|256]=24):t<-14?(N[o]=1024>>-t-14,N[o|256]=1024>>-t-14|32768,B[o]=-t-1,B[o|256]=-t-1):t<=15?(N[o]=t+15<<10,N[o|256]=t+15<<10|32768,B[o]=13,B[o|256]=13):t<128?(N[o]=31744,N[o|256]=64512,B[o]=24,B[o|256]=24):(N[o]=31744,N[o|256]=64512,B[o]=13,B[o|256]=13)}var Xt=new mt(2048);for(let o=1;o<1024;++o){let t=o<<13,e=0;for(;(t&8388608)===0;)t<<=1,e-=8388608;t&=-8388609,e+=947912704,Xt[o]=t|e}for(let o=1024;o<2048;++o)Xt[o]=939524096+(o-1024<<13);var X=new mt(64);for(let o=1;o<31;++o)X[o]=o<<23;X[31]=1199570944;X[32]=2147483648;for(let o=33;o<63;++o)X[o]=2147483648+(o-32<<23);X[63]=3347054592;var or=new Ht(64);for(let o=1;o<64;++o)o!==32&&(or[o]=1024);function sr(o){let t=o>>10;return yo[0]=Xt[or[t]+(o&1023)]+X[t],go[0]}function it(o,t,...e){return sr(Ze(o,t,...tr(e)))}var It=nt(ir(),1),Dr=nt(mr(),1);function wr(o,t){let{width:e,height:r}=o,s=new Uint8Array(e*r*3),n;for(let i=0,a=0;i<o.length;++i,a+=3)n=256-o[i]/t*256,s[a]=n,s[a+1]=n,s[a+2]=n;return s}function xr(o,t){let{width:e,height:r}=o,s=new Uint8Array(e*r*3),n;for(let i=0,a=0;i<o.length;++i,a+=3)n=o[i]/t*256,s[a]=n,s[a+1]=n,s[a+2]=n;return s}function br(o,t){let{width:e,height:r}=o,s=new Uint8Array(e*r*3),n=t.length/3,i=t.length/3*2;for(let a=0,c=0;a<o.length;++a,c+=3){let l=o[a];s[c]=t[l]/65536*256,s[c+1]=t[l+n]/65536*256,s[c+2]=t[l+i]/65536*256}return s}function Ir(o){let{width:t,height:e}=o,r=new Uint8Array(t*e*3);for(let s=0,n=0;s<o.length;s+=4,n+=3){let i=o[s],a=o[s+1],c=o[s+2],l=o[s+3];r[n]=255*((255-i)/256)*((255-l)/256),r[n+1]=255*((255-a)/256)*((255-l)/256),r[n+2]=255*((255-c)/256)*((255-l)/256)}return r}function Tr(o){let{width:t,height:e}=o,r=new Uint8ClampedArray(t*e*3);for(let s=0,n=0;s<o.length;s+=3,n+=3){let i=o[s],a=o[s+1],c=o[s+2];r[n]=i+1.402*(c-128),r[n+1]=i-.34414*(a-128)-.71414*(c-128),r[n+2]=i+1.772*(a-128)}return r}var xo=.95047,bo=1,Io=1.08883;function Ar(o){let{width:t,height:e}=o,r=new Uint8Array(t*e*3);for(let s=0,n=0;s<o.length;s+=3,n+=3){let i=o[s+0],a=o[s+1]<<24>>24,c=o[s+2]<<24>>24,l=(i+16)/116,h=a/500+l,f=l-c/200,g,d,p;h=xo*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),l=bo*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),f=Io*(f*f*f>.008856?f*f*f:(f-16/116)/7.787),g=h*3.2406+l*-1.5372+f*-.4986,d=h*-.9689+l*1.8758+f*.0415,p=h*.0557+l*-.204+f*1.057,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,p=p>.0031308?1.055*p**(1/2.4)-.055:12.92*p,r[n]=Math.max(0,Math.min(1,g))*255,r[n+1]=Math.max(0,Math.min(1,d))*255,r[n+2]=Math.max(0,Math.min(1,p))*255}return r}var _r=new Map;function L(o,t){Array.isArray(o)||(o=[o]),o.forEach(e=>_r.set(e,t))}function xt(o){return x(this,null,function*(){let t=_r.get(o.Compression);if(!t)throw new Error(`Unknown compression method identifier: ${o.Compression}`);let e=yield t();return new e(o)})}L([void 0,1],()=>import("./chunk-7BAY3BKY.js").then(o=>o.default));L(5,()=>import("./chunk-2FWFIEKD.js").then(o=>o.default));L(6,()=>{throw new Error("old style JPEG compression is not supported.")});L(7,()=>import("./chunk-BZSTRAUE.js").then(o=>o.default));L([8,32946],()=>import("./chunk-MFQQXVJO.js").then(o=>o.default));L(32773,()=>import("./chunk-HCRYR6AQ.js").then(o=>o.default));L(34887,()=>import("./chunk-GUXT3MVW.js").then(o=>x(null,null,function*(){return yield o.zstd.init(),o})).then(o=>o.default));L(50001,()=>import("./chunk-YRBDWDOM.js").then(o=>o.default));function bt(o,t,e,r=1){return new(Object.getPrototypeOf(o)).constructor(t*e*r)}function To(o,t,e,r,s){let n=t/r,i=e/s;return o.map(a=>{let c=bt(a,r,s);for(let l=0;l<s;++l){let h=Math.min(Math.round(i*l),e-1);for(let f=0;f<r;++f){let g=Math.min(Math.round(n*f),t-1),d=a[h*t+g];c[l*r+f]=d}}return c})}function Z(o,t,e){return(1-e)*o+e*t}function Ao(o,t,e,r,s){let n=t/r,i=e/s;return o.map(a=>{let c=bt(a,r,s);for(let l=0;l<s;++l){let h=i*l,f=Math.floor(h),g=Math.min(Math.ceil(h),e-1);for(let d=0;d<r;++d){let p=n*d,m=p%1,u=Math.floor(p),w=Math.min(Math.ceil(p),t-1),y=a[f*t+u],b=a[f*t+w],T=a[g*t+u],A=a[g*t+w],O=Z(Z(y,b,m),Z(T,A,m),h%1);c[l*r+d]=O}}return c})}function Sr(o,t,e,r,s,n="nearest"){switch(n.toLowerCase()){case"nearest":return To(o,t,e,r,s);case"bilinear":case"linear":return Ao(o,t,e,r,s);default:throw new Error(`Unsupported resampling method: '${n}'`)}}function _o(o,t,e,r,s,n){let i=t/r,a=e/s,c=bt(o,r,s,n);for(let l=0;l<s;++l){let h=Math.min(Math.round(a*l),e-1);for(let f=0;f<r;++f){let g=Math.min(Math.round(i*f),t-1);for(let d=0;d<n;++d){let p=o[h*t*n+g*n+d];c[l*r*n+f*n+d]=p}}}return c}function So(o,t,e,r,s,n){let i=t/r,a=e/s,c=bt(o,r,s,n);for(let l=0;l<s;++l){let h=a*l,f=Math.floor(h),g=Math.min(Math.ceil(h),e-1);for(let d=0;d<r;++d){let p=i*d,m=p%1,u=Math.floor(p),w=Math.min(Math.ceil(p),t-1);for(let y=0;y<n;++y){let b=o[f*t*n+u*n+y],T=o[f*t*n+w*n+y],A=o[g*t*n+u*n+y],O=o[g*t*n+w*n+y],D=Z(Z(b,T,m),Z(A,O,m),h%1);c[l*r*n+d*n+y]=D}}}return c}function Er(o,t,e,r,s,n,i="nearest"){switch(i.toLowerCase()){case"nearest":return _o(o,t,e,r,s,n);case"bilinear":case"linear":return So(o,t,e,r,s,n);default:throw new Error(`Unsupported resampling method: '${i}'`)}}function Eo(o,t,e){let r=0;for(let s=t;s<e;++s)r+=o[s];return r}function oe(o,t,e){switch(o){case 1:if(t<=8)return new Uint8Array(e);if(t<=16)return new Uint16Array(e);if(t<=32)return new Uint32Array(e);break;case 2:if(t===8)return new Int8Array(e);if(t===16)return new Int16Array(e);if(t===32)return new Int32Array(e);break;case 3:switch(t){case 16:case 32:return new Float32Array(e);case 64:return new Float64Array(e);default:break}break;default:break}throw Error("Unsupported data format/bitsPerSample")}function Do(o,t){return(o===1||o===2)&&t<=32&&t%8===0?!1:!(o===3&&(t===16||t===32||t===64))}function Oo(o,t,e,r,s,n,i){let a=new DataView(o),c=e===2?i*n:i*n*r,l=e===2?1:r,h=oe(t,s,c),f=parseInt("1".repeat(s),2);if(t===1){let g;e===1?g=r*s:g=s;let d=n*g;(d&7)!==0&&(d=d+7&-8);for(let p=0;p<i;++p){let m=p*d;for(let u=0;u<n;++u){let w=m+u*l*s;for(let y=0;y<l;++y){let b=w+y*s,T=(p*n+u)*l+y,A=Math.floor(b/8),O=b%8;if(O+s<=8)h[T]=a.getUint8(A)>>8-s-O&f;else if(O+s<=16)h[T]=a.getUint16(A)>>16-s-O&f;else if(O+s<=24){let D=a.getUint16(A)<<8|a.getUint8(A+2);h[T]=D>>24-s-O&f}else h[T]=a.getUint32(A)>>32-s-O&f}}}}return h.buffer}var se=class{constructor(t,e,r,s,n,i){this.fileDirectory=t,this.geoKeys=e,this.dataView=r,this.littleEndian=s,this.tiles=n?{}:null,this.isTiled=!t.StripOffsets;let a=t.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=i}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(t){return this.isTiled||(t+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-t*this.getTileHeight()}getBytesPerPixel(){let t=0;for(let e=0;e<this.fileDirectory.BitsPerSample.length;++e)t+=this.getSampleByteSize(e);return t}getSampleByteSize(t){if(t>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${t} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[t]/8)}getReaderForSample(t){let e=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1,r=this.fileDirectory.BitsPerSample[t];switch(e){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(s,n){return it(this,s,n)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64;default:break}break;default:break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(t=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1}getBitsPerSample(t=0){return this.fileDirectory.BitsPerSample[t]}getArrayForSample(t,e){let r=this.getSampleFormat(t),s=this.getBitsPerSample(t);return oe(r,s,e)}getTileOrStrip(t,e,r,s,n){return x(this,null,function*(){let i=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight()),c,{tiles:l}=this;this.planarConfiguration===1?c=e*i+t:this.planarConfiguration===2&&(c=r*i*a+e*i+t);let h,f;this.isTiled?(h=this.fileDirectory.TileOffsets[c],f=this.fileDirectory.TileByteCounts[c]):(h=this.fileDirectory.StripOffsets[c],f=this.fileDirectory.StripByteCounts[c]);let g=(yield this.source.fetch([{offset:h,length:f}],n))[0],d;return l===null||!l[c]?(d=x(this,null,function*(){let p=yield s.decode(this.fileDirectory,g),m=this.getSampleFormat(),u=this.getBitsPerSample();return Do(m,u)&&(p=Oo(p,m,this.planarConfiguration,this.getSamplesPerPixel(),u,this.getTileWidth(),this.getBlockHeight(e))),p}),l!==null&&(l[c]=d)):d=l[c],{x:t,y:e,sample:r,data:yield d}})}_readRaster(t,e,r,s,n,i,a,c,l){return x(this,null,function*(){let h=this.getTileWidth(),f=this.getTileHeight(),g=this.getWidth(),d=this.getHeight(),p=Math.max(Math.floor(t[0]/h),0),m=Math.min(Math.ceil(t[2]/h),Math.ceil(g/h)),u=Math.max(Math.floor(t[1]/f),0),w=Math.min(Math.ceil(t[3]/f),Math.ceil(d/f)),y=t[2]-t[0],b=this.getBytesPerPixel(),T=[],A=[];for(let _=0;_<e.length;++_)this.planarConfiguration===1?T.push(Eo(this.fileDirectory.BitsPerSample,0,e[_])/8):T.push(0),A.push(this.getReaderForSample(e[_]));let O=[],{littleEndian:D}=this;for(let _=u;_<w;++_)for(let E=p;E<m;++E){let P;this.planarConfiguration===1&&(P=this.getTileOrStrip(E,_,0,n,l));for(let F=0;F<e.length;++F){let C=F,H=e[F];this.planarConfiguration===2&&(b=this.getSampleByteSize(H),P=this.getTileOrStrip(E,_,H,n,l));let tt=P.then(M=>{let Ft=M.data,Kr=new DataView(Ft),Nt=this.getBlockHeight(M.y),et=M.y*f,lt=M.x*h,$r=et+Nt,Xr=(M.x+1)*h,Zr=A[C],Jr=Math.min(Nt,Nt-($r-t[3]),d-et),Qr=Math.min(h,h-(Xr-t[2]),g-lt);for(let rt=Math.max(0,t[1]-et);rt<Jr;++rt)for(let ot=Math.max(0,t[0]-lt);ot<Qr;++ot){let Wr=(rt*h+ot)*b,be=Zr.call(Kr,Wr+T[C],D),ft;s?(ft=(rt+et-t[1])*y*e.length+(ot+lt-t[0])*e.length+C,r[ft]=be):(ft=(rt+et-t[1])*y+ot+lt-t[0],r[C][ft]=be)}});O.push(tt)}}if(yield Promise.all(O),i&&t[2]-t[0]!==i||a&&t[3]-t[1]!==a){let _;return s?_=Er(r,t[2]-t[0],t[3]-t[1],i,a,e.length,c):_=Sr(r,t[2]-t[0],t[3]-t[1],i,a,c),_.width=i,_.height=a,_}return r.width=i||t[2]-t[0],r.height=a||t[3]-t[1],r})}readRasters(){return x(this,arguments,function*({window:t,samples:e=[],interleave:r,pool:s=null,width:n,height:i,resampleMethod:a,fillValue:c,signal:l}={}){let h=t||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");let f=h[2]-h[0],g=h[3]-h[1],d=f*g,p=this.getSamplesPerPixel();if(!e||!e.length)for(let y=0;y<p;++y)e.push(y);else for(let y=0;y<e.length;++y)if(e[y]>=p)return Promise.reject(new RangeError(`Invalid sample index '${e[y]}'.`));let m;if(r){let y=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,b=Math.max.apply(null,this.fileDirectory.BitsPerSample);m=oe(y,b,d*e.length),c&&m.fill(c)}else{m=[];for(let y=0;y<e.length;++y){let b=this.getArrayForSample(e[y],d);Array.isArray(c)&&y<c.length?b.fill(c[y]):c&&!Array.isArray(c)&&b.fill(c),m.push(b)}}let u=s||(yield xt(this.fileDirectory));return yield this._readRaster(h,e,m,r,u,n,i,a,l)})}readRGB(){return x(this,arguments,function*({window:t,interleave:e=!0,pool:r=null,width:s,height:n,resampleMethod:i,enableAlpha:a=!1,signal:c}={}){let l=t||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");let h=this.fileDirectory.PhotometricInterpretation;if(h===R.RGB){let w=[0,1,2];if(this.fileDirectory.ExtraSamples!==Fe.Unspecified&&a){w=[];for(let y=0;y<this.fileDirectory.BitsPerSample.length;y+=1)w.push(y)}return this.readRasters({window:t,interleave:e,samples:w,pool:r,width:s,height:n,resampleMethod:i,signal:c})}let f;switch(h){case R.WhiteIsZero:case R.BlackIsZero:case R.Palette:f=[0];break;case R.CMYK:f=[0,1,2,3];break;case R.YCbCr:case R.CIELab:f=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}let g={window:l,interleave:!0,samples:f,pool:r,width:s,height:n,resampleMethod:i,signal:c},{fileDirectory:d}=this,p=yield this.readRasters(g),m=2**this.fileDirectory.BitsPerSample[0],u;switch(h){case R.WhiteIsZero:u=wr(p,m);break;case R.BlackIsZero:u=xr(p,m);break;case R.Palette:u=br(p,d.ColorMap);break;case R.CMYK:u=Ir(p);break;case R.YCbCr:u=Tr(p);break;case R.CIELab:u=Ar(p);break;default:throw new Error("Unsupported photometric interpretation.")}if(!e){let w=new Uint8Array(u.length/3),y=new Uint8Array(u.length/3),b=new Uint8Array(u.length/3);for(let T=0,A=0;T<u.length;T+=3,++A)w[A]=u[T],y[A]=u[T+1],b[A]=u[T+2];u=[w,y,b]}return u.width=p.width,u.height=p.height,u})}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];let t=[];for(let e=0;e<this.fileDirectory.ModelTiepoint.length;e+=6)t.push({i:this.fileDirectory.ModelTiepoint[e],j:this.fileDirectory.ModelTiepoint[e+1],k:this.fileDirectory.ModelTiepoint[e+2],x:this.fileDirectory.ModelTiepoint[e+3],y:this.fileDirectory.ModelTiepoint[e+4],z:this.fileDirectory.ModelTiepoint[e+5]});return t}getGDALMetadata(t=null){let e={};if(!this.fileDirectory.GDAL_METADATA)return null;let r=this.fileDirectory.GDAL_METADATA,s=(0,Dr.default)(r,"Item");t===null?s=s.filter(n=>(0,It.default)(n,"sample")===void 0):s=s.filter(n=>Number((0,It.default)(n,"sample"))===t);for(let n=0;n<s.length;++n){let i=s[n];e[(0,It.default)(i,"name")]=i.inner}return e}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;let t=this.fileDirectory.GDAL_NODATA;return Number(t.substring(0,t.length-1))}getOrigin(){let t=this.fileDirectory.ModelTiepoint,e=this.fileDirectory.ModelTransformation;if(t&&t.length===6)return[t[3],t[4],t[5]];if(e)return[e[3],e[7],e[11]];throw new Error("The image does not have an affine transformation.")}getResolution(t=null){let e=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(e)return[e[0],-e[1],e[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(t){let[s,n,i]=t.getResolution();return[s*t.getWidth()/this.getWidth(),n*t.getHeight()/this.getHeight(),i*t.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(t=!1){let e=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!t){let[s,n,i,a,c,l,h,f]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,e],[r,0],[r,e]].map(([u,w])=>[a+s*u+n*w,f+c*u+l*w]),p=d.map(u=>u[0]),m=d.map(u=>u[1]);return[Math.min(...p),Math.min(...m),Math.max(...p),Math.max(...m)]}else{let s=this.getOrigin(),n=this.getResolution(),i=s[0],a=s[1],c=i+n[0]*r,l=a+n[1]*e;return[Math.min(i,c),Math.min(a,l),Math.max(i,c),Math.max(a,l)]}}},ne=se;var Tt=class{constructor(t){this._dataView=new DataView(t)}get buffer(){return this._dataView.buffer}getUint64(t,e){let r=this.getUint32(t,e),s=this.getUint32(t+4,e),n;if(e){if(n=r+2**32*s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*r+s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}getInt64(t,e){let r=0,s=(this._dataView.getUint8(t+(e?7:0))&128)>0,n=!0;for(let i=0;i<8;i++){let a=this._dataView.getUint8(t+(e?i:7-i));s&&(n?a!==0&&(a=~(a-1)&255,n=!1):a=~a&255),r+=a*256**i}return s&&(r=-r),r}getUint8(t,e){return this._dataView.getUint8(t,e)}getInt8(t,e){return this._dataView.getInt8(t,e)}getUint16(t,e){return this._dataView.getUint16(t,e)}getInt16(t,e){return this._dataView.getInt16(t,e)}getUint32(t,e){return this._dataView.getUint32(t,e)}getInt32(t,e){return this._dataView.getInt32(t,e)}getFloat16(t,e){return it(this._dataView,t,e)}getFloat32(t,e){return this._dataView.getFloat32(t,e)}getFloat64(t,e){return this._dataView.getFloat64(t,e)}};var At=class{constructor(t,e,r,s){this._dataView=new DataView(t),this._sliceOffset=e,this._littleEndian=r,this._bigTiff=s}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(t,e){return this.sliceOffset<=t&&this.sliceTop>=t+e}readUint8(t){return this._dataView.getUint8(t-this._sliceOffset,this._littleEndian)}readInt8(t){return this._dataView.getInt8(t-this._sliceOffset,this._littleEndian)}readUint16(t){return this._dataView.getUint16(t-this._sliceOffset,this._littleEndian)}readInt16(t){return this._dataView.getInt16(t-this._sliceOffset,this._littleEndian)}readUint32(t){return this._dataView.getUint32(t-this._sliceOffset,this._littleEndian)}readInt32(t){return this._dataView.getInt32(t-this._sliceOffset,this._littleEndian)}readFloat32(t){return this._dataView.getFloat32(t-this._sliceOffset,this._littleEndian)}readFloat64(t){return this._dataView.getFloat64(t-this._sliceOffset,this._littleEndian)}readUint64(t){let e=this.readUint32(t),r=this.readUint32(t+4),s;if(this._littleEndian){if(s=e+2**32*r,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*e+r,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}readInt64(t){let e=0,r=(this._dataView.getUint8(t+(this._littleEndian?7:0))&128)>0,s=!0;for(let n=0;n<8;n++){let i=this._dataView.getUint8(t+(this._littleEndian?n:7-n));r&&(s?i!==0&&(i=~(i-1)&255,s=!1):i=~i&255),e+=i*256**n}return r&&(e=-e),e}readOffset(t){return this._bigTiff?this.readUint64(t):this.readUint32(t)}};var Po=typeof navigator<"u"&&navigator.hardwareConcurrency||2,ie=class{constructor(t=Po,e){this.workers=null,this._awaitingDecoder=null,this.size=t,this.messageId=0,t&&(this._awaitingDecoder=e?Promise.resolve(e):new Promise(r=>{import("./chunk-LODUIRV6.js").then(s=>{r(s.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let s=0;s<t;s++)this.workers.push({worker:r(),idle:!0})}))}decode(t,e){return x(this,null,function*(){return this._awaitingDecoder&&(yield this._awaitingDecoder),this.size===0?xt(t).then(r=>r.decode(t,e)):new Promise(r=>{let s=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];s.idle=!1;let n=this.messageId++,i=a=>{a.data.id===n&&(s.idle=!0,r(a.data.decoded),s.worker.removeEventListener("message",i))};s.worker.addEventListener("message",i),s.worker.postMessage({fileDirectory:t,buffer:e,id:n},[e])})})}destroy(){this.workers&&(this.workers.forEach(t=>{t.worker.terminate()}),this.workers=null)}},ae=ie;var Or=`\r
\r
`;function Pr(o){if(typeof Object.fromEntries<"u")return Object.fromEntries(o);let t={};for(let[e,r]of o)t[e.toLowerCase()]=r;return t}function ko(o){let t=o.split(`\r
`).map(e=>{let r=e.split(":").map(s=>s.trim());return r[0]=r[0].toLowerCase(),r});return Pr(t)}function kr(o){let[t,...e]=o.split(";").map(s=>s.trim()),r=e.map(s=>s.split("="));return{type:t,params:Pr(r)}}function _t(o){let t,e,r;return o&&([,t,e,r]=o.match(/bytes (\d+)-(\d+)\/(\d+)/),t=parseInt(t,10),e=parseInt(e,10),r=parseInt(r,10)),{start:t,end:e,total:r}}function Mr(o,t){let e=null,r=new TextDecoder("ascii"),s=[],n=`--${t}`,i=`${n}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(o,a,n.length))===n&&(e=a);if(e===null)throw new Error("Could not find initial boundary");for(;e<o.byteLength;){let a=r.decode(new Uint8Array(o,e,Math.min(n.length+1024,o.byteLength-e)));if(a.length===0||a.startsWith(i))break;if(!a.startsWith(n))throw new Error("Part does not start with boundary");let c=a.substr(n.length+2);if(c.length===0)break;let l=c.indexOf(Or),h=ko(c.substr(0,l)),{start:f,end:g,total:d}=_t(h["content-range"]),p=e+n.length+l+Or.length,m=parseInt(g,10)+1-parseInt(f,10);s.push({headers:h,data:o.slice(p,p+m),offset:f,length:m,fileSize:d}),e=p+m+4}return s}var z=class{fetch(t,e=void 0){return x(this,null,function*(){return Promise.all(t.map(r=>this.fetchSlice(r,e)))})}fetchSlice(t){return x(this,null,function*(){throw new Error(`fetching of slice ${t} not possible, not implemented`)})}get fileSize(){return null}close(){return x(this,null,function*(){})}};var St=class extends Map{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||Number.POSITIVE_INFINITY,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(let[e,r]of t)this.onEviction(e,r.value)}_deleteIfExpired(t,e){return typeof e.expiry=="number"&&e.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,e.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,e){if(this._deleteIfExpired(t,e)===!1)return e.value}_getItemValue(t,e){return e.expiry?this._getOrDeleteIfExpired(t,e):e.value}_peek(t,e){let r=e.get(t);return this._getItemValue(t,r)}_set(t,e){this.cache.set(t,e),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,e){this.oldCache.delete(t),this._set(t,e)}*_entriesAscending(){for(let t of this.oldCache){let[e,r]=t;this.cache.has(e)||this._deleteIfExpired(e,r)===!1&&(yield t)}for(let t of this.cache){let[e,r]=t;this._deleteIfExpired(e,r)===!1&&(yield t)}}get(t){if(this.cache.has(t)){let e=this.cache.get(t);return this._getItemValue(t,e)}if(this.oldCache.has(t)){let e=this.oldCache.get(t);if(this._deleteIfExpired(t,e)===!1)return this._moveToRecent(t,e),e.value}}set(t,e,{maxAge:r=this.maxAge}={}){let s=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(t)?this.cache.set(t,{value:e,expiry:s}):this._set(t,{value:e,expiry:s}),this}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){let e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");let e=[...this._entriesAscending()],r=e.length-t;r<0?(this.cache=new Map(e),this.oldCache=new Map,this._size=e.length):(r>0&&this._emitEvictions(e.slice(0,r)),this.oldCache=new Map(e.slice(r)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(let[t]of this)yield t}*values(){for(let[,t]of this)yield t}*[Symbol.iterator](){for(let t of this.cache){let[e,r]=t;this._deleteIfExpired(e,r)===!1&&(yield[e,r.value])}for(let t of this.oldCache){let[e,r]=t;this.cache.has(e)||this._deleteIfExpired(e,r)===!1&&(yield[e,r.value])}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;e>=0;--e){let r=t[e],[s,n]=r;this._deleteIfExpired(s,n)===!1&&(yield[s,n.value])}t=[...this.oldCache];for(let e=t.length-1;e>=0;--e){let r=t[e],[s,n]=r;this.cache.has(s)||this._deleteIfExpired(s,n)===!1&&(yield[s,n.value])}}*entriesAscending(){for(let[t,e]of this._entriesAscending())yield[t,e.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(let e of this.oldCache.keys())this.cache.has(e)||t++;return Math.min(this._size+t,this.maxSize)}entries(){return this.entriesAscending()}forEach(t,e=this){for(let[r,s]of this.entriesAscending())t.call(e,s,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}};function Rr(o){return x(this,null,function*(){return new Promise(t=>setTimeout(t,o))})}function Cr(o,t){let e=Array.isArray(o)?o:Array.from(o),r=Array.isArray(t)?t:Array.from(t);return e.map((s,n)=>[s,r[n]])}var U=class o extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,o),this.name="AbortError"}},ce=class extends Error{constructor(t,e){super(e),this.errors=t,this.message=e,this.name="AggregateError"}},Fr=ce;var le=class{constructor(t,e,r=null){this.offset=t,this.length=e,this.data=r}get top(){return this.offset+this.length}},Et=class{constructor(t,e,r){this.offset=t,this.length=e,this.blockIds=r}},Dt=class extends z{constructor(t,{blockSize:e=65536,cacheSize:r=100}={}){super(),this.source=t,this.blockSize=e,this.blockCache=new St({maxSize:r,onEviction:(s,n)=>{this.evictedBlocks.set(s,n)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}fetch(t,e){return x(this,null,function*(){let r=[],s=[],n=[];this.evictedBlocks.clear();for(let{offset:g,length:d}of t){let p=g+d,{fileSize:m}=this;m!==null&&(p=Math.min(p,m));let u=Math.floor(g/this.blockSize)*this.blockSize;for(let w=u;w<p;w+=this.blockSize){let y=Math.floor(w/this.blockSize);!this.blockCache.has(y)&&!this.blockRequests.has(y)&&(this.blockIdsToFetch.add(y),s.push(y)),this.blockRequests.has(y)&&r.push(this.blockRequests.get(y)),n.push(y)}}yield Rr(),this.fetchBlocks(e);let i=[];for(let g of s)this.blockRequests.has(g)&&i.push(this.blockRequests.get(g));yield Promise.allSettled(r),yield Promise.allSettled(i);let a=[],c=n.filter(g=>this.abortedBlockIds.has(g)||!this.blockCache.has(g));if(c.forEach(g=>this.blockIdsToFetch.add(g)),c.length>0&&e&&!e.aborted){this.fetchBlocks(null);for(let g of c){let d=this.blockRequests.get(g);if(!d)throw new Error(`Block ${g} is not in the block requests`);a.push(d)}yield Promise.allSettled(a)}if(e&&e.aborted)throw new U("Request was aborted");let l=n.map(g=>this.blockCache.get(g)||this.evictedBlocks.get(g)),h=l.filter(g=>!g);if(h.length)throw new Fr(h,"Request failed");let f=new Map(Cr(n,l));return this.readSliceData(t,f)})}fetchBlocks(t){if(this.blockIdsToFetch.size>0){let e=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(e,t);for(let s=0;s<e.length;++s){let n=e[s];for(let i of n.blockIds)this.blockRequests.set(i,x(this,null,function*(){try{let a=(yield r)[s],c=i*this.blockSize,l=c-a.offset,h=Math.min(l+this.blockSize,a.data.byteLength),f=a.data.slice(l,h),g=new le(c,f.byteLength,f,i);this.blockCache.set(i,g),this.abortedBlockIds.delete(i)}catch(a){if(a.name==="AbortError")a.signal=t,this.blockCache.delete(i),this.abortedBlockIds.add(i);else throw a}finally{this.blockRequests.delete(i)}}))}this.blockIdsToFetch.clear()}}groupBlocks(t){let e=Array.from(t).sort((i,a)=>i-a);if(e.length===0)return[];let r=[],s=null,n=[];for(let i of e)s===null||s+1===i?(r.push(i),s=i):(n.push(new Et(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[i],s=i);return n.push(new Et(r[0]*this.blockSize,r.length*this.blockSize,r)),n}readSliceData(t,e){return t.map(r=>{let s=r.offset+r.length;this.fileSize!==null&&(s=Math.min(this.fileSize,s));let n=Math.floor(r.offset/this.blockSize),i=Math.floor(s/this.blockSize),a=new ArrayBuffer(r.length),c=new Uint8Array(a);for(let l=n;l<=i;++l){let h=e.get(l),f=h.offset-r.offset,g=h.top-s,d=0,p=0,m;f<0?d=-f:f>0&&(p=f),g<0?m=h.length-d:m=s-h.offset-d;let u=new Uint8Array(h.data,d,m);c.set(u,p)}return a})}};var V=class{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(t){throw new Error("not implemented")}getData(){return x(this,null,function*(){throw new Error("not implemented")})}},G=class{constructor(t){this.url=t}request(){return x(this,arguments,function*({headers:t,signal:e}={}){throw new Error("request is not implemented")})}};var fe=class extends V{constructor(t){super(),this.response=t}get status(){return this.response.status}getHeader(t){return this.response.headers.get(t)}getData(){return x(this,null,function*(){return this.response.arrayBuffer?yield this.response.arrayBuffer():(yield this.response.buffer()).buffer})}},Ot=class extends G{constructor(t,e){super(t),this.credentials=e}request(){return x(this,arguments,function*({headers:t,signal:e}={}){let r=yield fetch(this.url,{headers:t,credentials:this.credentials,signal:e});return new fe(r)})}};var he=class extends V{constructor(t,e){super(),this.xhr=t,this.data=e}get status(){return this.xhr.status}getHeader(t){return this.xhr.getResponseHeader(t)}getData(){return x(this,null,function*(){return this.data})}},Pt=class extends G{constructRequest(t,e){return new Promise((r,s)=>{let n=new XMLHttpRequest;n.open("GET",this.url),n.responseType="arraybuffer";for(let[i,a]of Object.entries(t))n.setRequestHeader(i,a);n.onload=()=>{let i=n.response;r(new he(n,i))},n.onerror=s,n.onabort=()=>s(new U("Request aborted")),n.send(),e&&(e.aborted&&n.abort(),e.addEventListener("abort",()=>n.abort()))})}request(){return x(this,arguments,function*({headers:t,signal:e}={}){return yield this.constructRequest(t,e)})}};var Ur=nt(Nr(),1),Lr=nt(Br(),1),zr=nt(vr(),1);var ue=class extends V{constructor(t,e){super(),this.response=t,this.dataPromise=e}get status(){return this.response.statusCode}getHeader(t){return this.response.headers[t]}getData(){return x(this,null,function*(){return yield this.dataPromise})}},kt=class extends G{constructor(t){super(t),this.parsedUrl=zr.default.parse(this.url),this.httpApi=this.parsedUrl.protocol==="http:"?Ur.default:Lr.default}constructRequest(t,e){return new Promise((r,s)=>{let n=this.httpApi.get(j(q({},this.parsedUrl),{headers:t}),i=>{let a=new Promise(c=>{let l=[];i.on("data",h=>{l.push(h)}),i.on("end",()=>{let h=Buffer.concat(l).buffer;c(h)}),i.on("error",s)});r(new ue(i,a))});n.on("error",s),e&&(e.aborted&&n.destroy(new U("Request aborted")),e.addEventListener("abort",()=>n.destroy(new U("Request aborted"))))})}request(){return x(this,arguments,function*({headers:t,signal:e}={}){return yield this.constructRequest(t,e)})}};var at=class extends z{constructor(t,e,r,s){super(),this.client=t,this.headers=e,this.maxRanges=r,this.allowFullFile=s,this._fileSize=null}fetch(t,e){return x(this,null,function*(){return this.maxRanges>=t.length?this.fetchSlices(t,e):(this.maxRanges>0&&t.length>1,Promise.all(t.map(r=>this.fetchSlice(r,e))))})}fetchSlices(t,e){return x(this,null,function*(){let r=yield this.client.request({headers:j(q({},this.headers),{Range:`bytes=${t.map(({offset:s,length:n})=>`${s}-${s+n}`).join(",")}`}),signal:e});if(r.ok)if(r.status===206){let{type:s,params:n}=kr(r.getHeader("content-type"));if(s==="multipart/byteranges"){let f=Mr(yield r.getData(),n.boundary);return this._fileSize=f[0].fileSize||null,f}let i=yield r.getData(),{start:a,end:c,total:l}=_t(r.getHeader("content-range"));this._fileSize=l||null;let h=[{data:i,offset:a,length:c-a}];if(t.length>1){let f=yield Promise.all(t.slice(1).map(g=>this.fetchSlice(g,e)));return h.concat(f)}return h}else{if(!this.allowFullFile)throw new Error("Server responded with full file");let s=yield r.getData();return this._fileSize=s.byteLength,[{data:s,offset:0,length:s.byteLength}]}else throw new Error("Error fetching data.")})}fetchSlice(t,e){return x(this,null,function*(){let{offset:r,length:s}=t,n=yield this.client.request({headers:j(q({},this.headers),{Range:`bytes=${r}-${r+s}`}),signal:e});if(n.ok)if(n.status===206){let i=yield n.getData(),{total:a}=_t(n.getHeader("content-range"));return this._fileSize=a||null,{data:i,offset:r,length:s}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");let i=yield n.getData();return this._fileSize=i.byteLength,{data:i,offset:0,length:i.byteLength}}else throw new Error("Error fetching data.")})}get fileSize(){return this._fileSize}};function de(o,{blockSize:t,cacheSize:e}){return t===null?o:new Dt(o,{blockSize:t,cacheSize:e})}function Mo(o,i={}){var a=i,{headers:t={},credentials:e,maxRanges:r=0,allowFullFile:s=!1}=a,n=st(a,["headers","credentials","maxRanges","allowFullFile"]);let c=new Ot(o,e),l=new at(c,t,r,s);return de(l,n)}function Ro(o,n={}){var i=n,{headers:t={},maxRanges:e=0,allowFullFile:r=!1}=i,s=st(i,["headers","maxRanges","allowFullFile"]);let a=new Pt(o),c=new at(a,t,e,r);return de(c,s)}function Co(o,n={}){var i=n,{headers:t={},maxRanges:e=0,allowFullFile:r=!1}=i,s=st(i,["headers","maxRanges","allowFullFile"]);let a=new kt(o),c=new at(a,t,e,r);return de(c,s)}function Mt(o,r={}){var s=r,{forceXHR:t=!1}=s,e=st(s,["forceXHR"]);return typeof fetch=="function"&&!t?Mo(o,e):typeof XMLHttpRequest<"u"?Ro(o,e):Co(o,e)}var pe=class extends z{constructor(t){super(),this.file=t}fetchSlice(t,e){return x(this,null,function*(){return new Promise((r,s)=>{let n=this.file.slice(t.offset,t.offset+t.length),i=new FileReader;i.onload=a=>r(a.target.result),i.onerror=s,i.onabort=s,i.readAsArrayBuffer(n),e&&e.addEventListener("abort",()=>i.abort())})})}};function Vr(o){return new pe(o)}function ge(o){switch(o){case I.BYTE:case I.ASCII:case I.SBYTE:case I.UNDEFINED:return 1;case I.SHORT:case I.SSHORT:return 2;case I.LONG:case I.SLONG:case I.FLOAT:case I.IFD:return 4;case I.RATIONAL:case I.SRATIONAL:case I.DOUBLE:case I.LONG8:case I.SLONG8:case I.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${o}`)}}function Fo(o){let t=o.GeoKeyDirectory;if(!t)return null;let e={};for(let r=4;r<=t[3]*4;r+=4){let s=Ne[t[r]],n=t[r+1]?Vt[t[r+1]]:null,i=t[r+2],a=t[r+3],c=null;if(!n)c=a;else{if(c=o[n],typeof c>"u"||c===null)throw new Error(`Could not get value of geoKey '${s}'.`);typeof c=="string"?c=c.substring(a,a+i-1):c.subarray&&(c=c.subarray(a,a+i),i===1&&(c=c[0]))}e[s]=c}return e}function J(o,t,e,r){let s=null,n=null,i=ge(t);switch(t){case I.BYTE:case I.ASCII:case I.UNDEFINED:s=new Uint8Array(e),n=o.readUint8;break;case I.SBYTE:s=new Int8Array(e),n=o.readInt8;break;case I.SHORT:s=new Uint16Array(e),n=o.readUint16;break;case I.SSHORT:s=new Int16Array(e),n=o.readInt16;break;case I.LONG:case I.IFD:s=new Uint32Array(e),n=o.readUint32;break;case I.SLONG:s=new Int32Array(e),n=o.readInt32;break;case I.LONG8:case I.IFD8:s=new Array(e),n=o.readUint64;break;case I.SLONG8:s=new Array(e),n=o.readInt64;break;case I.RATIONAL:s=new Uint32Array(e*2),n=o.readUint32;break;case I.SRATIONAL:s=new Int32Array(e*2),n=o.readInt32;break;case I.FLOAT:s=new Float32Array(e),n=o.readFloat32;break;case I.DOUBLE:s=new Float64Array(e),n=o.readFloat64;break;default:throw new RangeError(`Invalid field type: ${t}`)}if(t===I.RATIONAL||t===I.SRATIONAL)for(let a=0;a<e;a+=2)s[a]=n.call(o,r+a*i),s[a+1]=n.call(o,r+(a*i+4));else for(let a=0;a<e;++a)s[a]=n.call(o,r+a*i);return t===I.ASCII?new TextDecoder("utf-8").decode(s):s}var ye=class{constructor(t,e,r){this.fileDirectory=t,this.geoKeyDirectory=e,this.nextIFDByteOffset=r}},Q=class extends Error{constructor(t){super(`No image at index ${t}`),this.index=t}},Rt=class{readRasters(){return x(this,arguments,function*(t={}){let{window:e,width:r,height:s}=t,{resX:n,resY:i,bbox:a}=t,c=yield this.getImage(),l=c,h=yield this.getImageCount(),f=c.getBoundingBox();if(e&&a)throw new Error('Both "bbox" and "window" passed.');if(r||s){if(e){let[p,m]=c.getOrigin(),[u,w]=c.getResolution();a=[p+e[0]*u,m+e[1]*w,p+e[2]*u,m+e[3]*w]}let d=a||f;if(r){if(n)throw new Error("Both width and resX passed");n=(d[2]-d[0])/r}if(s){if(i)throw new Error("Both width and resY passed");i=(d[3]-d[1])/s}}if(n||i){let d=[];for(let p=0;p<h;++p){let m=yield this.getImage(p),{SubfileType:u,NewSubfileType:w}=m.fileDirectory;(p===0||u===2||w&1)&&d.push(m)}d.sort((p,m)=>p.getWidth()-m.getWidth());for(let p=0;p<d.length;++p){let m=d[p],u=(f[2]-f[0])/m.getWidth(),w=(f[3]-f[1])/m.getHeight();if(l=m,n&&n>u||i&&i>w)break}}let g=e;if(a){let[d,p]=c.getOrigin(),[m,u]=l.getResolution(c);g=[Math.round((a[0]-d)/m),Math.round((a[1]-p)/u),Math.round((a[2]-d)/m),Math.round((a[3]-p)/u)],g=[Math.min(g[0],g[2]),Math.min(g[1],g[3]),Math.max(g[0],g[2]),Math.max(g[1],g[3])]}return l.readRasters(j(q({},t),{window:g}))})}},W=class o extends Rt{constructor(t,e,r,s,n={}){super(),this.source=t,this.littleEndian=e,this.bigTiff=r,this.firstIFDOffset=s,this.cache=n.cache||!1,this.ifdRequests=[],this.ghostValues=null}getSlice(t,e){return x(this,null,function*(){let r=this.bigTiff?4048:1024;return new At((yield this.source.fetch([{offset:t,length:typeof e<"u"?e:r}]))[0],t,this.littleEndian,this.bigTiff)})}parseFileDirectoryAt(t){return x(this,null,function*(){let e=this.bigTiff?20:12,r=this.bigTiff?8:2,s=yield this.getSlice(t),n=this.bigTiff?s.readUint64(t):s.readUint16(t),i=n*e+(this.bigTiff?16:6);s.covers(t,i)||(s=yield this.getSlice(t,i));let a={},c=t+(this.bigTiff?8:2);for(let f=0;f<n;c+=e,++f){let g=s.readUint16(c),d=s.readUint16(c+2),p=this.bigTiff?s.readUint64(c+4):s.readUint32(c+4),m,u,w=ge(d),y=c+(this.bigTiff?12:8);if(w*p<=(this.bigTiff?8:4))m=J(s,d,p,y);else{let b=s.readOffset(y),T=ge(d)*p;if(s.covers(b,T))m=J(s,d,p,b);else{let A=yield this.getSlice(b,T);m=J(A,d,p,b)}}p===1&&Ce.indexOf(g)===-1&&!(d===I.RATIONAL||d===I.SRATIONAL)?u=m[0]:u=m,a[Vt[g]]=u}let l=Fo(a),h=s.readOffset(t+r+e*n);return new ye(a,l,h)})}requestIFD(t){return x(this,null,function*(){if(this.ifdRequests[t])return this.ifdRequests[t];if(t===0)return this.ifdRequests[t]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[t];if(!this.ifdRequests[t-1])try{this.ifdRequests[t-1]=this.requestIFD(t-1)}catch(e){throw e instanceof Q?new Q(t):e}return this.ifdRequests[t]=x(this,null,function*(){let e=yield this.ifdRequests[t-1];if(e.nextIFDByteOffset===0)throw new Q(t);return this.parseFileDirectoryAt(e.nextIFDByteOffset)}),this.ifdRequests[t]})}getImage(t=0){return x(this,null,function*(){let e=yield this.requestIFD(t);return new ne(e.fileDirectory,e.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)})}getImageCount(){return x(this,null,function*(){let t=0,e=!0;for(;e;)try{yield this.requestIFD(t),++t}catch(r){if(r instanceof Q)e=!1;else throw r}return t})}getGhostValues(){return x(this,null,function*(){let t=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;let e="GDAL_STRUCTURAL_METADATA_SIZE=",r=e.length+100,s=yield this.getSlice(t,r);if(e===J(s,I.ASCII,e.length,t)){let i=J(s,I.ASCII,r,t).split(`
`)[0],a=Number(i.split("=")[1].split(" ")[0])+i.length;a>r&&(s=yield this.getSlice(t,a));let c=J(s,I.ASCII,a,t);this.ghostValues={},c.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,h])=>{this.ghostValues[l]=h})}return this.ghostValues})}static fromSource(t,e,r){return x(this,null,function*(){let s=(yield t.fetch([{offset:0,length:1024}],r))[0],n=new Tt(s),i=n.getUint16(0,0),a;if(i===18761)a=!0;else if(i===19789)a=!1;else throw new TypeError("Invalid byte order value.");let c=n.getUint16(2,a),l;if(c===42)l=!1;else if(c===43){if(l=!0,n.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");let h=l?n.getUint64(8,a):n.getUint32(4,a);return new o(t,a,l,h,e)})}close(){return typeof this.source.close=="function"?this.source.close():!1}};var me=class extends Rt{constructor(t,e){super(),this.mainFile=t,this.overviewFiles=e,this.imageFiles=[t].concat(e),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}parseFileDirectoriesPerFile(){return x(this,null,function*(){let t=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(e=>e.parseFileDirectoryAt(e.firstIFDOffset)));return this.fileDirectoriesPerFile=yield Promise.all(t),this.fileDirectoriesPerFile})}getImage(t=0){return x(this,null,function*(){yield this.getImageCount(),yield this.parseFileDirectoriesPerFile();let e=0,r=0;for(let s=0;s<this.imageFiles.length;s++){let n=this.imageFiles[s];for(let i=0;i<this.imageCounts[s];i++){if(t===e){let a=yield n.requestIFD(r);return new ne(a.fileDirectory,a.geoKeyDirectory,n.dataView,n.littleEndian,n.cache,n.source)}e++,r++}r=0}throw new RangeError("Invalid image index")})}getImageCount(){return x(this,null,function*(){if(this.imageCount!==null)return this.imageCount;let t=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(e=>e.getImageCount()));return this.imageCounts=yield Promise.all(t),this.imageCount=this.imageCounts.reduce((e,r)=>e+r,0),this.imageCount})}};function Gr(r){return x(this,arguments,function*(o,t={},e){return W.fromSource(Mt(o,t),e)})}function qr(o,t){return x(this,null,function*(){return W.fromSource(Vr(o),t)})}function jr(s){return x(this,arguments,function*(o,t=[],e={},r){let n=yield W.fromSource(Mt(o,e),r),i=yield Promise.all(t.map(a=>W.fromSource(Mt(a,e))));return new me(n,i)})}function No(o){return((o.fileDirectory.NewSubfileType||0)&4)===4}function Bo(o,t){if(!o)return!1;if(o===!0)return!0;if(t.getSamplesPerPixel()!==3)return!1;let e=t.fileDirectory.PhotometricInterpretation,r=Gt.photometricInterpretations;return e===r.CMYK||e===r.YCbCr||e===r.CIELab||e===r.ICCLab}var Hr="STATISTICS_MAXIMUM",Yr="STATISTICS_MINIMUM",we=256,xe;function vo(){return xe||(xe=new ae),xe}function Uo(o){try{return o.getBoundingBox(!0)}catch{return[0,0,o.getWidth(),o.getHeight()]}}function Lo(o){try{return o.getOrigin().slice(0,2)}catch{return[0,o.getHeight()]}}function zo(o,t){try{return o.getResolution(t)}catch{return[t.getWidth()/o.getWidth(),t.getHeight()/o.getHeight()]}}function Vo(o){let t=o.geoKeys;if(!t)return null;if(t.ProjectedCSTypeGeoKey&&t.ProjectedCSTypeGeoKey!==32767){let e="EPSG:"+t.ProjectedCSTypeGeoKey,r=Lt(e);if(!r){let s=vt(t.ProjLinearUnitsGeoKey);s&&(r=new Ut({code:e,units:s}))}return r}if(t.GeographicTypeGeoKey&&t.GeographicTypeGeoKey!==32767){let e="EPSG:"+t.GeographicTypeGeoKey,r=Lt(e);if(!r){let s=vt(t.GeogAngularUnitsGeoKey);s&&(r=new Ut({code:e,units:s}))}return r}return null}function Go(o){return o.getImageCount().then(function(t){let e=new Array(t);for(let r=0;r<t;++r)e[r]=o.getImage(r);return Promise.all(e)})}function qo(o,t){let e;return o.blob?e=qr(o.blob):o.overviews?e=jr(o.url,o.overviews,t):e=Gr(o.url,t),e.then(Go)}function ct(o,t,e,r,s){if(Array.isArray(o)){let n=o.length;if(!Array.isArray(t)||n!=t.length){let i=new Error(r);throw s(i),i}for(let i=0;i<n;++i)ct(o[i],t[i],e,r,s);return}if(t=t,Math.abs(o-t)>e*o)throw new Error(r)}function jo(o){return o instanceof Int8Array?-128:o instanceof Int16Array?-32768:o instanceof Int32Array?-2147483648:o instanceof Float32Array?12e-39:0}function Ho(o){return o instanceof Int8Array?127:o instanceof Uint8Array||o instanceof Uint8ClampedArray?255:o instanceof Int16Array?32767:o instanceof Uint16Array?65535:o instanceof Int32Array?2147483647:o instanceof Uint32Array?4294967295:o instanceof Float32Array?34e37:255}var Ct=class extends Re{constructor(t){super({state:"loading",tileGrid:null,projection:t.projection||null,transition:t.transition,interpolate:t.interpolate!==!1,wrapX:t.wrapX}),this.sourceInfo_=t.sources;let e=this.sourceInfo_.length;this.sourceOptions_=t.sourceOptions,this.sourceImagery_=new Array(e),this.sourceMasks_=new Array(e),this.resolutionFactors_=new Array(e),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=t.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=t.convertToRGB||!1,this.setKey(this.sourceInfo_.map(n=>n.url).join(","));let r=this,s=new Array(e);for(let n=0;n<e;++n)s[n]=qo(this.sourceInfo_[n],this.sourceOptions_);Promise.all(s).then(function(n){r.configure_(n)}).catch(function(n){Bt(n),r.error_=n,r.setState("error")})}getError(){return this.error_}determineProjection(t){let e=t[0];for(let r=e.length-1;r>=0;--r){let s=e[r],n=Vo(s);if(n){this.projection=n;break}}}determineTransformMatrix(t){let e=t[0];for(let r=e.length-1;r>=0;--r){let n=e[r].fileDirectory.ModelTransformation;if(n){let[i,a,c,l,h,f,g,d]=n,p=zt(zt([1/Math.sqrt(i*i+h*h),0,0,-1/Math.sqrt(a*a+f*f),l,d],[i,h,a,f,0,0]),[1,0,0,1,-l,-d]);this.transformMatrix=p,this.addAlpha_=!0;break}}}configure_(t){let e,r,s,n,i,a=new Array(t.length),c=new Array(t.length),l=new Array(t.length),h=0,f=t.length;for(let u=0;u<f;++u){let w=[],y=[];t[u].forEach(E=>{No(E)?y.push(E):w.push(E)});let b=w.length;if(y.length>0&&y.length!==b)throw new Error(`Expected one mask per image found ${y.length} masks and ${b} images`);let T,A,O=new Array(b),D=new Array(b),_=new Array(b);c[u]=new Array(b),l[u]=new Array(b);for(let E=0;E<b;++E){let P=w[E],F=P.getGDALNoData();l[u][E]=P.getGDALMetadata(0),c[u][E]=F;let C=this.sourceInfo_[u].bands;a[u]=C?C.length:P.getSamplesPerPixel();let H=b-(E+1);T||(T=Uo(P)),A||(A=Lo(P));let tt=zo(P,w[0]);_[H]=tt[0];let M=[P.getTileWidth(),P.getTileHeight()];M[0]!==M[1]&&M[1]<we&&(M[0]=we,M[1]=we),O[H]=M;let Ft=tt[0]/Math.abs(tt[1]);D[H]=[M[0],M[1]/Ft]}if(e?Te(e,T,e):e=T,!r)r=A;else{let E=`Origin mismatch for source ${u}, got [${A}] but expected [${r}]`;ct(r,A,0,E,this.viewRejector)}if(!i)i=_,this.resolutionFactors_[u]=1;else{i.length-h>_.length&&(h=i.length-_.length);let E=i[i.length-1]/_[_.length-1];this.resolutionFactors_[u]=E;let P=_.map(C=>C*=E),F=`Resolution mismatch for source ${u}, got [${P}] but expected [${i}]`;ct(i.slice(h,i.length),P,.02,F,this.viewRejector)}s?ct(s.slice(h,s.length),D,.01,`Tile size mismatch for source ${u}`,this.viewRejector):s=D,n?ct(n.slice(h,n.length),O,0,`Tile size mismatch for source ${u}`,this.viewRejector):n=O,this.sourceImagery_[u]=w.reverse(),this.sourceMasks_[u]=y.reverse()}for(let u=0,w=this.sourceImagery_.length;u<w;++u){let y=this.sourceImagery_[u];for(;y.length<i.length;)y.unshift(void 0)}this.getProjection()||this.determineProjection(t),this.determineTransformMatrix(t),this.samplesPerPixel_=a,this.nodataValues_=c,this.metadata_=l;t:for(let u=0;u<f;++u){if(this.sourceInfo_[u].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[u].length){this.addAlpha_=!0;break}let w=c[u],y=this.sourceInfo_[u].bands;if(y){for(let b=0;b<y.length;++b)if(w[y[b]-1]!==null){this.addAlpha_=!0;break t}continue}for(let b=0;b<w.length;++b)if(w[b]!==null){this.addAlpha_=!0;break t}}let g=this.addAlpha_?1:0;for(let u=0;u<f;++u)g+=a[u];this.bandCount=g;let d=new Me({extent:e,minZoom:h,origin:r,resolutions:i,tileSizes:s});this.tileGrid=d,this.setTileSizes(n),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");let p=1;i.length===2?i=[i[0],i[1],i[1]/2]:i.length===1&&(i=[i[0]*2,i[0],i[0]/2]);let m=e;if(this.transformMatrix){let u=ke(Oe(),this.transformMatrix.slice()),w=Se(y=>Pe(u,y));m=Ae(e,w)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:i,center:Ee(Ie(m),this.projection),extent:De(m,this.projection),zoom:p})}loadTile_(t,e,r,s){let n=this.getTileSize(t),i=this.sourceImagery_.length,a=new Array(i*2),c=this.nodataValues_,l=this.sourceInfo_,h=vo();for(let f=0;f<i;++f){let g=l[f],d=this.resolutionFactors_[f],p=[Math.round(e*(n[0]*d)),Math.round(r*(n[1]*d)),Math.round((e+1)*(n[0]*d)),Math.round((r+1)*(n[1]*d))],m=this.sourceImagery_[f][t],u;g.bands&&(u=g.bands.map(function(A){return A-1}));let w;"nodata"in g&&g.nodata!==null?w=g.nodata:u?w=u.map(function(A){return c[f][A]}):w=c[f];let y={window:p,width:n[0],height:n[1],samples:u,fillValue:w,pool:h,interleave:!1,signal:s.signal};Bo(this.convertToRGB_,m)?a[f]=m.readRGB(y):a[f]=m.readRasters(y);let b=i+f,T=this.sourceMasks_[f][t];if(!T){a[b]=Promise.resolve(null);continue}a[b]=T.readRasters({window:p,width:n[0],height:n[1],samples:[0],pool:h,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,n)).catch(function(f){throw Bt(f),f})}composeTile_(t,e){let r=this.metadata_,s=this.sourceInfo_,n=this.sourceImagery_.length,i=this.bandCount,a=this.samplesPerPixel_,c=this.nodataValues_,l=this.normalize_,h=this.addAlpha_,f=t[0]*t[1],g=f*i,d;l?d=new Uint8Array(g):d=new Float32Array(g);let p=0;for(let m=0;m<f;++m){let u=h;for(let w=0;w<n;++w){let y=s[w],b=y.min,T=y.max,A,O;if(l){let D=r[w][0];b===void 0&&(D&&Yr in D?b=parseFloat(D[Yr]):b=jo(e[w][0])),T===void 0&&(D&&Hr in D?T=parseFloat(D[Hr]):T=Ho(e[w][0])),A=255/(T-b),O=-b*A}for(let D=0;D<a[w];++D){let _=e[w][D][m],E;if(l?E=_e(A*_+O,0,255):E=_,!h)d[p]=E;else{let P=y.nodata;if(P===void 0){let C;y.bands?C=y.bands[D]-1:C=D,P=c[w][C]}let F=isNaN(P);(!F&&_!==P||F&&!isNaN(_))&&(u=!1,d[p]=E)}p++}if(!u){let D=n+w,_=e[D];_&&!_[0][m]&&(u=!0)}}h&&(u||(d[p]=255),p++)}return d}};Ct.prototype.getView;var Si=Ct;export{Si as a};
