import{b as ct}from"./chunk-H6QH7D4S.js";import{c as ft}from"./chunk-XZFPOBQN.js";import{a as y,j as V,k as lt,l as w,m as U,n as dt,o as j}from"./chunk-5RIY7GGT.js";import{$a as st,C as z,D as m,La as F,Na as et,Oa as it,a as B,aa as A,db as q,fb as nt,ib as ot,k as X,kb as rt,l as K,lc as at,nb as ht,q as Y,wa as D}from"./chunk-BZGSA6SQ.js";import{C,z as x}from"./chunk-S7COXUW4.js";import{I as O,J as Z,Q as $,R as tt,a as J,c as R,i as Q,ka as N,la as v,o as G}from"./chunk-QFWXP63S.js";var L={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"},k=class extends Y{constructor(t,e){super(t),this.feature=e}};function pt(h,t){let e=[];for(let i=0;i<t.length;++i){let o=t[i].getGeometry();ut(h,o,e)}return e}function S(h,t){return R(h[0],h[1],t[0],t[1])}function P(h,t){let e=h.length;return t<0?h[t+e]:t>=e?h[t-e]:h[t]}function M(h,t,e){let i,s;t<e?(i=t,s=e):(i=e,s=t);let o=Math.ceil(i),n=Math.floor(s);if(o>n){let a=T(h,i),c=T(h,s);return S(a,c)}let r=0;if(i<o){let a=T(h,i),c=P(h,o);r+=S(a,c)}if(n<s){let a=P(h,n),c=T(h,s);r+=S(a,c)}for(let a=o;a<n-1;++a){let c=P(h,a),d=P(h,a+1);r+=S(c,d)}return r}function ut(h,t,e){if(t instanceof w){I(h,t.getCoordinates(),!1,e);return}if(t instanceof U){let i=t.getCoordinates();for(let s=0,o=i.length;s<o;++s)I(h,i[s],!1,e);return}if(t instanceof F){let i=t.getCoordinates();for(let s=0,o=i.length;s<o;++s)I(h,i[s],!0,e);return}if(t instanceof j){let i=t.getCoordinates();for(let s=0,o=i.length;s<o;++s){let n=i[s];for(let r=0,a=n.length;r<a;++r)I(h,n[r],!0,e)}return}if(t instanceof lt){let i=t.getGeometries();for(let s=0;s<i.length;++s)ut(h,i[s],e);return}}var b={index:-1,endIndex:NaN};function Ct(h,t,e,i){let s=h[0],o=h[1],n=1/0,r=-1,a=NaN;for(let l=0;l<t.targets.length;++l){let f=t.targets[l],u=f.coordinates,_=1/0,g;for(let p=0;p<u.length-1;++p){let gt=u[p],mt=u[p+1],E=_t(s,o,gt,mt);E.squaredDistance<_&&(_=E.squaredDistance,g=p+E.along)}_<n&&(n=_,f.ring&&t.targetIndex===l&&(f.endIndex>f.startIndex?g<f.startIndex&&(g+=u.length):f.endIndex<f.startIndex&&g>f.startIndex&&(g-=u.length)),a=g,r=l)}let c=t.targets[r],d=c.ring;if(t.targetIndex===r&&d){let l=T(c.coordinates,a),f=e.getPixelFromCoordinate(l);v(f,t.startPx)>i&&(d=!1)}if(d){let l=c.coordinates,f=l.length,u=c.startIndex,_=a;if(u<_){let g=M(l,u,_);M(l,u,_-f)<g&&(a-=f)}else{let g=M(l,u,_);M(l,u,_+f)<g&&(a+=f)}}return b.index=r,b.endIndex=a,b}function I(h,t,e,i){let s=h[0],o=h[1];for(let n=0,r=t.length-1;n<r;++n){let a=t[n],c=t[n+1],d=_t(s,o,a,c);if(d.squaredDistance===0){let l=n+d.along;i.push({coordinates:t,ring:e,startIndex:l,endIndex:l});return}}}var W={along:0,squaredDistance:0};function _t(h,t,e,i){let s=e[0],o=e[1],n=i[0],r=i[1],a=n-s,c=r-o,d=0,l=s,f=o;return(a!==0||c!==0)&&(d=J(((h-s)*a+(t-o)*c)/(a*a+c*c),0,1),l+=a*d,f+=c*d),W.along=d,W.squaredDistance=Q(R(h,t,l,f),10),W}function T(h,t){let e=h.length,i=Math.floor(t),s=t-i;i>=e?i-=e:i<0&&(i+=e);let o=i+1;o>=e&&(o-=e);let n=h[i],r=n[0],a=n[1],c=h[o],d=c[0]-r,l=c[1]-a;return[r+d*s,a+l*s]}var H=class extends ht{constructor(t){let e=t;e.stopDown||(e.stopDown=K),super(e),this.on,this.once,this.un,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=t.source?t.source:null,this.features_=t.features?t.features:null,this.snapTolerance_=t.snapTolerance?t.snapTolerance:12,this.type_=t.type,this.mode_=kt(this.type_),this.stopClick_=!!t.stopClick,this.minPoints_=t.minPoints?t.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:t.maxPoints?t.maxPoints:1/0,this.finishCondition_=t.finishCondition?t.finishCondition:X,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY";let i=t.geometryFunction;if(!i){let s=this.mode_;if(s==="Circle")i=(o,n,r)=>{let a=n||new V([NaN,NaN]),c=C(o[0],r),d=N(c,C(o[o.length-1],r));a.setCenterAndRadius(c,Math.sqrt(d),this.geometryLayout_);let l=x();return l&&a.transform(r,l),a};else{let o;s==="Point"?o=D:s==="LineString"?o=w:s==="Polygon"&&(o=F),i=(n,r,a)=>(r?s==="Polygon"?n[0].length?r.setCoordinates([n[0].concat([n[0][0]])],this.geometryLayout_):r.setCoordinates([],this.geometryLayout_):r.setCoordinates(n,this.geometryLayout_):r=new o(n,this.geometryLayout_),r)}}this.geometryFunction_=i,this.dragVertexDelay_=t.dragVertexDelay!==void 0?t.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=t.clickTolerance?t.clickTolerance*t.clickTolerance:36,this.overlay_=new ct({source:new ft({useSpatialIndex:!1,wrapX:t.wrapX?t.wrapX:!1}),style:t.style?t.style:yt(),updateWhileInteracting:!0}),this.geometryName_=t.geometryName,this.condition_=t.condition?t.condition:ot,this.freehandCondition_,t.freehand?this.freehandCondition_=q:this.freehandCondition_=t.freehandCondition?t.freehandCondition:rt,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSource_=t.traceSource||t.source||null,this.addChangeListener(st.ACTIVE,this.updateState_)}setTrace(t){let e;t?t===!0?e=q:e=t:e=nt,this.traceCondition_=e}setMap(t){super.setMap(t),this.updateState_()}getOverlay(){return this.overlay_}handleEvent(t){t.originalEvent.type===B.CONTEXTMENU&&t.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(t);let e=t.type===m.POINTERMOVE,i=!0;return!this.freehand_&&this.lastDragTime_&&t.type===m.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=t.pixel,this.shouldHandle_=!this.freehand_,e=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&t.type===m.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(t.coordinate),i=!1):this.freehand_&&t.type===m.POINTERDOWN?i=!1:e&&this.getPointerCount()<2?(i=t.type===m.POINTERMOVE,i&&this.freehand_?(this.handlePointerMove_(t),this.shouldHandle_&&t.originalEvent.preventDefault()):(t.originalEvent.pointerType==="mouse"||t.type===m.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(t)):t.type===m.DBLCLICK&&(i=!1),super.handleEvent(t)&&i}handleDownEvent(t){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=t.pixel,this.finishCoordinate_||this.startDrawing_(t.coordinate),!0):this.condition_(t)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new z(m.POINTERMOVE,t.map,t.originalEvent,!1,t.frameState))},this.dragVertexDelay_),this.downPx_=t.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_();return}let e=this.getMap(),i=e.getCoordinateFromPixel([t.pixel[0]-this.snapTolerance_,t.pixel[1]+this.snapTolerance_]),s=e.getCoordinateFromPixel([t.pixel[0]+this.snapTolerance_,t.pixel[1]-this.snapTolerance_]),o=G([i,s]),n=this.traceSource_.getFeaturesInExtent(o);if(n.length===0)return;let r=pt(t.coordinate,n);r.length&&(this.traceState_={active:!0,startPx:t.pixel.slice(),targets:r,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,e){let i=t.startIndex<=t.endIndex,s=t.startIndex<=e;i===s?i&&e>t.endIndex||!i&&e<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,e):(i&&e<t.endIndex||!i&&e>t.endIndex)&&this.removeTracedCoordinates_(e,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,e))}removeTracedCoordinates_(t,e){if(t===e)return;let i=0;if(t<e){let s=Math.ceil(t),o=Math.floor(e);o===e&&(o-=1),i=o-s+1}else{let s=Math.floor(t),o=Math.ceil(e);o===e&&(o+=1),i=s-o+1}i>0&&this.removeLastPoints_(i)}addTracedCoordinates_(t,e,i){if(e===i)return;let s=[];if(e<i){let o=Math.ceil(e),n=Math.floor(i);n===i&&(n-=1);for(let r=o;r<=n;++r)s.push(P(t.coordinates,r))}else{let o=Math.floor(e),n=Math.ceil(i);n===i&&(n+=1);for(let r=o;r>=n;--r)s.push(P(t.coordinates,r))}s.length&&this.appendCoordinates(s)}updateTrace_(t){let e=this.traceState_;if(!e.active||e.targetIndex===-1&&v(e.startPx,t.pixel)<this.snapTolerance_)return;let i=Ct(t.coordinate,e,this.getMap(),this.snapTolerance_);if(e.targetIndex!==i.index){if(e.targetIndex!==-1){let a=e.targets[e.targetIndex];this.removeTracedCoordinates_(a.startIndex,a.endIndex)}let r=e.targets[i.index];this.addTracedCoordinates_(r,r.startIndex,i.endIndex)}else{let r=e.targets[e.targetIndex];this.addOrRemoveTracedCoordinates_(r,i.endIndex)}e.targetIndex=i.index;let s=e.targets[e.targetIndex];s.endIndex=i.endIndex;let o=T(s.coordinates,s.endIndex),n=this.getMap().getPixelFromCoordinate(o);t.coordinate=o,t.pixel=[Math.round(n[0]),Math.round(n[1])]}handleUpEvent(t){let e=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(t);let i=this.traceState_.active;if(this.toggleTraceState_(t),this.shouldHandle_){let s=!this.finishCoordinate_;s&&this.startDrawing_(t.coordinate),!s&&this.freehand_?this.finishDrawing():!this.freehand_&&(!s||this.mode_==="Point")&&(this.atFinish_(t.pixel,i)?this.finishCondition_(t)&&this.finishDrawing():this.addToDrawing_(t.coordinate)),e=!1}else this.freehand_&&this.abortDrawing()}return!e&&this.stopClick_&&t.preventDefault(),e}handlePointerMove_(t){if(this.pointerType_=t.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){let e=this.downPx_,i=t.pixel,s=e[0]-i[0],o=e[1]-i[1],n=s*s+o*o;if(this.shouldHandle_=this.freehand_?n>this.squaredClickTolerance_:n<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(t.coordinate.slice());return}this.updateTrace_(t),this.modifyDrawing_(t.coordinate)}atFinish_(t,e){let i=!1;if(this.sketchFeature_){let s=!1,o=[this.finishCoordinate_],n=this.mode_;if(n==="Point")i=!0;else if(n==="Circle")i=this.sketchCoords_.length===2;else if(n==="LineString")s=!e&&this.sketchCoords_.length>this.minPoints_;else if(n==="Polygon"){let r=this.sketchCoords_;s=r[0].length>this.minPoints_,o=[r[0][0],r[0][r[0].length-2]],e?o=[r[0][0]]:o=[r[0][0],r[0][r[0].length-2]]}if(s){let r=this.getMap();for(let a=0,c=o.length;a<c;a++){let d=o[a],l=r.getPixelFromCoordinate(d),f=t[0]-l[0],u=t[1]-l[1],_=this.freehand_?1:this.snapTolerance_;if(i=Math.sqrt(f*f+u*u)<=_,i){this.finishCoordinate_=d;break}}}}return i}createOrUpdateSketchPoint_(t){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(t):(this.sketchPoint_=new y(new D(t)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(t){this.sketchLine_||(this.sketchLine_=new y);let e=t.getLinearRing(0),i=this.sketchLine_.getGeometry();i?(i.setFlatCoordinates(e.getLayout(),e.getFlatCoordinates()),i.changed()):(i=new w(e.getFlatCoordinates(),e.getLayout()),this.sketchLine_.setGeometry(i))}startDrawing_(t){let e=this.getMap().getView().getProjection(),i=A(this.geometryLayout_);for(;t.length<i;)t.push(0);this.finishCoordinate_=t,this.mode_==="Point"?this.sketchCoords_=t.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[t.slice(),t.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[t.slice(),t.slice()],this.sketchLineCoords_&&(this.sketchLine_=new y(new w(this.sketchLineCoords_)));let s=this.geometryFunction_(this.sketchCoords_,void 0,e);this.sketchFeature_=new y,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(s),this.updateSketchFeatures_(),this.dispatchEvent(new k(L.DRAWSTART,this.sketchFeature_))}modifyDrawing_(t){let e=this.getMap(),i=this.sketchFeature_.getGeometry(),s=e.getView().getProjection(),o=A(this.geometryLayout_),n,r;for(;t.length<o;)t.push(0);this.mode_==="Point"?r=this.sketchCoords_:this.mode_==="Polygon"?(n=this.sketchCoords_[0],r=n[n.length-1],this.atFinish_(e.getPixelFromCoordinate(t))&&(t=this.finishCoordinate_.slice())):(n=this.sketchCoords_,r=n[n.length-1]),r[0]=t[0],r[1]=t[1],this.geometryFunction_(this.sketchCoords_,i,s),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(t),i.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(i):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(t){let e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection(),s,o,n=this.mode_;return n==="LineString"||n==="Circle"?(this.finishCoordinate_=t.slice(),o=this.sketchCoords_,o.length>=this.maxPoints_&&(this.freehand_?o.pop():s=!0),o.push(t.slice()),this.geometryFunction_(o,e,i)):n==="Polygon"&&(o=this.sketchCoords_[0],o.length>=this.maxPoints_&&(this.freehand_?o.pop():s=!0),o.push(t.slice()),s&&(this.finishCoordinate_=o[0]),this.geometryFunction_(this.sketchCoords_,e,i)),this.createOrUpdateSketchPoint_(t.slice()),this.updateSketchFeatures_(),s?this.finishDrawing():this.sketchFeature_}removeLastPoints_(t){if(!this.sketchFeature_)return;let e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection(),s=this.mode_;for(let o=0;o<t;++o){let n;if(s==="LineString"||s==="Circle"){if(n=this.sketchCoords_,n.splice(-2,1),n.length>=2){this.finishCoordinate_=n[n.length-2].slice();let r=this.finishCoordinate_.slice();n[n.length-1]=r,this.createOrUpdateSketchPoint_(r)}this.geometryFunction_(n,e,i),e.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(e)}else if(s==="Polygon"){n=this.sketchCoords_[0],n.splice(-2,1);let r=this.sketchLine_.getGeometry();if(n.length>=2){let a=n[n.length-2].slice();n[n.length-1]=a,this.createOrUpdateSketchPoint_(a)}r.setCoordinates(n),this.geometryFunction_(this.sketchCoords_,e,i)}if(n.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){let t=this.abortDrawing_();if(!t)return null;let e=this.sketchCoords_,i=t.getGeometry(),s=this.getMap().getView().getProjection();return this.mode_==="LineString"?(e.pop(),this.geometryFunction_(e,i,s)):this.mode_==="Polygon"&&(e[0].pop(),this.geometryFunction_(e,i,s),e=i.getCoordinates()),this.type_==="MultiPoint"?t.setGeometry(new dt([e])):this.type_==="MultiLineString"?t.setGeometry(new U([e])):this.type_==="MultiPolygon"&&t.setGeometry(new j([e])),this.dispatchEvent(new k(L.DRAWEND,t)),this.features_&&this.features_.push(t),this.source_&&this.source_.addFeature(t),t}abortDrawing_(){this.finishCoordinate_=null;let t=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),t}abortDrawing(){let t=this.abortDrawing_();t&&this.dispatchEvent(new k(L.DRAWABORT,t))}appendCoordinates(t){let e=this.mode_,i=!this.sketchFeature_;i&&this.startDrawing_(t[0]);let s;if(e==="LineString"||e==="Circle")s=this.sketchCoords_;else if(e==="Polygon")s=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;i&&s.shift(),s.pop();for(let n=0;n<t.length;n++)this.addToDrawing_(t[n]);let o=t[t.length-1];this.sketchFeature_=this.addToDrawing_(o),this.modifyDrawing_(o)}extend(t){let i=t.getGeometry();this.sketchFeature_=t,this.sketchCoords_=i.getCoordinates();let s=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=s.slice(),this.sketchCoords_.push(s.slice()),this.sketchPoint_=new y(new D(s)),this.updateSketchFeatures_(),this.dispatchEvent(new k(L.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){let t=[];this.sketchFeature_&&t.push(this.sketchFeature_),this.sketchLine_&&t.push(this.sketchLine_),this.sketchPoint_&&t.push(this.sketchPoint_);let e=this.overlay_.getSource();e.clear(!0),e.addFeatures(t)}updateState_(){let t=this.getMap(),e=this.getActive();(!t||!e)&&this.abortDrawing(),this.overlay_.setMap(e?t:null)}};function yt(){let h=at();return function(t,e){return h[t.getGeometry().getType()]}}function Xt(h,t){return function(e,i,s){let o=C(e[0],s),n=C(e[e.length-1],s),r=Math.sqrt(N(o,n));i=i||et(new V(o),h);let a=t;if(!t&&t!==0){let d=n[0]-o[0],l=n[1]-o[1];a=Math.atan2(l,d)}it(i,o,r,a);let c=x();return c&&i.transform(s,c),i}}function Kt(){return function(h,t,e){let i=G([h[0],h[h.length-1]].map(function(n){return C(n,e)})),s=[[O(i),Z(i),tt(i),$(i),O(i)]];t?t.setCoordinates(s):t=new F(s);let o=x();return o&&t.transform(e,o),t}}function kt(h){switch(h){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+h)}}var Yt=H;export{Xt as a,Kt as b,Yt as c};
