import{b as re,c as ne,d as ie,e as se,f as oe,g as I,h as ae,i as ce}from"./chunk-25A3ZCYP.js";import{c as de,d as H,e as he,f as U}from"./chunk-U2ZJQPIO.js";import{M as L,Ta as Z,Tc as X,Ua as $,Uc as te,i as Q,oc as ee,ub as P,z as Y}from"./chunk-SFR7ATWH.js";import{D as N,E as J,F as K,v as k,z as O}from"./chunk-OAKYQQNU.js";import{B as S,F as v,G as V,M as q,c as B,g as T,j,pa as z}from"./chunk-GF377ULF.js";var b=class extends te{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipped_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=j(),this.wrappedRenderedExtent_=j(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(e,t,r){let a=t.extent,n=t.viewState,g=n.center,c=n.resolution,d=n.projection,s=n.rotation,i=d.getExtent(),l=this.getLayer().getSource(),u=this.getLayer().getDeclutter(),R=t.pixelRatio,f=t.viewHints,y=!(f[L.ANIMATING]||f[L.INTERACTING]),h=this.context,_=Math.round(v(a)/c*R),E=Math.round(S(a)/c*R),x=l.getWrapX()&&d.canWrapX(),m=x?v(i):null,F=x?Math.ceil((a[2]-i[2])/m)+1:1,C=x?Math.floor((a[0]-i[0])/m):0;do{let D=this.getRenderTransform(g,c,0,R,_,E,C*m);t.declutter&&(D=D.slice(0)),e.execute(h,[h.canvas.width,h.canvas.height],D,s,y,r===void 0?ne:r?ie:se,r?u&&t.declutter[u]:void 0)}while(++C<F)}setDrawContext_(){this.opacity_!==1&&(this.targetContext_=this.context,this.context=Z(this.context.canvas.width,this.context.canvas.height,X))}resetDrawContext_(){if(this.opacity_!==1&&this.targetContext_){let e=this.targetContext_.globalAlpha;this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=e,$(this.context),X.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null}}renderDeclutter(e){!this.replayGroup_||!this.getLayer().getDeclutter()||this.renderWorlds(this.replayGroup_,e,!0)}renderDeferredInternal(e){this.replayGroup_&&(this.replayGroup_.renderDeferred(),this.clipped_&&this.context.restore(),this.resetDrawContext_())}renderFrame(e,t){let r=e.layerStatesArray[e.layerIndex];this.opacity_=r.opacity;let a=e.viewState;this.prepareContainer(e,t);let n=this.context,g=this.replayGroup_,c=g&&!g.isEmpty();if(!c&&!(this.getLayer().hasListener(P.PRERENDER)||this.getLayer().hasListener(P.POSTRENDER)))return this.container;this.setDrawContext_(),this.preRender(n,e);let d=a.projection;if(this.clipped_=!1,c&&r.extent&&this.clipping){let s=J(r.extent,d);c=V(s,e.extent),this.clipped_=c&&!T(s,e.extent),this.clipped_&&this.clipUnrotated(n,e,s)}return c&&this.renderWorlds(g,e,this.getLayer().getDeclutter()?!1:void 0),!e.declutter&&this.clipped_&&n.restore(),this.postRender(n,e),this.renderedRotation_!==a.rotation&&(this.renderedRotation_=a.rotation,this.hitDetectionImageData_=null),e.declutter||this.resetDrawContext_(),this.container}getFeatures(e){return new Promise(t=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){let r=this.frameState.size.slice(),a=this.renderedCenter_,n=this.renderedResolution_,g=this.renderedRotation_,c=this.renderedProjection_,d=this.wrappedRenderedExtent_,s=this.getLayer(),i=[],l=r[0]*I,u=r[1]*I;i.push(this.getRenderTransform(a,n,g,I,l,u,0).slice());let R=s.getSource(),f=c.getExtent();if(R.getWrapX()&&c.canWrapX()&&!T(f,d)){let h=d[0],_=v(f),E=0,x;for(;h<f[0];)--E,x=_*E,i.push(this.getRenderTransform(a,n,g,I,l,u,x).slice()),h+=_;for(E=0,h=d[2];h>f[2];)++E,x=_*E,i.push(this.getRenderTransform(a,n,g,I,l,u,x).slice()),h-=_}let y=O();this.hitDetectionImageData_=ae(r,i,this.renderedFeatures_,s.getStyleFunction(),d,n,g,H(n,this.renderedPixelRatio_),y?c:null)}t(ce(e,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(e,t,r,a,n){if(!this.replayGroup_)return;let g=t.viewState.resolution,c=t.viewState.rotation,d=this.getLayer(),s={},i=function(u,R,f){let y=Y(u),h=s[y];if(h){if(h!==!0&&f<h.distanceSq){if(f===0)return s[y]=!0,n.splice(n.lastIndexOf(h),1),a(u,d,R);h.geometry=R,h.distanceSq=f}}else{if(f===0)return s[y]=!0,a(u,d,R);n.push(s[y]={feature:u,layer:d,geometry:R,distanceSq:f,callback:a})}},l=this.getLayer().getDeclutter();return this.replayGroup_.forEachFeatureAtCoordinate(e,g,c,r,i,l?t.declutter?.[l]?.all().map(u=>u.value):null)}handleFontsChanged(){let e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){let t=this.getLayer(),r=t.getSource();if(!r)return!1;let a=e.viewHints[L.ANIMATING],n=e.viewHints[L.INTERACTING],g=t.getUpdateWhileAnimating(),c=t.getUpdateWhileInteracting();if(this.ready&&!g&&a||!c&&n)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;let d=e.extent,s=e.viewState,i=s.projection,l=s.resolution,u=e.pixelRatio,R=t.getRevision(),f=t.getRenderBuffer(),y=t.getRenderOrder();y===void 0&&(y=de);let h=s.center.slice(),_=B(d,f*l),E=_.slice(),x=[_.slice()],m=i.getExtent();if(r.getWrapX()&&i.canWrapX()&&!T(m,e.extent)){let o=v(m),w=Math.max(v(_)/2,o);_[0]=m[0]-w,_[2]=m[2]+w,z(h,i);let p=q(x[0],i);p[0]<m[0]&&p[2]<m[2]?x.push([p[0]+o,p[1],p[2]+o,p[3]]):p[0]>m[0]&&p[2]>m[2]&&x.push([p[0]-o,p[1],p[2]-o,p[3]])}if(this.ready&&this.renderedResolution_==l&&this.renderedRevision_==R&&this.renderedRenderOrder_==y&&this.renderedFrameDeclutter_===!!e.declutter&&T(this.wrappedRenderedExtent_,_))return Q(this.renderedExtent_,E)||(this.hitDetectionImageData_=null,this.renderedExtent_=E),this.renderedCenter_=h,this.replayGroupChanged=!1,!0;this.replayGroup_=null;let F=new re(he(l,u),_,l,u),C=O(),D;if(C){for(let o=0,w=x.length;o<w;++o){let p=x[o],W=N(p,i);r.loadFeatures(W,K(l,i),C)}D=k(C,i)}else for(let o=0,w=x.length;o<w;++o)r.loadFeatures(x[o],l,i);let pe=H(l,u),A=!0,ge=(o,w)=>{let p,W=o.getStyleFunction()||t.getStyleFunction();if(W&&(p=W(o,l)),p){let ye=this.renderFeature(o,pe,p,F,D,this.getLayer().getDeclutter(),w);A=A&&!ye}},_e=N(_,i),G=r.getFeaturesInExtent(_e);y&&G.sort(y);for(let o=0,w=G.length;o<w;++o)ge(G[o],o);this.renderedFeatures_=G,this.ready=A;let xe=F.finish(),fe=new oe(_,l,u,r.getOverlaps(),xe,t.getRenderBuffer(),!!e.declutter);return this.renderedResolution_=l,this.renderedRevision_=R,this.renderedRenderOrder_=y,this.renderedFrameDeclutter_=!!e.declutter,this.renderedExtent_=E,this.wrappedRenderedExtent_=_,this.renderedCenter_=h,this.renderedProjection_=i,this.renderedPixelRatio_=u,this.replayGroup_=fe,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,r,a,n,g,c){if(!r)return!1;let d=!1;if(Array.isArray(r))for(let s=0,i=r.length;s<i;++s)d=U(a,e,r[s],t,this.boundHandleStyleImageChange_,n,g,c)||d;else d=U(a,e,r,t,this.boundHandleStyleImageChange_,n,g,c);return d}},le=b;var M=class extends ee{constructor(e){super(e)}createRenderer(){return new le(this)}},Ne=M;export{le as a,Ne as b};
