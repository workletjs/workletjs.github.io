import{a as L,b as Z}from"./chunk-2545NAN7.js";import{Ba as G,Na as W,a as b,k as H,l as Y,nb as X,q as z,s as S,u as D,w as U,z as M}from"./chunk-7GOL55Z2.js";import{B as J,C as j,D as Q,z as w}from"./chunk-XGVPHTK5.js";import{G as q,b as T,c as K,ca as V,da as k,j as O,ka as A}from"./chunk-GF377ULF.js";var R={SNAP:"snap",UNSNAP:"unsnap"},C=class extends z{constructor(e,t){super(e),this.vertex=t.vertex,this.vertexPixel=t.vertexPixel,this.feature=t.feature,this.segment=t.segment}};var I={Circle(i,e){let t=i,n=w();n&&(t=t.clone().transform(n,e));let s=W(t);return n&&s.transform(e,n),I.Polygon(s)},GeometryCollection(i,e){let t=[],n=i.getGeometriesArray();for(let s=0;s<n.length;++s){let o=I[n[s].getType()];o&&t.push(o(n[s],e))}return t.flat()},LineString(i){let e=[],t=i.getFlatCoordinates(),n=i.getStride();for(let s=0,o=t.length-n;s<o;s+=n)e.push([t.slice(s,s+2),t.slice(s+n,s+n+2)]);return e},MultiLineString(i){let e=[],t=i.getFlatCoordinates(),n=i.getStride(),s=i.getEnds(),o=0;for(let c=0,u=s.length;c<u;++c){let r=s[c];for(let a=o,h=r-n;a<h;a+=n)e.push([t.slice(a,a+2),t.slice(a+n,a+n+2)]);o=r}return e},MultiPoint(i){let e=[],t=i.getFlatCoordinates(),n=i.getStride();for(let s=0,o=t.length;s<o;s+=n)e.push([t.slice(s,s+2)]);return e},MultiPolygon(i){let e=[],t=i.getFlatCoordinates(),n=i.getStride(),s=i.getEndss(),o=0;for(let c=0,u=s.length;c<u;++c){let r=s[c];for(let a=0,h=r.length;a<h;++a){let E=r[a];for(let d=o,l=E-n;d<l;d+=n)e.push([t.slice(d,d+2),t.slice(d+n,d+n+2)]);o=E}}return e},Point(i){return[[i.getFlatCoordinates().slice(0,2)]]},Polygon(i){let e=[],t=i.getFlatCoordinates(),n=i.getStride(),s=i.getEnds(),o=0;for(let c=0,u=s.length;c<u;++c){let r=s[c];for(let a=o,h=r-n;a<h;a+=n)e.push([t.slice(a,a+2),t.slice(a+n,a+n+2)]);o=r}return e}};function $(i){return i.feature?i.feature:i.element?i.element:null}var B=[],x=[],P=[],N=class extends X{constructor(e){e=e||{};let t=e;t.handleDownEvent||(t.handleDownEvent=H),t.stopDown||(t.stopDown=Y),super(t),this.on,this.once,this.un,this.source_=e.source?e.source:null,this.vertex_=e.vertex!==void 0?e.vertex:!0,this.edge_=e.edge!==void 0?e.edge:!0,this.intersection_=e.intersection!==void 0?e.intersection:!1,this.features_=e.features?e.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.rBush_=new Z,this.snapped_=null,this.segmenters_=Object.assign({},I,e.segmenters)}addFeature(e,t){t=t!==void 0?t:!0;let n=M(e),s=e.getGeometry();if(s){let o=this.segmenters_[s.getType()];if(o){this.indexedFeaturesExtents_[n]=s.getExtent(O());let c=o(s,this.getMap().getView().getProjection()),u=c.length;for(let r=0;r<u;++r){let a=c[r];x[r]=T(a),P[r]={feature:e,segment:a}}if(x.length=u,P.length=u,this.intersection_)for(let r=0,a=c.length;r<a;++r){let h=c[r];if(h.length===1)continue;let E=x[r];for(let l=0,y=c.length;l<y;++l){if(r===l||r-1===l||r+1===l)continue;let v=c[l];if(!q(E,x[l]))continue;let f=G(h,v);if(!f)continue;let g=[f];x[u]=T(g),P[u++]={feature:e,segment:g,isIntersection:!0}}let d=this.rBush_.getInExtent(x[r]);for(let{segment:l}of d){if(l.length===1)continue;let y=G(h,l);if(!y)continue;let v=[y];x[u]=T(v),P[u++]={feature:e,segment:v,isIntersection:!0}}}u===1?this.rBush_.insert(x[0],P[0]):this.rBush_.load(x,P)}}t&&(this.featureChangeListenerKeys_[n]=S(e,b.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e}areSnapDataEqual_(e,t){return e.segment===t.segment&&e.feature===t.feature}handleEvent(e){let t=this.snapTo(e.pixel,e.coordinate,e.map);return t?(e.coordinate=t.vertex.slice(0,2),e.pixel=t.vertexPixel,this.snapped_&&!this.areSnapDataEqual_(this.snapped_,t)&&this.dispatchEvent(new C(R.UNSNAP,this.snapped_)),this.snapped_={vertex:e.coordinate,vertexPixel:e.pixel,feature:t.feature,segment:t.segment},this.dispatchEvent(new C(R.SNAP,this.snapped_))):this.snapped_&&(this.dispatchEvent(new C(R.UNSNAP,this.snapped_)),this.snapped_=null),super.handleEvent(e)}handleFeatureAdd_(e){let t=$(e);t&&this.addFeature(t)}handleFeatureRemove_(e){let t=$(e);t&&this.removeFeature(t)}handleFeatureChange_(e){let t=e.target;if(this.handlingDownUpSequence){let n=M(t);n in this.pendingFeatures_||(this.pendingFeatures_[n]=t)}else this.updateFeature_(t)}handleUpEvent(e){let t=Object.values(this.pendingFeatures_);if(t.length)for(let n of t)this.updateFeature_(n);return!1}removeFeature(e,t){let n=t!==void 0?t:!0,s=M(e),o=this.indexedFeaturesExtents_[s];if(o){let c=this.rBush_,u=[];c.forEachInExtent(o,function(r){e===r.feature&&u.push(r)});for(let r=u.length-1;r>=0;--r)c.remove(u[r])}n&&(D(this.featureChangeListenerKeys_[s]),delete this.featureChangeListenerKeys_[s])}setMap(e){let t=this.getMap(),n=this.featuresListenerKeys_,s=this.getFeatures_();if(Array.isArray(s)||(s=s.getArray()),t&&(n.forEach(D),n.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(D),this.featureChangeListenerKeys_={}),super.setMap(e),e){this.features_?n.push(S(this.features_,U.ADD,this.handleFeatureAdd_,this),S(this.features_,U.REMOVE,this.handleFeatureRemove_,this)):this.source_&&n.push(S(this.source_,L.ADDFEATURE,this.handleFeatureAdd_,this),S(this.source_,L.REMOVEFEATURE,this.handleFeatureRemove_,this));for(let o of s)this.addFeature(o)}}snapTo(e,t,n){let s=n.getView().getProjection(),o=j(t,s),c=Q(K(T([o]),n.getView().getResolution()*this.pixelTolerance_),s),u=this.rBush_.getInExtent(c),r=u.length;if(r===0)return null;let a,h=1/0,E,d=null,l,y=this.pixelTolerance_*this.pixelTolerance_,v=()=>{if(a){let f=n.getPixelFromCoordinate(a);if(A(e,f)<=y&&(l&&this.intersection_||!l&&(this.vertex_||this.edge_)))return{vertex:a,vertexPixel:[Math.round(f[0]),Math.round(f[1])],feature:E,segment:d}}return null};if(this.vertex_||this.intersection_){for(let g=0;g<r;++g){let m=u[g];if(m.feature.getGeometry().getType()!=="Circle")for(let _ of m.segment){let p=j(_,s),F=A(o,p);F<h&&(a=_,h=F,E=m.feature,l=m.isIntersection)}}let f=v();if(f)return f}if(this.edge_){for(let g=0;g<r;++g){let m=null,_=u[g];if(_.feature.getGeometry().getType()==="Circle"){let p=_.feature.getGeometry(),F=w();F&&(p=p.clone().transform(F,s)),m=V(o,p)}else{let[p,F]=_.segment;F&&(B[0]=j(p,s),B[1]=j(F,s),m=k(o,B))}if(m){let p=A(o,m);p<h&&(a=J(m,s),d=_.feature.getGeometry().getType()==="Circle"?null:_.segment,h=p,E=_.feature)}}let f=v();if(f)return f}return null}updateFeature_(e){this.removeFeature(e,!1),this.addFeature(e,!1)}},pe=N;export{pe as a};
