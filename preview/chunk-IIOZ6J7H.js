import{a as c}from"./chunk-YAMZ47O7.js";import{a as S,c as v}from"./chunk-5S72BYCV.js";import{f as C,g as y,i as D}from"./chunk-NXY6UXD3.js";import{F as h,Xb as x,a as g,ic as R,kc as L,s as E}from"./chunk-ZLVEVZO2.js";import{m as u,v as T}from"./chunk-AKEHF7AE.js";import{G as f,L as p}from"./chunk-O23OEJHM.js";var _=class extends x{constructor(t,e,i,r,s,n){super(t,e),this.src_=i,this.extent_=r,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=n}getImage(){return null}getData(t){if(!this.grid_||!this.keys_)return null;let e=(t[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),i=(t[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),r=this.grid_[Math.floor((1-i)*this.grid_.length)];if(typeof r!="string")return null;let s=r.charCodeAt(Math.floor(e*r.length));s>=93&&s--,s>=35&&s--,s-=32;let n=null;if(s in this.keys_){let o=this.keys_[s];this.data_&&o in this.data_?n=this.data_[o]:n=o}return n}forDataAtCoordinate(t,e,i){this.state==h.EMPTY&&i===!0?(this.state=h.IDLE,E(this,g.CHANGE,r=>{e(this.getData(t))}),this.loadInternal_()):i===!0?setTimeout(()=>{e(this.getData(t))},0):e(this.getData(t))}getKey(){return this.src_}handleError_(){this.state=h.ERROR,this.changed()}handleLoad_(t){this.grid_=t.grid,this.keys_=t.keys,this.data_=t.data,this.state=h.LOADED,this.changed()}loadInternal_(){if(this.state==h.IDLE)if(this.state=h.LOADING,this.jsonp_)c(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{let t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",this.src_),t.send()}}onXHRLoad_(t){let e=t.target;if(!e.status||e.status>=200&&e.status<300){let i;try{i=JSON.parse(e.responseText)}catch{this.handleError_();return}this.handleLoad_(i)}else this.handleError_()}onXHRError_(t){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(h.EMPTY)}},m=class extends D{constructor(t){if(super({projection:u("EPSG:3857"),state:"loading",wrapX:t.wrapX!==void 0?t.wrapX:!0,zDirection:t.zDirection}),this.preemptive_=t.preemptive!==void 0?t.preemptive:!0,this.tileUrlFunction_=v,this.template_=void 0,this.jsonp_=t.jsonp||!1,this.tileCache_=new R(512),t.url)if(this.jsonp_)c(t.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{let e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",t.url),e.send()}else if(t.tileJSON)this.handleTileJSONResponse(t.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(t){let e=t.target;if(!e.status||e.status>=200&&e.status<300){let i;try{i=JSON.parse(e.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(i)}else this.handleTileJSONError()}onXHRError_(t){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(t,e,i,r){if(this.tileGrid){let s=this.tileGrid.getZForResolution(e,this.zDirection),n=this.tileGrid.getTileCoordForCoordAndZ(t,s),o=this.getTile(n[0],n[1],n[2],1,this.getProjection());o.getState()==h.IDLE&&o.load(),o.forDataAtCoordinate(t,i,r)}else r===!0?setTimeout(function(){i(null)},0):i(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(t){let e=u("EPSG:4326"),i=this.getProjection(),r;if(t.bounds!==void 0){let d=T(e,i);r=p(t.bounds,d)}let s=y(i),n=t.minzoom||0,o=t.maxzoom||22,l=C({extent:s,maxZoom:o,minZoom:n});this.tileGrid=l,this.template_=t.template;let a=t.grids;if(!a){this.setState("error");return}if(this.tileUrlFunction_=S(a,l),t.attribution){let d=r!==void 0?r:s;this.setAttributions(function(P){return f(d,P.extent)?[t.attribution]:null})}this.setState("ready")}getTile(t,e,i,r,s){let n=[t,e,i],o=this.getTileCoordForTileUrlFunction(n,s),l=this.tileUrlFunction_(o,r,s),a=`${this.getKey()},${L(t,e,i)}`;if(this.tileCache_.containsKey(a))return this.tileCache_.get(a);this.tileCache_.expireCache();let d=new _(n,l!==void 0?h.IDLE:h.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(n),this.preemptive_,this.jsonp_);return this.tileCache_.set(a,d),d}},M=m;export{M as a};
