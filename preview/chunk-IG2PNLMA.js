import{b}from"./chunk-T56JYQ2Z.js";import{f as d,g as f}from"./chunk-EJ4NICUA.js";import{M as y}from"./chunk-HGXUMOE5.js";import{t as p}from"./chunk-L76X3E7P.js";import{E as T,v as w}from"./chunk-WEL5MCWD.js";import{j as u}from"./chunk-TWZW5B45.js";var S=22,_=class extends b{constructor(t){let s=!!t.highDpi;super({attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:"anonymous",interpolate:t.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:"loading",tileLoadFunction:t.tileLoadFunction,tilePixelRatio:s?2:1,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.apiKey_=t.key,this.error_=null;let e={mapType:t.mapType||"roadmap",language:t.language||"en-US",region:t.region||"US"};t.imageFormat&&(e.imageFormat=t.imageFormat),t.scale&&(e.scale=t.scale),s&&(e.highDpi=!0),t.layerTypes&&(e.layerTypes=t.layerTypes),t.styles&&(e.styles=t.styles),t.overlay===!0&&(e.overlay=!0),t.apiOptions&&(e.apiOptions=t.apiOptions),this.sessionTokenRequest_=e,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_;let i=t.url||"https://tile.googleapis.com/";this.createSessionUrl_=i+"v1/createSession",this.tileUrl_=i+"v1/2dtiles",this.attributionUrl_=i+"tile/v1/viewport",this.createSession_()}getError(){return this.error_}fetchSessionToken(t,s){return fetch(t,s)}createSession_(){return u(this,null,function*(){let t=this.createSessionUrl_+"?key="+this.apiKey_,s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},e=yield this.fetchSessionToken(t,s);if(!e.ok){try{let r=yield e.json();this.error_=new Error(r.error.message)}catch(r){this.error_=new Error("Error fetching session token")}this.setState("error");return}let i=yield e.json(),n=this.getTilePixelRatio(1),m=[i.tileWidth/n,i.tileHeight/n];this.tileGrid=d({extent:f(this.getProjection()),maxZoom:S,tileSize:m});let h=i.session;this.sessionTokenValue_=h;let o=this.apiKey_,c=this.tileUrl_;this.tileUrlFunction=function(r,a,R){let v=r[0],x=r[1],k=r[2];return`${c}/${v}/${x}/${k}?session=${h}&key=${o}`};let l=parseInt(i.expiry,10)*1e3,g=Math.max(l-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),g),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")})}fetchAttributions_(t){return u(this,null,function*(){if(t.viewHints[y.ANIMATING]||t.viewHints[y.INTERACTING]||t.animate)return this.previousViewportAttribution_;let[s,e]=p(w(t.extent),t.viewState.projection),[i,n]=p(T(t.extent),t.viewState.projection),o=`zoom=${this.getTileGrid().getZForResolution(t.viewState.resolution,this.zDirection)}&north=${n}&south=${e}&east=${i}&west=${s}`;if(this.previousViewportExtent_==o)return this.previousViewportAttribution_;this.previousViewportExtent_=o;let c=this.sessionTokenValue_,l=this.apiKey_,r=`${this.attributionUrl_}?session=${c}&key=${l}&${o}`;return this.previousViewportAttribution_=yield fetch(r).then(a=>a.json()).then(a=>a.copyright),this.previousViewportAttribution_})}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}},I=_;export{I as a};
