import{I as V,a as x,bb as v,s as m,u as N}from"./chunk-CQBO4I3Y.js";import{i as k}from"./chunk-247T7M3Z.js";function C(a){return k(a,5)}function f(a){return parseFloat(a)}function d(a){return C(a).toString()}function g(a,t){return isNaN(a)?!1:a!==f(d(t))}function P(a,t){return g(a[0],t[0])||g(a[1],t[1])}var w=class extends v{constructor(t){super(),t=Object.assign({animate:!0,params:["x","y","z","r","l"],replace:!1,prefix:""},t||{});let e;t.animate===!0?e={duration:250}:t.animate?e=t.animate:e=null,this.animationOptions_=e,this.params_=t.params.reduce((i,s)=>(i[s]=!0,i),{}),this.replace_=t.replace,this.prefix_=t.prefix,this.listenerKeys_=[],this.initial_=!0,this.updateState_=this.updateState_.bind(this),this.trackedCallbacks_={},this.trackedValues_={}}getParamName_(t){return this.prefix_?this.prefix_+t:t}get_(t,e){return t.get(this.getParamName_(e))}set_(t,e,i){e in this.params_&&t.set(this.getParamName_(e),i)}delete_(t,e){e in this.params_&&t.delete(this.getParamName_(e))}setMap(t){let e=this.getMap();super.setMap(t),t!==e&&(e&&this.unregisterListeners_(e),t&&(this.initial_=!0,this.updateState_(),this.registerListeners_(t)))}registerListeners_(t){this.listenerKeys_.push(m(t,V.MOVEEND,this.updateUrl_,this),m(t.getLayerGroup(),x.CHANGE,this.updateUrl_,this),m(t,"change:layergroup",this.handleChangeLayerGroup_,this)),this.replace_||addEventListener("popstate",this.updateState_)}unregisterListeners_(t){for(let s=0,n=this.listenerKeys_.length;s<n;++s)N(this.listenerKeys_[s]);this.listenerKeys_.length=0,this.replace_||removeEventListener("popstate",this.updateState_);let e=new URL(window.location.href),i=e.searchParams;this.delete_(i,"x"),this.delete_(i,"y"),this.delete_(i,"z"),this.delete_(i,"r"),this.delete_(i,"l"),window.history.replaceState(null,"",e)}handleChangeLayerGroup_(){let t=this.getMap();t&&(this.unregisterListeners_(t),this.registerListeners_(t),this.initial_=!0,this.updateUrl_())}updateState_(){let e=new URL(window.location.href).searchParams;for(let o in this.trackedCallbacks_){let p=e.get(o);o in this.trackedCallbacks_&&p!==this.trackedValues_[o]&&(this.trackedValues_[o]=p,this.trackedCallbacks_[o](p))}let i=this.getMap();if(!i)return;let s=i.getView();if(!s)return;let n=!1,r={},c=f(this.get_(e,"z"));"z"in this.params_&&g(c,s.getZoom())&&(n=!0,r.zoom=c);let u=f(this.get_(e,"r"));"r"in this.params_&&g(u,s.getRotation())&&(n=!0,r.rotation=u);let l=[f(this.get_(e,"x")),f(this.get_(e,"y"))];("x"in this.params_||"y"in this.params_)&&P(l,s.getCenter())&&(n=!0,r.center=l),n&&(!this.initial_&&this.animationOptions_?s.animate(Object.assign(r,this.animationOptions_)):(r.center&&s.setCenter(r.center),"zoom"in r&&s.setZoom(r.zoom),"rotation"in r&&s.setRotation(r.rotation)));let h=i.getAllLayers(),_=this.get_(e,"l");if("l"in this.params_&&_&&_.length===h.length)for(let o=0,p=h.length;o<p;++o){let y=parseInt(_[o]);if(!isNaN(y)){let L=!!y,b=h[o];b.getVisible()!==L&&b.setVisible(L)}}}track(t,e){this.trackedCallbacks_[t]=e;let n=new URL(window.location.href).searchParams.get(t);return this.trackedValues_[t]=n,n}update(t,e){let i=new URL(window.location.href),s=i.searchParams;e===null?s.delete(t):s.set(t,e),t in this.trackedValues_&&(this.trackedValues_[t]=e),this.updateHistory_(i)}updateUrl_(){let t=this.getMap();if(!t)return;let e=t.getView();if(!e)return;let i=e.getCenter(),s=e.getZoom(),n=e.getRotation(),r=t.getAllLayers(),c=new Array(r.length);for(let h=0,_=r.length;h<_;++h)c[h]=r[h].getVisible()?"1":"0";let u=new URL(window.location.href),l=u.searchParams;this.set_(l,"x",d(i[0])),this.set_(l,"y",d(i[1])),this.set_(l,"z",d(s)),this.set_(l,"r",d(n)),this.set_(l,"l",c.join("")),this.updateHistory_(u),this.initial_=!1}updateHistory_(t){t.href!==window.location.href&&(this.initial_||this.replace_?window.history.replaceState(history.state,"",t):window.history.pushState(null,"",t))}},E=w;export{E as a};
