import{a as Z,d as C,i as m}from"./chunk-2D24CNGB.js";import{A as S,G as _,Va as B,a as E,h as b,k as U,l as G,p as w,qa as q,r as R,t as p,tc as W,v as I,w as L,y as u}from"./chunk-66HUV5TV.js";import{b as g}from"./chunk-3MFB6WMS.js";import{B as y,K as M,_ as P,aa as H,ga as V,p as O,t as X,w as K,x as Y,z as N}from"./chunk-2R667KKY.js";function k(x,e){return[[-1/0,-1/0,1/0,1/0]]}var v=class{constructor(e){this.rbush_=new B(e),this.items_={}}insert(e,t){let s={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(s),this.items_[u(t)]=s}load(e,t){let s=new Array(t.length);for(let r=0,i=t.length;r<i;r++){let n=e[r],a=t[r],o={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3],value:a};s[r]=o,this.items_[u(a)]=o}this.rbush_.load(s)}remove(e){let t=u(e),s=this.items_[t];return delete this.items_[t],this.rbush_.remove(s)!==null}update(e,t){let s=this.items_[u(t)],r=[s.minX,s.minY,s.maxX,s.maxY];y(r,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){let t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(r){return r.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let s;for(let r=0,i=e.length;r<i;r++)if(s=t(e[r]),s)return s;return s}isEmpty(){return g(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){let t=this.rbush_.toJSON();return Y(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(let t in e.items_)this.items_[t]=e.items_[t]}},A=v;var h={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};var d=class extends w{constructor(e,t,s){super(e),this.feature=t,this.features=s}},D=class extends W{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=G,this.format_=e.format||null,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(_(this.format_,"`format` must be set when `url` is set"),this.loader_=C(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:k;let t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new A:null,this.loadedExtentsRtree_=new A,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,r;Array.isArray(e.features)?r=e.features:e.features&&(s=e.features,r=s.getArray()),!t&&s===void 0&&(s=new S(r)),r!==void 0&&this.addFeaturesInternal(r),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){let t=u(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);let s=e.getGeometry();if(s){let r=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(r,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new d(h.ADDFEATURE,e))}setupChangeEvents_(e,t){t instanceof m||(this.featureChangeKeys_[e]=[R(t,E.CHANGE,this.handleFeatureChange_,this),R(t,L.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let s=!0;if(t.getId()!==void 0){let r=String(t.getId());if(!(r in this.idIndex_))this.idIndex_[r]=t;else if(t instanceof m){let i=this.idIndex_[r];i instanceof m?Array.isArray(i)?i.push(t):this.idIndex_[r]=[i,t]:s=!1}else s=!1}return s&&(_(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),s}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){let t=[],s=[],r=[];for(let i=0,n=e.length;i<n;i++){let a=e[i],o=u(a);this.addToIndex_(o,a)&&s.push(a)}for(let i=0,n=s.length;i<n;i++){let a=s[i],o=u(a);this.setupChangeEvents_(o,a);let f=a.getGeometry();if(f){let l=f.getExtent();t.push(l),r.push(a)}else this.nullGeometryFeatures_[o]=a}if(this.featuresRtree_&&this.featuresRtree_.load(t,r),this.hasListener(h.ADDFEATURE))for(let i=0,n=s.length;i<n;i++)this.dispatchEvent(new d(h.ADDFEATURE,s[i]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(h.ADDFEATURE,function(s){t||(t=!0,e.push(s.feature),t=!1)}),this.addEventListener(h.REMOVEFEATURE,function(s){t||(t=!0,e.remove(s.feature),t=!1)}),e.addEventListener(I.ADD,s=>{t||(t=!0,this.addFeature(s.element),t=!1)}),e.addEventListener(I.REMOVE,s=>{t||(t=!0,this.removeFeature(s.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(let s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(p);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(s=>{this.removeFeatureInternal(s)});for(let s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};let t=new d(h.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){let s=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(s,function(r){let i=r.getGeometry();if(i instanceof m||i.intersectsCoordinate(e))return t(r)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(s){let r=s.getGeometry();if(r instanceof m||r.intersectsExtent(e)){let i=t(s);if(i)return i}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),g(this.nullGeometryFeatures_)||b(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){let t=[];return this.forEachFeatureAtCoordinateDirect(e,function(s){t.push(s)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);let r=P(e,t);return[].concat(...r.map(i=>this.featuresRtree_.getInExtent(i)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){let s=e[0],r=e[1],i=null,n=[NaN,NaN],a=1/0,o=[-1/0,-1/0,1/0,1/0];return t=t||U,this.featuresRtree_.forEachInExtent(o,function(f){if(t(f)){let l=f.getGeometry(),F=a;if(a=l instanceof m?0:l.closestPointXY(s,r,n,a),a<F){i=f;let c=Math.sqrt(a);o[0]=s-c,o[1]=r-c,o[2]=s+c,o[3]=r+c}}}),i}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){let t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){let t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){let t=e.target,s=u(t),r=t.getGeometry();if(!r)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[s]=t);else{let n=r.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(n,t)):this.featuresRtree_&&this.featuresRtree_.update(n,t)}let i=t.getId();if(i!==void 0){let n=i.toString();this.idIndex_[n]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[n]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[s]=t;this.changed(),this.dispatchEvent(new d(h.CHANGEFEATURE,t))}hasFeature(e){let t=e.getId();return t!==void 0?t in this.idIndex_:u(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&g(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,s){let r=this.loadedExtentsRtree_,i=this.strategy_(e,t,s);for(let n=0,a=i.length;n<a;++n){let o=i[n];r.forEachInExtent(o,function(l){return X(l.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new d(h.FEATURESLOADSTART)),this.loader_.call(this,o,t,s,l=>{--this.loadingExtentsCount_,this.dispatchEvent(new d(h.FEATURESLOADEND,void 0,l))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new d(h.FEATURESLOADERROR))}),r.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){let t=this.loadedExtentsRtree_,s=t.forEachInExtent(e,function(r){if(y(r.extent,e))return r});s&&t.remove(s)}removeFeatures(e){let t=!1;for(let s=0,r=e.length;s<r;++s)t=this.removeFeatureInternal(e[s])||t;t&&this.changed()}removeFeature(e){if(!e)return;this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){let t=u(e);if(!(t in this.uidIndex_))return!1;t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.featureChangeKeys_[t]?.forEach(p),delete this.featureChangeKeys_[t];let r=e.getId();if(r!==void 0){let i=r.toString(),n=this.idIndex_[i];n===e?delete this.idIndex_[i]:Array.isArray(n)&&(n.splice(n.indexOf(e),1),n.length===1&&(this.idIndex_[i]=n[0]))}return delete this.uidIndex_[t],this.hasListener(h.REMOVEFEATURE)&&this.dispatchEvent(new d(h.REMOVEFEATURE,e)),!0}removeFromIdIndex_(e){for(let t in this.idIndex_)if(this.idIndex_[t]===e){delete this.idIndex_[t];break}}setLoader(e){this.loader_=e}setUrl(e){_(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(C(e,this.format_))}setOverlaps(e){this.overlaps_=e,this.changed()}},z=D;var T=class extends z{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){let s=t.getGeometry();return _(!s||s.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),s},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,s){this.source?.loadFeatures(e,t,s),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(E.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(E.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){let s=e===0?0:Math.min(t,e)/e,r=e!==this.distance||this.interpolationRatio!==s;this.distance=e,this.minDistance=t,this.interpolationRatio=s,r&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;let e=K(),t=this.distance*this.resolution,s=this.source.getFeatures(),r={};for(let i=0,n=s.length;i<n;i++){let a=s[i];if(!(u(a)in r)){let o=this.geometryFunction(a);if(o){let f=o.getCoordinates();N(f,e),O(e,t,e);let l=this.source.getFeaturesInExtent(e).filter(function(F){let c=u(F);return c in r?!1:(r[c]=!0,!0)});this.features.push(this.createCluster(l,e))}}}}createCluster(e,t){let s=[0,0];for(let a=e.length-1;a>=0;--a){let o=this.geometryFunction(e[a]);o?H(s,o.getCoordinates()):e.splice(a,1)}V(s,1/e.length);let r=M(t),i=this.interpolationRatio,n=new q([s[0]*(1-i)+r[0]*i,s[1]*(1-i)+r[1]*i]);return this.createCustomCluster_?this.createCustomCluster_(n,e):new Z({geometry:n,features:e})}},Se=T;export{h as a,z as b,Se as c};
