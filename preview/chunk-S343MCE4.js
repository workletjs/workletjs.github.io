import{a as f}from"./chunk-36MU545B.js";import{f as T,g as d}from"./chunk-KNT5A3QN.js";import{M as y}from"./chunk-SFR7ATWH.js";import{t as p}from"./chunk-OAKYQQNU.js";import{E as w,v as _}from"./chunk-GF377ULF.js";import{j as u}from"./chunk-TWZW5B45.js";var b="https://tile.googleapis.com/v1/createSession",$="https://tile.googleapis.com/v1/2dtiles",R="https://tile.googleapis.com/tile/v1/viewport",S=22,g=class extends f{constructor(e){let i=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:i?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;let t={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(t.imageFormat=e.imageFormat),e.scale&&(t.scale=e.scale),i&&(t.highDpi=!0),e.layerTypes&&(t.layerTypes=e.layerTypes),e.styles&&(t.styles=e.styles),e.overlay===!0&&(t.overlay=!0),e.apiOptions&&(t.apiOptions=e.apiOptions),this.sessionTokenRequest_=t,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,i){return fetch(e,i)}createSession_(){return u(this,null,function*(){let e=b+"?key="+this.apiKey_,i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},t=yield this.fetchSessionToken(e,i);if(!t.ok){try{let s=yield t.json();this.error_=new Error(s.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}let o=yield t.json(),n=this.getTilePixelRatio(1),m=[o.tileWidth/n,o.tileHeight/n];this.tileGrid=T({extent:d(this.getProjection()),maxZoom:S,tileSize:m});let c=o.session;this.sessionTokenValue_=c;let r=this.apiKey_;this.tileUrlFunction=function(s,a,E){let v=s[0],x=s[1],k=s[2];return`${$}/${v}/${x}/${k}?session=${c}&key=${r}`};let h=parseInt(o.expiry,10)*1e3,l=Math.max(h-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),l),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")})}fetchAttributions_(e){return u(this,null,function*(){if(e.viewHints[y.ANIMATING]||e.viewHints[y.INTERACTING]||e.animate)return this.previousViewportAttribution_;let[i,t]=p(_(e.extent),e.viewState.projection),[o,n]=p(w(e.extent),e.viewState.projection),r=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${n}&south=${t}&east=${o}&west=${i}`;if(this.previousViewportExtent_==r)return this.previousViewportAttribution_;this.previousViewportExtent_=r;let h=this.sessionTokenValue_,l=this.apiKey_,s=`${R}?session=${h}&key=${l}&${r}`;return this.previousViewportAttribution_=yield fetch(s).then(a=>a.json()).then(a=>a.copyright),this.previousViewportAttribution_})}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}},P=g;export{P as a};
