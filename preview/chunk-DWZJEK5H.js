import{$ as qe,B as Ve,E as Ye,H as Te,I as _e,K as je,P as J,R as Ke,V as Q,W as G,X as ke,_ as Ze,a as V,aa as de,b as He,ba as Je,ca as ee,dc as re,e as We,ec as ge,fa as Qe,fc as rt,gc as N,ha as D,hc as ne,ia as et,ic as ie,ja as pe,jc as nt,kc as me,la as M,lc as it,mc as ot,nc as st,oc as T,qa as w,r as ze,ra as te,sa as $,sb as Ee,ua as tt,w as S,y as q,z as v}from"./chunk-IV3CZHWS.js";import{E as Z,g as Xe}from"./chunk-L76X3E7P.js";import{A as we,C as z,H as $e,b as Me,f as fe}from"./chunk-WEL5MCWD.js";import{a as Oe,b as Ge}from"./chunk-TWZW5B45.js";function F(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function oe(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}function tr(n,e,t,r,o,i,s){s=s??F();let a=1/(n-e),c=1/(t-r),l=1/(o-i);return s[0]=-2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(n+e)*a,s[13]=(r+t)*c,s[14]=(i+o)*l,s[15]=1,s}function rr(n,e,t,r,o){return o=o??F(),o[0]=n[0]*e,o[1]=n[1]*e,o[2]=n[2]*e,o[3]=n[3]*e,o[4]=n[4]*t,o[5]=n[5]*t,o[6]=n[6]*t,o[7]=n[7]*t,o[8]=n[8]*r,o[9]=n[9]*r,o[10]=n[10]*r,o[11]=n[11]*r,o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15],o}function nr(n,e,t,r,o){o=o??F();let i,s,a,c,l,h,u,_,f,E,A,y;return n===o?(o[12]=n[0]*e+n[4]*t+n[8]*r+n[12],o[13]=n[1]*e+n[5]*t+n[9]*r+n[13],o[14]=n[2]*e+n[6]*t+n[10]*r+n[14],o[15]=n[3]*e+n[7]*t+n[11]*r+n[15]):(i=n[0],s=n[1],a=n[2],c=n[3],l=n[4],h=n[5],u=n[6],_=n[7],f=n[8],E=n[9],A=n[10],y=n[11],o[0]=i,o[1]=s,o[2]=a,o[3]=c,o[4]=l,o[5]=h,o[6]=u,o[7]=_,o[8]=f,o[9]=E,o[10]=A,o[11]=y,o[12]=i*e+l*t+f*r+n[12],o[13]=s*e+h*t+E*r+n[13],o[14]=a*e+u*t+A*r+n[14],o[15]=c*e+_*t+y*r+n[15]),o}function ir(n,e,t,r){return r=r??F(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n,r[13]=e,r[14]=t,r[15]=1,r}var Y=34962,j=34963,lt=35040,X=35044,ct=35048,ht=5121,ut=5123,ft=5125,Re=5126,at=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Tt(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Ve},e);let t=at.length;for(let r=0;r<t;++r)try{let o=n.getContext(at[r],e);if(o)return o}catch(o){}return null}var Dt={STATIC_DRAW:X,STREAM_DRAW:lt,DYNAMIC_DRAW:ct},xe=class{constructor(e,t){this.array_=null,this.type_=e,Q(e===Y||e===j,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:Dt.STATIC_DRAW}ofSize(e){return this.array_=new(se(this.type_))(e),this}fromArray(e){return this.array_=se(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(se(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){let t=se(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}};function se(n){switch(n){case Y:return Float32Array;case j:return Uint32Array;default:return Float32Array}}var ae=xe;var K={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"};var Nt=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Ft=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`,Ae=class{constructor(e){this.gl_=e.webGlContext;let t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();let r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Nt),t.compileShader(r);let o=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(o,e.fragmentShader||Ft),t.compileShader(o),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,o),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();let i=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(s=>{this.uniforms_.push({value:e.uniforms[s],location:t.getUniformLocation(this.renderTargetProgram_,s)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){let t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;let o=0,i=t.RGBA,s=0,a=t.RGBA,c=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,o,i,r[0],r[1],s,a,c,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,o){let i=this.getGL(),s=e.size;if(i.bindFramebuffer(i.FRAMEBUFFER,t?t.getFrameBuffer():null),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.renderTargetTexture_),!t){let c=v(i.canvas);if(!e.renderTargets[c]){let l=i.getContextAttributes();l&&l.preserveDrawingBuffer&&(i.clearColor(0,0,0,0),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)),e.renderTargets[c]=!0}}i.disable(i.DEPTH_TEST),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight),i.bindBuffer(i.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),i.useProgram(this.renderTargetProgram_),i.enableVertexAttribArray(this.renderTargetAttribLocation_),i.vertexAttribPointer(this.renderTargetAttribLocation_,2,i.FLOAT,!1,0,0),i.uniform2f(this.renderTargetUniformLocation_,s[0],s[1]),i.uniform1i(this.renderTargetTextureLocation_,0);let a=e.layerStatesArray[e.layerIndex].opacity;i.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(i,e),i.drawArrays(i.TRIANGLES,0,6),o&&o(i,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){let t=this.getGL(),r,o=1;this.uniforms_.forEach(function(i){if(r=typeof i.value=="function"?i.value(e):i.value,r instanceof HTMLCanvasElement||r instanceof ImageData)i.texture||(i.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${o}`]),t.bindTexture(t.TEXTURE_2D,i.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(i.location,o++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(i.location,r[0],r[1]);return;case 3:t.uniform3f(i.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(i.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(i.location,r)})}},ye=Ae;var B={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},H={UNSIGNED_BYTE:ht,UNSIGNED_SHORT:ut,UNSIGNED_INT:ft,FLOAT:Re},le={};function _t(n){return"shared/"+n}var dt=0;function Bt(){let n="unique/"+dt;return dt+=1,n}function Ot(n){let e=le[n];if(!e){let t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Tt(t)},le[n]=e}return e.users+=1,e.context}function Gt(n){let e=le[n];if(!e||(e.users-=1,e.users>0))return;let t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();let o=t.canvas;o.width=1,o.height=1,delete le[n]}var Ce=class extends He{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?_t(e.canvasCacheKey):Bt(),this.gl_=Ot(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;let t=this.gl_.canvas;t.addEventListener(K.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(K.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=G(),this.offsetScaleMatrix_=G(),this.tmpMat4_=F(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new ye({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new ye({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(let t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===_t(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];let t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){let e=this.getExtension("ANGLE_instanced_arrays");return Q(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){let t=this.gl_,r=v(e),o=this.bufferCache_[r];if(!o){let i=t.createBuffer();o={buffer:e,webGlBuffer:i},this.bufferCache_[r]=o}t.bindBuffer(e.getType(),o.webGlBuffer)}flushBufferData(e){let t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){let t=v(e);delete this.bufferCache_[t]}disposeInternal(){let e=this.gl_.canvas;e.removeEventListener(K.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(K.RESTORED,this.boundHandleWebGLContextRestored_),Gt(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){let o=this.gl_,i=this.getCanvas(),s=e.size,a=e.pixelRatio;(i.width!==s[0]*a||i.height!==s[1]*a)&&(i.width=s[0]*a,i.height=s[1]*a,i.style.width=s[0]+"px",i.style.height=s[1]+"px");for(let c=this.postProcessPasses_.length-1;c>=0;c--)this.postProcessPasses_[c].init(e);o.bindTexture(o.TEXTURE_2D,null),o.clearColor(0,0,0,0),o.depthRange(0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),o.blendFunc(o.ONE,t?o.ZERO:o.ONE_MINUS_SRC_ALPHA),r?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST)}bindFrameBuffer(e,t){let r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){let e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);let r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){let o=this.gl_;o.activeTexture(o.TEXTURE0+t),o.bindTexture(o.TEXTURE_2D,e),o.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){let o=this.getGL();this.bindBuffer(e);let i=this.getAttributeLocation(t);o.enableVertexAttribArray(i),o.vertexAttribPointer(i,r,o.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,o){let i=this.gl_,s=t.getSize();i.bindFramebuffer(i.FRAMEBUFFER,t.getFramebuffer()),i.bindRenderbuffer(i.RENDERBUFFER,t.getDepthbuffer()),i.viewport(0,0,s[0],s[1]),i.bindTexture(i.TEXTURE_2D,t.getTexture()),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,r?i.ZERO:i.ONE_MINUS_SRC_ALPHA),o?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}drawElements(e,t){let r=this.gl_;this.getExtension("OES_element_index_uint");let o=r.UNSIGNED_INT,i=4,s=t-e,a=e*i;r.drawElements(r.TRIANGLES,s,o,a)}drawElementsInstanced(e,t,r){let o=this.gl_;this.getExtension("OES_element_index_uint");let i=this.getInstancedRenderingExtension_(),s=o.UNSIGNED_INT,a=4,c=t-e,l=e*a;i.drawElementsInstancedANGLE(o.TRIANGLES,c,s,l,r);for(let h=0;h<this.maxAttributeCount_;h++)i.vertexAttribDivisorANGLE(h,0)}finalizeDraw(e,t,r){for(let o=0,i=this.postProcessPasses_.length;o<i;o++)o===i-1?this.postProcessPasses_[o].apply(e,null,t,r):this.postProcessPasses_[o].apply(e,this.postProcessPasses_[o+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){let t=e.size,r=e.viewState.rotation,o=e.pixelRatio;this.setUniformFloatValue(B.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(B.ZOOM,e.viewState.zoom),this.setUniformFloatValue(B.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(B.PIXEL_RATIO,o),this.setUniformFloatVec2(B.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(B.ROTATION,r)}applyHitDetectionUniform(e){let t=this.getUniformLocation(B.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(B.PIXEL_RATIO,.5)}applyUniforms(e){let t=this.gl_,r,o=0;this.uniforms_.forEach(i=>{if(r=typeof i.value=="function"?i.value(e):i.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!i.texture?(i.prevValue=void 0,i.texture=r):i.texture||(i.prevValue=void 0,i.texture=t.createTexture()),this.bindTexture(i.texture,o,i.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);let s=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&s&&i.prevValue!==r&&(i.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),o++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(i.name,oe(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(i.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(i.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(i.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(i.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){let r=this.gl_,o=r.createShader(t);return r.shaderSource(o,e),r.compileShader(o),o}getProgram(e,t){let r=this.gl_,o=this.compileShader(e,r.FRAGMENT_SHADER),i=this.compileShader(t,r.VERTEX_SHADER),s=r.createProgram();if(r.attachShader(s,o),r.attachShader(s,i),r.linkProgram(s),!r.getShaderParameter(o,r.COMPILE_STATUS)){let a=`Fragment shader compilation failed: ${r.getShaderInfoLog(o)}`;throw new Error(a)}if(r.deleteShader(o),!r.getShaderParameter(i,r.COMPILE_STATUS)){let a=`Vertex shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getProgramParameter(s,r.LINK_STATUS)){let a=`GL program linking failed: ${r.getProgramInfoLog(s)}`;throw new Error(a)}return s}getUniformLocation(e){let t=v(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){let t=v(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){let r=e.size,o=e.viewState.rotation,i=e.viewState.resolution,s=e.viewState.center;return ee(t,0,0,2/(i*r[0]),2/(i*r[1]),-o,-s[0],-s[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,o,i,s){let a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,r,!1,o,i),s&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){let r=Mt(e),o=0;for(let i=0;i<e.length;i++){let s=e[i];s.name&&this.enableAttributeArray_(s.name,s.size,s.type||Re,r,o,t),o+=s.size*pt(s.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){Xe(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,o){let i=this.gl_;r=r||i.createTexture();let s=o?i.NEAREST:i.LINEAR;i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);let a=0,c=i.RGBA,l=0,h=i.RGBA,u=i.UNSIGNED_BYTE;return t instanceof Uint8Array?i.texImage2D(i.TEXTURE_2D,a,c,e[0],e[1],l,h,u,t):t?i.texImage2D(i.TEXTURE_2D,a,c,h,u,t):i.texImage2D(i.TEXTURE_2D,a,c,e[0],e[1],l,h,u,null),r}};function Mt(n){let e=0;for(let t=0;t<n.length;t++){let r=n[t];e+=r.size*pt(r.type)}return e}function pt(n){switch(n){case H.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case H.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case H.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case H.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}var Et=Ce;var be=class extends ze{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(V.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===S.LOADED,this.loaded)this.uploadTile();else{if(e instanceof J){let t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(V.CHANGE,this.handleTileChange_)}}uploadTile(){q()}setReady(){this.ready=!0,this.dispatchEvent(V.CHANGE)}handleTileChange_(){this.tile.getState()===S.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(V.CHANGE,this.handleTileChange_)}},gt=be;function Rt(n,e,t){let r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function wt(n,e,t,r){Rt(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function mt(n,e,t,r,o,i){let s=n.getGL(),a,c;t instanceof Float32Array?(a=s.FLOAT,n.getExtension("OES_texture_float"),c=n.getExtension("OES_texture_float_linear")!==null):(a=s.UNSIGNED_BYTE,c=!0),Rt(s,e,i&&c);let l=t.byteLength/r[1],h=1;l%8===0?h=8:l%4===0?h=4:l%2===0&&(h=2);let u;switch(o){case 1:{u=s.LUMINANCE;break}case 2:{u=s.LUMINANCE_ALPHA;break}case 3:{u=s.RGB;break}case 4:{u=s.RGBA;break}default:throw new Error(`Unsupported number of bands: ${o}`)}let _=s.getParameter(s.UNPACK_ALIGNMENT);s.pixelStorei(s.UNPACK_ALIGNMENT,h),s.texImage2D(s.TEXTURE_2D,0,u,r[0],r[1],0,u,a,t),s.pixelStorei(s.UNPACK_ALIGNMENT,_)}var W=null;function $t(){W=Ye(1,1,void 0,{willReadFrequently:!0})}var Ue=class extends gt{constructor(e){super(e),this.textures=[],this.renderSize_=D(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;let t=new ae(Y,X);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){let t=this.helper?.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let r=0;r<this.textures.length;++r)t.deleteTexture(this.textures[r])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){let e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let o;r instanceof J||r instanceof Qe?o=r.getImage():o=r.getData();let i=Te(o);if(i){let d=t.createTexture();this.textures.push(d),this.bandCount=4,wt(t,d,i,r.interpolate),this.setReady();return}o=_e(o);let s=r.getSize(),a=[s[0]+2*this.gutter,s[1]+2*this.gutter],c=o instanceof Float32Array,l=a[0]*a[1],h=c?Float32Array:Uint8Array,u=h.BYTES_PER_ELEMENT,_=o.byteLength/a[1];this.bandCount=Math.floor(_/u/a[0]);let f=Math.ceil(this.bandCount/4);if(f===1){let d=t.createTexture();this.textures.push(d),mt(e,d,o,a,this.bandCount,r.interpolate),this.setReady();return}let E=new Array(f);for(let d=0;d<f;++d){let p=t.createTexture();this.textures.push(p);let x=d<f-1?4:(this.bandCount-1)%4+1;E[d]=new h(l*x)}let A=0,y=0,P=a[0]*this.bandCount;for(let d=0;d<a[1];++d){for(let p=0;p<P;++p){let x=o[y+p],m=Math.floor(A/this.bandCount),R=p%this.bandCount,b=Math.floor(R/4),I=E[b],U=I.length/l,C=R%4;I[m*U+C]=x,++A}y+=_/u}for(let d=0;d<f;++d){let p=this.textures[d],x=E[d],m=x.length/l;mt(e,p,x,a,m,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){let o=this.gutter,i=this.renderSize_[0],s=this.renderSize_[1];W||$t(),W.clearRect(0,0,1,1);let a=e.width,c=e.height,l=a-2*o,h=c-2*o,u=o+Math.floor(l*(t/i)),_=o+Math.floor(h*(r/s)),f;try{W.drawImage(e,u,_,1,1,0,0,1,1),f=W.getImageData(0,0,1,1).data}catch(E){return W=null,null}return f}getArrayPixelData_(e,t,r,o){let i=this.gutter,s=this.renderSize_[0],a=this.renderSize_[1],c=t[0],l=t[1],h=c+2*i,u=l+2*i,_=i+Math.floor(c*(r/s)),f=i+Math.floor(l*(o/a));if(e instanceof DataView){let A=e.byteLength/(h*u),y=A*(f*h+_),P=e.buffer.slice(y,y+A);return new DataView(P)}let E=this.bandCount*(f*h+_);return e.slice(E,E+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof je){let r=this.tile.getData(),o=_e(r);if(o){let i=this.tile.getSize();return this.getArrayPixelData_(o,i,e,t)}return this.getImagePixelData_(Te(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}},xt=Ue;var Le=class n extends tt{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=G(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Ee.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){let r=this.getLayer();if(r.hasListener($.PRECOMPOSE)){let o=new te($.PRECOMPOSE,void 0,t,e);r.dispatchEvent(o)}}dispatchPostComposeEvent(e,t){let r=this.getLayer();if(r.hasListener($.POSTCOMPOSE)){let o=new te($.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(o)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,o;for(let s=0,a=e.layerStatesArray.length;s<a;s++){let c=e.layerStatesArray[s].layer,l=c.getRenderer();if(!(l instanceof n)){t=!0;continue}let h=c.getClassName();if((t||h!==o)&&(r+=1,t=!1),o=h,l===this)break}let i="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(i)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Et({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:i}),o&&(this.helper.getCanvas().className=o),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){this.clearCache(),this.removeHelper(),this.getLayer()?.removeChangeListener(Ee.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){let o=this.getLayer();if(o.hasListener(e)){ee(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);let i=new te(e,this.inversePixelTransform_,r,t);o.dispatchEvent(i)}}preRender(e,t){this.dispatchRenderEvent_($.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_($.POSTRENDER,e,t)}},At=Le;var Ut={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function yt(n){return 1/(n+2)}function Xt(){return{tileIds:new Set,representationsByZ:{}}}function Ct(n,e){return n.tileIds.has(v(e))}function bt(n,e,t){let r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(v(e.tile))}function Pe(n,e){let t=n.layerStatesArray[n.layerIndex];t.extent&&(e=z(e,Z(t.extent,n.viewState.projection)));let r=t.layer.getRenderSource();if(!r.getWrapX()){let o=r.getTileGridForProjection(n.viewState.projection).getExtent();o&&(e=z(e,o))}return e}function ce(n,e){return`${v(n)},${n.getKey()},${n.getRevision()},${M(e)}`}var Ie=class extends At{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=G(),this.tempMat4=F(),this.tempTileRange_=new Ke(0,0,0,0),this.tempTileCoord_=pe(0,0,0),this.tempSize_=[0,0];let r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new et(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;let r=this.getLayer().getRenderSource();return!r||$e(Pe(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return q()}enqueueTiles(e,t,r,o,i){let s=e.viewState,a=this.getLayer(),c=a.getRenderSource(),l=c.getTileGridForProjection(s.projection),h=c.getGutterForProjection(s.projection),u=v(c);u in e.wantedTiles||(e.wantedTiles[u]={});let _=e.wantedTiles[u],f=this.tileRepresentationCache,E=a.getMapInternal(),A=Math.max(r-i,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),E?E.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),c.zDirection)),y=s.rotation,P=y?we(s.center,s.resolution,y,e.size):void 0;for(let d=r;d>=A;--d){let p=l.getTileRangeForExtentAndZ(t,d,this.tempTileRange_),x=l.getResolution(d);for(let m=p.minX;m<=p.maxX;++m)for(let R=p.minY;R<=p.maxY;++R){if(y&&!l.tileCoordIntersectsViewport([d,m,R],P))continue;let b=pe(d,m,R,this.tempTileCoord_),I=ce(c,b),U,C;if(f.containsKey(I)&&(U=f.get(I),C=U.tile),(!U||U.tile.key!==c.getKey())&&(C=c.getTile(d,m,R,e.pixelRatio,s.projection),!C)||Ct(o,C))continue;U?U.setTile(C):(U=this.createTileRepresentation({tile:C,grid:l,helper:this.helper,gutter:h}),f.set(I,U)),bt(o,U,d);let O=C.getKey();_[O]=!0,C.getState()===S.IDLE&&(e.tileQueue.isKeyQueued(O)||e.tileQueue.enqueue([C,u,l.getTileCoordCenter(b),x]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,o,i,s,a,c,l,h,u){}renderTileMask(e,t,r,o){}drawTile_(e,t,r,o,i,s,a){if(!t.ready)return;let l=t.tile.tileCoord,h=M(l),u=h in s?s[h]:1,_=a.getResolution(r),f=D(a.getTileSize(r),this.tempSize_),E=a.getOrigin(r),A=a.getTileCoordExtent(l),y=u<1?-1:yt(r);u<1&&(e.animate=!0);let P=e.viewState,d=P.center[0],p=P.center[1],x=f[0]+2*o,m=f[1]+2*o,R=x/m,b=(d-E[0])/(f[0]*_),I=(E[1]-p)/(f[1]*_),U=P.resolution/_,C=l[1],O=l[2];ke(this.tileTransform_),de(this.tileTransform_,2/(e.size[0]*U/x),-2/(e.size[1]*U/x)),qe(this.tileTransform_,P.rotation),de(this.tileTransform_,1,1/R),Je(this.tileTransform_,(f[0]*(C-b)-o)/x,(f[1]*(O-I)-o)/m),this.renderTile(t,this.tileTransform_,e,i,_,f,E,A,y,o,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;let t=this.helper.getGL();this.preRender(t,e);let r=e.viewState,o=this.getLayer(),i=o.getRenderSource(),s=i.getTileGridForProjection(r.projection),a=i.getGutterForProjection(r.projection),c=Pe(e,e.extent),l=s.getZForResolution(r.resolution,i.zDirection),h=Xt(),u=o.getPreload();if(e.nextExtent){let p=s.getZForResolution(r.nextResolution,i.zDirection),x=Pe(e,e.nextExtent);this.enqueueTiles(e,x,p,h,u)}this.enqueueTiles(e,c,l,h,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,c,l-1,h,u-1)},0);let _={},f=!1,E=h.representationsByZ;if(l in E){let p=v(this),x=e.time;for(let m of E[l]){let R=m.tile;if(R.getState()===S.EMPTY)continue;let b=R.tileCoord;if(m.ready){let C=R.getAlpha(p,x);if(C===1){R.endTransition(p);continue}f=!0;let O=M(b);_[O]=C}if(this.renderComplete=!1,this.findAltTiles_(s,b,l+1,h))continue;let U=s.getMinZoom();for(let C=l-1;C>=U&&!this.findAltTiles_(s,b,C,h);--C);}}let A=Object.keys(E).map(Number).sort(We);if(this.beforeTilesMaskRender(e))for(let p=0,x=A.length;p<x;++p){let m=A[p];for(let R of E[m]){let b=R.tile.tileCoord;if(M(b)in _)continue;let U=s.getTileCoordExtent(b);this.renderTileMask(R,m,U,yt(m))}}this.beforeTilesRender(e,f);for(let p=0,x=A.length;p<x;++p){let m=A[p];for(let R of E[m]){let b=R.tile.tileCoord;M(b)in _||this.drawTile_(e,R,m,a,c,_,s)}}if(l in E)for(let p of E[l]){let x=p.tile.tileCoord;M(x)in _&&this.drawTile_(e,p,l,a,c,_,s)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);let P=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),P}beforeFinalize(e){}findAltTiles_(e,t,r,o){let i=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!i)return!1;let s=!0,a=this.tileRepresentationCache,c=this.getLayer().getRenderSource();for(let l=i.minX;l<=i.maxX;++l)for(let h=i.minY;h<=i.maxY;++h){let u=ce(c,[r,l,h]),_=!1;if(a.containsKey(u)){let f=a.get(u);f.ready&&!Ct(o,f.tile)&&(bt(o,f,r),_=!0)}_||(s=!1)}return s}clearCache(){super.clearCache();let e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}},Lt=Ie;var L=Ge(Oe({},Ut),{TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"}),Ht={TEXTURE_COORD:"a_textureCoord"},Wt=[{name:Ht.TEXTURE_COORD,size:2,type:H.FLOAT}],ve=class extends Lt{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new ae(j,X),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){let t=this.helper.getGL();for(let r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);let t=this.helper.getGL();for(let r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();let e=this.helper.getGL();for(let t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){let e=this.helper.getGL();for(let t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new xt(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,o,i,s,a,c,l,h,u){let _=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Wt);let f=0;for(;f<e.textures.length;){let R=`${L.TILE_TEXTURE_ARRAY}[${f}]`;this.helper.bindTexture(e.textures[f],f,R),++f}for(let R=0;R<this.paletteTextures_.length;++R){let b=this.paletteTextures_[R],I=b.getTexture(_);this.helper.bindTexture(I,f,b.name),++f}let E=r.viewState,A=s[0]+2*h,y=s[1]+2*h,d=e.tile.tileCoord,p=d[1],x=d[2];this.helper.setUniformMatrixValue(L.TILE_TRANSFORM,oe(this.tempMat4,t)),this.helper.setUniformFloatValue(L.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(L.DEPTH,l);let m=o;h>0&&(m=c,z(m,o,m)),this.helper.setUniformFloatVec4(L.RENDER_EXTENT,m),this.helper.setUniformFloatValue(L.RESOLUTION,E.resolution),this.helper.setUniformFloatValue(L.ZOOM,E.zoom),this.helper.setUniformFloatValue(L.TEXTURE_PIXEL_WIDTH,A),this.helper.setUniformFloatValue(L.TEXTURE_PIXEL_HEIGHT,y),this.helper.setUniformFloatValue(L.TEXTURE_RESOLUTION,i),this.helper.setUniformFloatValue(L.TEXTURE_ORIGIN_X,a[0]+p*s[0]*i-h*i),this.helper.setUniformFloatValue(L.TEXTURE_ORIGIN_Y,a[1]-x*s[1]*i+h*i),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;let r=this.frameState;if(!r)return null;let o=this.getLayer(),i=Ze(r.pixelToCoordinateTransform,e.slice()),s=r.viewState,a=o.getExtent();if(a&&!fe(Z(a,s.projection),i))return null;let c=o.getSources(Me([i]),s.resolution),l,h,u;for(l=c.length-1;l>=0;--l)if(h=c[l],h.getState()==="ready"){if(u=h.getTileGridForProjection(s.projection),h.getWrapX())break;let f=u.getExtent();if(!f||fe(f,i))break}if(l<0)return null;let _=this.tileRepresentationCache;for(let f=u.getZForResolution(s.resolution);f>=u.getMinZoom();--f){let E=u.getTileCoordForCoordAndZ(i,f),A=ce(h,E);if(!_.containsKey(A))continue;let y=_.get(A);if(y.tile.getState()===S.EMPTY)return null;if(!y.loaded)continue;let d=u.getOrigin(f),p=D(u.getTileSize(f)),x=u.getResolution(f),m=(i[0]-d[0])/x-E[1]*p[0],R=(d[1]-i[1])/x-E[2]*p[1];return y.getPixelData(m,R)}return null}disposeInternal(){let e=this.helper;if(e){let t=e.getGL();for(let r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}},En=ve;var Se=class{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){let t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}},Pt=Se;function zt(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function k(n){let e=n.toString();return e.includes(".")?e:e+".0"}function Fe(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(k).join(", ")})`}function Vt(n){let e=w(n),t=e.length>3?e[3]:1;return Fe([e[0]/255,e[1]/255,e[2]/255,t])}function Yt(n){let e=D(n);return Fe(e)}var De={},jt=0;function he(n){return n in De||(De[n]=jt++),De[n]}function Kt(n){return k(he(n))}function ue(n){return"u_var_"+n}function Un(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}var Ne="getBandValue",kt="u_paletteTextures",Zt="featureId",qt="geometryType",Jt=-9999999;function It(n,e,t,r){let o=st(n,e,t);return Be(o,e,r)}function g(n){return(e,t,r)=>{let o=t.args.length,i=new Array(o);for(let s=0;s<o;++s)i[s]=Be(t.args[s],r,e);return n(i,e)}}var Qt={[T.Get]:(n,e)=>{let r=e.args[0].value;r in n.properties||(n.properties[r]={name:r,type:e.type});let i="a_prop_"+r;return me(e.type,re)&&(i=`(${i} > 0.0)`),i},[T.Id]:n=>(n.featureId=!0,"a_"+Zt),[T.GeometryType]:n=>(n.geometryType=!0,"a_"+qt),[T.LineMetric]:()=>"currentLineMetric",[T.Var]:(n,e)=>{let r=e.args[0].value;r in n.variables||(n.variables[r]={name:r,type:e.type});let i=ue(r);return me(e.type,re)&&(i=`(${i} > 0.0)`),i},[T.Has]:(n,e)=>{let r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${k(Jt)})`},[T.Resolution]:()=>"u_resolution",[T.Zoom]:()=>"u_zoom",[T.Time]:()=>"u_time",[T.Any]:g(n=>`(${n.join(" || ")})`),[T.All]:g(n=>`(${n.join(" && ")})`),[T.Not]:g(([n])=>`(!${n})`),[T.Equal]:g(([n,e])=>`(${n} == ${e})`),[T.NotEqual]:g(([n,e])=>`(${n} != ${e})`),[T.GreaterThan]:g(([n,e])=>`(${n} > ${e})`),[T.GreaterThanOrEqualTo]:g(([n,e])=>`(${n} >= ${e})`),[T.LessThan]:g(([n,e])=>`(${n} < ${e})`),[T.LessThanOrEqualTo]:g(([n,e])=>`(${n} <= ${e})`),[T.Multiply]:g(n=>`(${n.join(" * ")})`),[T.Divide]:g(([n,e])=>`(${n} / ${e})`),[T.Add]:g(n=>`(${n.join(" + ")})`),[T.Subtract]:g(([n,e])=>`(${n} - ${e})`),[T.Clamp]:g(([n,e,t])=>`clamp(${n}, ${e}, ${t})`),[T.Mod]:g(([n,e])=>`mod(${n}, ${e})`),[T.Pow]:g(([n,e])=>`pow(${n}, ${e})`),[T.Abs]:g(([n])=>`abs(${n})`),[T.Floor]:g(([n])=>`floor(${n})`),[T.Ceil]:g(([n])=>`ceil(${n})`),[T.Round]:g(([n])=>`floor(${n} + 0.5)`),[T.Sin]:g(([n])=>`sin(${n})`),[T.Cos]:g(([n])=>`cos(${n})`),[T.Atan]:g(([n,e])=>e!==void 0?`atan(${n}, ${e})`:`atan(${n})`),[T.Sqrt]:g(([n])=>`sqrt(${n})`),[T.Match]:g(n=>{let e=n[0],t=n[n.length-1],r=null;for(let o=n.length-3;o>=1;o-=2){let i=n[o],s=n[o+1];r=`(${e} == ${i} ? ${s} : ${r||t})`}return r}),[T.Between]:g(([n,e,t])=>`(${n} >= ${e} && ${n} <= ${t})`),[T.Interpolate]:g(([n,e,...t])=>{let r="";for(let o=0;o<t.length-2;o+=2){let i=t[o],s=r||t[o+1],a=t[o+2],c=t[o+3],l;n===k(1)?l=`(${e} - ${i}) / (${a} - ${i})`:l=`(pow(${n}, (${e} - ${i})) - 1.0) / (pow(${n}, (${a} - ${i})) - 1.0)`,r=`mix(${s}, ${c}, clamp(${l}, 0.0, 1.0))`}return r}),[T.Case]:g(n=>{let e=n[n.length-1],t=null;for(let r=n.length-3;r>=0;r-=2){let o=n[r],i=n[r+1];t=`(${o} ? ${i} : ${t||e})`}return t}),[T.In]:g(([n,...e],t)=>{let r=zt("in",t),o=[];for(let i=0;i<e.length;i+=1)o.push(`  if (inputValue == ${e[i]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${o.join(`
`)}
  return false;
}`,`${r}(${n})`}),[T.Array]:g(n=>`vec${n.length}(${n.join(", ")})`),[T.Color]:g(n=>{if(n.length===1)return`vec4(vec3(${n[0]} / 255.0), 1.0)`;if(n.length===2)return`vec4(vec3(${n[0]} / 255.0), ${n[1]})`;let e=n.slice(0,3).map(r=>`${r} / 255.0`);if(n.length===3)return`vec4(${e.join(", ")}, 1.0)`;let t=n[3];return`vec4(${e.join(", ")}, ${t})`}),[T.Band]:g(([n,e,t],r)=>{if(!(Ne in r.functions)){let o="",i=r.bandCount||1;for(let s=0;s<i;s++){let a=Math.floor(s/4),c=s%4;s===i-1&&c===1&&(c=3);let l=`${L.TILE_TEXTURE_ARRAY}[${a}]`;o+=`  if (band == ${s+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${c}];
  }
`}r.functions[Ne]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${L.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${L.TEXTURE_PIXEL_HEIGHT};
${o}
}`}return`${Ne}(${n}, ${e??"0.0"}, ${t??"0.0"})`}),[T.Palette]:(n,e)=>{let[t,...r]=e.args,o=r.length,i=new Uint8Array(o*4);for(let l=0;l<r.length;l++){let h=r[l].value,u=w(h),_=l*4;i[_]=u[0],i[_+1]=u[1],i[_+2]=u[2],i[_+3]=u[3]*255}n.paletteTextures||(n.paletteTextures=[]);let s=`${kt}[${n.paletteTextures.length}]`,a=new Pt(s,i);n.paletteTextures.push(a);let c=Be(t,ge,n);return`texture2D(${s}, vec2((${c} + 0.5) / ${o}.0, 0.5))`}};function Be(n,e,t){if(n instanceof it){let r=Qt[n.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(n.operator)}`);return r(t,n,e)}if((n.type&ge)>0)return k(n.value);if((n.type&re)>0)return n.value.toString();if((n.type&rt)>0)return Kt(n.value.toString());if((n.type&N)>0)return Vt(n.value);if((n.type&ne)>0)return Fe(n.value);if((n.type&ie)>0)return Yt(n.value);throw new Error(`Unexpected expression ${n.value} (expected type ${nt(e)})`)}function Sn(n,e,t){let r=ot();return It(e,t,r,n)}function er(n){let e=w(n),t=e[0]*256,r=e[1],o=e[2]*256,i=Math.round(e[3]*255);return[t+r,o+i]}var Dn=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function St(n){return n===N||n===ie?2:n===ne?4:1}function vt(n){let e=St(n);return e>1?`vec${e}`:"float"}function Nn(n,e){for(let t in e.variables){let r=e.variables[t],o=ue(r.name),i=vt(r.type);r.type===N&&(i="vec4"),n.addUniform(o,i)}for(let t in e.properties){let r=e.properties[t],o=vt(r.type),i=`a_prop_${r.name}`;r.type===N?n.addAttribute(i,o,`unpackColor(${i})`,"vec4"):n.addAttribute(i,o)}for(let t in e.functions)n.addVertexShaderFunction(e.functions[t]),n.addFragmentShaderFunction(e.functions[t])}function Fn(n,e){let t={};for(let r in n.variables){let o=n.variables[r],i=ue(o.name);t[i]=()=>{let s=e[o.name];if(typeof s=="number")return s;if(typeof s=="boolean")return s?1:0;if(o.type===N){let a=[...w(s||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??=1,a}return typeof s=="string"?he(s):s}}return t}function Bn(n){let e={};for(let t in n.properties){let r=n.properties[t],o=i=>{let s=i.get(r.name);return r.type===N?er([...w(s||"#eee")]):typeof s=="string"?he(s):typeof s=="boolean"?s?1:0:s};e[`prop_${r.name}`]={size:St(r.type),callback:o}}return e}export{F as a,oe as b,tr as c,rr as d,nr as e,ir as f,Y as g,j as h,X as i,ct as j,ae as k,B as l,H as m,gt as n,At as o,Ut as p,Lt as q,L as r,Ht as s,En as t,k as u,Vt as v,he as w,Kt as x,ue as y,Un as z,kt as A,Zt as B,qt as C,Jt as D,Sn as E,Dn as F,St as G,vt as H,Nn as I,Fn as J,Bn as K};
