import{a as G,b as X}from"./chunk-SW67MXF2.js";import{Yb as W,a as H,db as U,k as Y,l as z,pb as Q,q as J,s as v,u as j,ub as R,z as A}from"./chunk-IV3CZHWS.js";import{B as b,C as T,D as I,g as V,z as M}from"./chunk-L76X3E7P.js";import{G as N,b as P,c as w,ca as q,da as O,j as B,ka as D}from"./chunk-WEL5MCWD.js";var L={SNAP:"snap",UNSNAP:"unsnap"},C=class extends J{constructor(e,t){super(e),this.vertex=t.vertex,this.vertexPixel=t.vertexPixel,this.feature=t.feature,this.segment=t.segment}};var $={Circle(r,e){let t=r,n=M();n&&(t=t.clone().transform(n,e));let s=Q(t);return n&&s.transform(e,n),$.Polygon(s)},GeometryCollection(r,e){let t=[],n=r.getGeometriesArray();for(let s=0;s<n.length;++s){let i=this[n[s].getType()];i&&t.push(i(n[s],e))}return t.flat()},LineString(r){let e=[],t=r.getFlatCoordinates(),n=r.getStride();for(let s=0,i=t.length-n;s<i;s+=n)e.push([t.slice(s,s+2),t.slice(s+n,s+n+2)]);return e},MultiLineString(r){let e=[],t=r.getFlatCoordinates(),n=r.getStride(),s=r.getEnds(),i=0;for(let c=0,u=s.length;c<u;++c){let a=s[c];for(let o=i,h=a-n;o<h;o+=n)e.push([t.slice(o,o+2),t.slice(o+n,o+n+2)]);i=a}return e},MultiPoint(r){let e=[],t=r.getFlatCoordinates(),n=r.getStride();for(let s=0,i=t.length;s<i;s+=n)e.push([t.slice(s,s+2)]);return e},MultiPolygon(r){let e=[],t=r.getFlatCoordinates(),n=r.getStride(),s=r.getEndss(),i=0;for(let c=0,u=s.length;c<u;++c){let a=s[c];for(let o=0,h=a.length;o<h;++o){let E=a[o];for(let d=i,m=E-n;d<m;d+=n)e.push([t.slice(d,d+2),t.slice(d+n,d+n+2)]);i=E}}return e},Point(r){return[[r.getFlatCoordinates().slice(0,2)]]},Polygon(r){let e=[],t=r.getFlatCoordinates(),n=r.getStride(),s=r.getEnds(),i=0;for(let c=0,u=s.length;c<u;++c){let a=s[c];for(let o=i,h=a-n;o<h;o+=n)e.push([t.slice(o,o+2),t.slice(o+n,o+n+2)]);i=a}return e}};function Z(r){return r.feature?r.feature:r.element?r.element:null}var K=[],x=[],S=[],k=class extends W{constructor(e){e=e||{},super({handleDownEvent:Y,stopDown:z}),this.on,this.once,this.un,this.source_=e.source?e.source:null,this.vertex_=e.vertex!==void 0?e.vertex:!0,this.edge_=e.edge!==void 0?e.edge:!0,this.intersection_=e.intersection!==void 0?e.intersection:!1,this.features_=e.features?e.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.rBush_=new X,this.snapped_=null,this.segmenters_=Object.assign({},$,e.segmenters)}addFeature(e,t){t=t!==void 0?t:!0;let n=A(e),s=e.getGeometry();if(s){let i=this.segmenters_[s.getType()];if(i){this.indexedFeaturesExtents_[n]=s.getExtent(B());let c=i.call(this.segmenters_,s,this.getMap().getView().getProjection()),u=c.length;for(let a=0;a<u;++a){let o=c[a];x[a]=P(o),S[a]={feature:e,segment:o}}if(this.intersection_)for(let a=0,o=c.length;a<o;++a){let h=c[a];if(h.length===1)continue;let E=x[a];for(let m=0,y=a-1;m<y;++m){let f=c[m];if(!N(E,x[m]))continue;let g=U(h,f);if(!g)continue;let l=[g];x[u]=P(l),S[u++]={feature:e,intersectionFeature:e,segment:l}}let d=this.rBush_.getInExtent(x[a]);for(let m=0,y=d.length;m<y;++m){let f=d[m].segment;if(f.length===1)continue;let g=U(h,f);if(!g)continue;let l=[g];x[u]=P(l),S[u++]={feature:e,intersectionFeature:d[m].feature,segment:l}}}u===1?this.rBush_.insert(x[0],S[0]):(x.length=u,S.length=u,this.rBush_.load(x,S))}}t&&(this.featureChangeListenerKeys_[n]&&j(this.featureChangeListenerKeys_[n]),this.featureChangeListenerKeys_[n]=v(e,H.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e}areSnapDataEqual_(e,t){return e.segment===t.segment&&e.feature===t.feature}handleEvent(e){let t=this.snapTo(e.pixel,e.coordinate,e.map);return t?(e.coordinate=t.vertex.slice(0,2),e.pixel=t.vertexPixel,this.snapped_&&!this.areSnapDataEqual_(this.snapped_,t)&&this.dispatchEvent(new C(L.UNSNAP,this.snapped_)),this.snapped_={vertex:e.coordinate,vertexPixel:e.pixel,feature:t.feature,segment:t.segment},this.dispatchEvent(new C(L.SNAP,this.snapped_))):this.snapped_&&(this.dispatchEvent(new C(L.UNSNAP,this.snapped_)),this.snapped_=null),super.handleEvent(e)}handleFeatureAdd_(e){let t=Z(e);t&&this.addFeature(t)}handleFeatureRemove_(e){let t=Z(e);t&&(this.removeFeature(t),delete this.pendingFeatures_[A(t)])}handleFeatureChange_(e){let t=e.target;this.handlingDownUpSequence?this.pendingFeatures_[A(t)]=t:this.updateFeature_(t)}handleUpEvent(e){let t=Object.values(this.pendingFeatures_);if(t.length){for(let n of t)this.updateFeature_(n);V(this.pendingFeatures_)}return!1}removeFeature(e,t){let n=t!==void 0?t:!0,s=A(e),i=this.indexedFeaturesExtents_[s];if(i){let c=this.rBush_;c.getInExtent(i).forEach(u=>{(e===u.feature||e===u.intersectionFeature)&&c.remove(u)})}n&&(j(this.featureChangeListenerKeys_[s]),delete this.featureChangeListenerKeys_[s])}setMap(e){let t=this.getMap(),n=this.featuresListenerKeys_,s=this.getFeatures_();if(Array.isArray(s)||(s=s.getArray()),t&&(n.forEach(j),n.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(j),this.featureChangeListenerKeys_={}),super.setMap(e),e){this.features_?n.push(v(this.features_,R.ADD,this.handleFeatureAdd_,this),v(this.features_,R.REMOVE,this.handleFeatureRemove_,this)):this.source_&&n.push(v(this.source_,G.ADDFEATURE,this.handleFeatureAdd_,this),v(this.source_,G.REMOVEFEATURE,this.handleFeatureRemove_,this));for(let i of s)this.addFeature(i)}}snapTo(e,t,n){let s=n.getView().getProjection(),i=T(t,s),c=I(w(P([i]),n.getView().getResolution()*this.pixelTolerance_),s),u=this.rBush_.getInExtent(c),a=u.length;if(a===0)return null;let o,h=1/0,E,d=null,m=this.pixelTolerance_*this.pixelTolerance_,y=()=>{if(!o)return null;let f=n.getPixelFromCoordinate(o);return D(e,f)>m?null:{vertex:o,vertexPixel:[Math.round(f[0]),Math.round(f[1])],feature:E,segment:d}};if(this.vertex_||this.intersection_){for(let g=0;g<a;++g){let l=u[g];if(l.feature.getGeometry().getType()!=="Circle")for(let _ of l.segment){let p=T(_,s),F=D(i,p);F<h&&(this.intersection_&&l.intersectionFeature||this.vertex_&&!l.intersectionFeature)&&(o=_,h=F,E=l.feature)}}let f=y();if(f)return f}if(this.edge_){for(let g=0;g<a;++g){let l=null,_=u[g];if(_.feature.getGeometry().getType()==="Circle"){let p=_.feature.getGeometry(),F=M();F&&(p=p.clone().transform(F,s)),l=q(i,p)}else{let[p,F]=_.segment;F&&(K[0]=T(p,s),K[1]=T(F,s),l=O(i,K))}if(l){let p=D(i,l);p<h&&(o=b(l,s),d=_.feature.getGeometry().getType()==="Circle"?null:_.segment,h=p,E=_.feature)}}let f=y();if(f)return f}return null}updateFeature_(e){this.removeFeature(e,!1),this.addFeature(e,!1)}},_e=k;export{_e as a};
