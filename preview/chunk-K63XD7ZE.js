import{b as z,c as L}from"./chunk-OBVASALZ.js";import{b as X}from"./chunk-J2JCOS6A.js";import{c as W}from"./chunk-2PLHBFQC.js";import{b as y,m as U}from"./chunk-L76X3E7P.js";import{C as S}from"./chunk-WEL5MCWD.js";var q={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},G={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function H(i,e){if(!e.length)return i;let o=new URL(i,"file:/");if(o.pathname.split("/").includes("collections"))return y('The "collections" query parameter cannot be added to collection endpoints'),i;let n=e.map(l=>encodeURIComponent(l)).join(",");o.searchParams.append("collections",n);let r=i.split("?")[0],a=decodeURIComponent(o.searchParams.toString());return`${r}?${a}`}function J(i,e,o){let n,r;for(let a=0;a<i.length;++a){let l=i[a];if(l.rel==="item"){if(l.type===e){n=l.href;break}(q[l.type]||!r&&l.type.startsWith("image/"))&&(r=l.href)}}if(!n)if(r)n=r;else throw new Error('Could not find "item" link');return o&&(n=H(n,o)),n}function V(i,e,o,n){let r,a,l={};for(let p=0;p<i.length;++p){let c=i[p];if(l[c.type]=c.href,c.rel==="item"){if(c.type===e){r=c.href;break}G[c.type]&&(a=c.href)}}if(!r&&o)for(let p=0;p<o.length;++p){let c=o[p];if(l[c]){r=l[c];break}}if(!r)if(a)r=a;else throw new Error('Could not find "item" link');return n&&(r=H(r,n)),r}function v(i,e,o,n){let r=i.projection;if(!r&&(typeof e.crs=="string"?r=U(e.crs):"uri"in e.crs&&(r=U(e.crs.uri)),!r))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);let a=e.orderedAxes,p=!(a?a.slice(0,2).map(t=>t.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):r.getAxisOrientation()).startsWith("en"),c=e.tileMatrices,b={};for(let t=0;t<c.length;++t){let f=c[t];b[f.id]=f}let j={},w=[];if(n)for(let t=0;t<n.length;++t){let f=n[t],s=f.tileMatrix;w.push(s),j[s]=f}else for(let t=0;t<c.length;++t){let f=c[t].id;w.push(f)}let x=w.length,h=new Array(x),A=new Array(x),F=new Array(x),P=new Array(x),k=[-1/0,-1/0,1/0,1/0];for(let t=0;t<x;++t){let f=w[t],s=b[f],g=s.pointOfOrigin;p?h[t]=[g[1],g[0]]:h[t]=g,A[t]=s.cellSize,F[t]=[s.matrixWidth,s.matrixHeight],P[t]=[s.tileWidth,s.tileHeight];let d=j[f];if(d){let T=s.cellSize*s.tileWidth,m=h[t][0]+d.minTileCol*T,E=h[t][0]+(d.maxTileCol+1)*T,u=s.cellSize*s.tileHeight,R=s.cornerOfOrigin==="bottomLeft",O,C;R?(O=h[t][1]+d.minTileRow*u,C=h[t][1]+(d.maxTileRow+1)*u):(O=h[t][1]-(d.maxTileRow+1)*u,C=h[t][1]-d.minTileRow*u),S(k,[m,O,E,C],k)}}let D=new W({origins:h,resolutions:A,sizes:F,tileSizes:P,extent:n?k:void 0}),N=i.context,Y=i.url;function $(t,f,s){if(!t)return;let g=w[t[0]],d=b[g],T=d.cornerOfOrigin==="bottomLeft",m={tileMatrix:g,tileCol:t[1],tileRow:T?-t[2]-1:t[2]};if(n){let u=j[d.id];if(m.tileCol<u.minTileCol||m.tileCol>u.maxTileCol||m.tileRow<u.minTileRow||m.tileRow>u.maxTileRow)return}Object.assign(m,{z:m.tileMatrix,x:m.tileCol,y:m.tileRow},N);let E=o.replace(/\{(\w+?)\}/g,function(u,R){return m[R]});return L(Y,E)}return{grid:D,projection:r,urlTemplate:o,urlFunction:$}}function I(i,e){let o=e.tileMatrixSetLimits,n;if(e.dataType==="map")n=J(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")n=V(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return v(i,e.tileMatrixSet,n,o);let r=e.links.find(p=>p.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!r)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");let a=r.href,l=L(i.url,a);return z(l).then(function(p){return v(i,p,n,o)})}function _(i){return z(i.url).then(function(e){return I(i,e)})}var M=class extends X{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});let o={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};_(o).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){y(e),this.setState("error")}},oe=M;export{_ as a,oe as b};
