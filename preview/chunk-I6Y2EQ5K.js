import{p as c,r as R}from"./chunk-VAGGBZ74.js";import{B as S,K as g,Vc as K,a as D,h as G,k as L,m as O,q as b,s as y,u as F,w as I,wb as X,x as w,z as h}from"./chunk-6GTONTRM.js";import{h as m}from"./chunk-OAKYQQNU.js";import{N as U,g as v,k as T,o as E}from"./chunk-GF377ULF.js";function Y(x,e){return[[-1/0,-1/0,1/0,1/0]]}var p=class{constructor(e){this.rbush_=new X(e),this.items_={}}insert(e,t){let r={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(r),this.items_[h(t)]=r}load(e,t){let r=new Array(t.length);for(let s=0,i=t.length;s<i;s++){let n=e[s],a=t[s],o={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3],value:a};r[s]=o,this.items_[h(a)]=o}this.rbush_.load(r)}remove(e){let t=h(e),r=this.items_[t];return delete this.items_[t],this.rbush_.remove(r)!==null}update(e,t){let r=this.items_[h(t)],s=[r.minX,r.minY,r.maxX,r.maxY];E(s,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){let t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(s){return s.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let r;for(let s=0,i=e.length;s<i;s++)if(r=t(e[s]),r)return r;return r}isEmpty(){return m(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){let t=this.rbush_.toJSON();return T(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(let t in e.items_)this.items_[t]=e.items_[t]}},C=p;var u={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};var l=class extends b{constructor(e,t,r){super(e),this.feature=t,this.features=r}},A=class extends K{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=O,this.format_=e.format||null,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(g(this.format_,"`format` must be set when `url` is set"),this.loader_=R(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:Y;let t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new C:null,this.loadedExtentsRtree_=new C,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let r,s;Array.isArray(e.features)?s=e.features:e.features&&(r=e.features,s=r.getArray()),!t&&r===void 0&&(r=new S(s)),s!==void 0&&this.addFeaturesInternal(s),r!==void 0&&this.bindFeaturesCollection_(r)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){let t=h(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);let r=e.getGeometry();if(r){let s=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(s,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new l(u.ADDFEATURE,e))}setupChangeEvents_(e,t){t instanceof c||(this.featureChangeKeys_[e]=[y(t,D.CHANGE,this.handleFeatureChange_,this),y(t,w.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let r=!0;if(t.getId()!==void 0){let s=String(t.getId());if(!(s in this.idIndex_))this.idIndex_[s]=t;else if(t instanceof c){let i=this.idIndex_[s];i instanceof c?Array.isArray(i)?i.push(t):this.idIndex_[s]=[i,t]:r=!1}else r=!1}return r&&(g(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),r}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){let t=[],r=[],s=[];for(let i=0,n=e.length;i<n;i++){let a=e[i],o=h(a);this.addToIndex_(o,a)&&r.push(a)}for(let i=0,n=r.length;i<n;i++){let a=r[i],o=h(a);this.setupChangeEvents_(o,a);let d=a.getGeometry();if(d){let f=d.getExtent();t.push(f),s.push(a)}else this.nullGeometryFeatures_[o]=a}if(this.featuresRtree_&&this.featuresRtree_.load(t,s),this.hasListener(u.ADDFEATURE))for(let i=0,n=r.length;i<n;i++)this.dispatchEvent(new l(u.ADDFEATURE,r[i]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(u.ADDFEATURE,function(r){t||(t=!0,e.push(r.feature),t=!1)}),this.addEventListener(u.REMOVEFEATURE,function(r){t||(t=!0,e.remove(r.feature),t=!1)}),e.addEventListener(I.ADD,r=>{t||(t=!0,this.addFeature(r.element),t=!1)}),e.addEventListener(I.REMOVE,r=>{t||(t=!0,this.removeFeature(r.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(let r in this.featureChangeKeys_)this.featureChangeKeys_[r].forEach(F);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(r=>{this.removeFeatureInternal(r)});for(let r in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[r])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};let t=new l(u.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){let r=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(r,function(s){let i=s.getGeometry();if(i instanceof c||i.intersectsCoordinate(e))return t(s)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(r){let s=r.getGeometry();if(s instanceof c||s.intersectsExtent(e)){let i=t(r);if(i)return i}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),m(this.nullGeometryFeatures_)||G(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){let t=[];return this.forEachFeatureAtCoordinateDirect(e,function(r){t.push(r)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);let s=U(e,t);return[].concat(...s.map(i=>this.featuresRtree_.getInExtent(i)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){let r=e[0],s=e[1],i=null,n=[NaN,NaN],a=1/0,o=[-1/0,-1/0,1/0,1/0];return t=t||L,this.featuresRtree_.forEachInExtent(o,function(d){if(t(d)){let f=d.getGeometry(),N=a;if(a=f instanceof c?0:f.closestPointXY(r,s,n,a),a<N){i=d;let _=Math.sqrt(a);o[0]=r-_,o[1]=s-_,o[2]=r+_,o[3]=s+_}}}),i}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){let t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){let t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){let t=e.target,r=h(t),s=t.getGeometry();if(!s)r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[r]=t);else{let n=s.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(n,t)):this.featuresRtree_&&this.featuresRtree_.update(n,t)}let i=t.getId();if(i!==void 0){let n=i.toString();this.idIndex_[n]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[n]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[r]=t;this.changed(),this.dispatchEvent(new l(u.CHANGEFEATURE,t))}hasFeature(e){let t=e.getId();return t!==void 0?t in this.idIndex_:h(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&m(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,r){let s=this.loadedExtentsRtree_,i=this.strategy_(e,t,r);for(let n=0,a=i.length;n<a;++n){let o=i[n];s.forEachInExtent(o,function(f){return v(f.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new l(u.FEATURESLOADSTART)),this.loader_.call(this,o,t,r,f=>{--this.loadingExtentsCount_,this.dispatchEvent(new l(u.FEATURESLOADEND,void 0,f))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new l(u.FEATURESLOADERROR))}),s.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){let t=this.loadedExtentsRtree_,r=t.forEachInExtent(e,function(s){if(E(s.extent,e))return s});r&&t.remove(r)}removeFeatures(e){let t=!1;for(let r=0,s=e.length;r<s;++r)t=this.removeFeatureInternal(e[r])||t;t&&this.changed()}removeFeature(e){if(!e)return;this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){let t=h(e);if(!(t in this.uidIndex_))return!1;t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.featureChangeKeys_[t]?.forEach(F),delete this.featureChangeKeys_[t];let s=e.getId();if(s!==void 0){let i=s.toString(),n=this.idIndex_[i];n===e?delete this.idIndex_[i]:Array.isArray(n)&&(n.splice(n.indexOf(e),1),n.length===1&&(this.idIndex_[i]=n[0]))}return delete this.uidIndex_[t],this.hasListener(u.REMOVEFEATURE)&&this.dispatchEvent(new l(u.REMOVEFEATURE,e)),!0}removeFromIdIndex_(e){for(let t in this.idIndex_)if(this.idIndex_[t]===e){delete this.idIndex_[t];break}}setLoader(e){this.loader_=e}setUrl(e){g(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(R(e,this.format_))}setOverlaps(e){this.overlaps_=e,this.changed()}},_e=A;export{u as a,C as b,_e as c};
